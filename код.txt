–í —Ñ–∞–π–ª–µ –∫–æ–¥ –≤—Å—Ç–∞–≤–∫–∞ –∏–∑ 3 —Ñ–∞–π–ª–æ–≤. –ö–æ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —á—Ç–æ-—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø–∏—à–∏ –≤ –∫–∞–∫–æ–º —Ñ–∞–π–ª–µ –∏ –ø–µ—Ä–µ–¥ –∫–∞–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π (–≤ –∫–∞–∫–æ–º –º–µ—Å—Ç–µ —á—Ç–æ–± —è –Ω–∞—à–µ–ª, –∞ –Ω–µ ‚Ññ —Å—Ç—Ä–æ–∫–∏), –∫–∞–∫–æ–π –Ω–æ–≤—ã–π –∫–æ–¥ –Ω–∞–¥–æ –≤—Å—Ç–∞–≤–∏—Ç—å. –ï—Å–ª–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —á—Ç–æ-—Ç–æ —É–¥–∞–ª–∏—Ç—å, —Ç–æ –¥–≤–∞–∂–¥—ã –ø—Ä–æ–¥—É–º–∞–π –ª–æ–≥–∏–∫—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞, –≤–µ–¥—å –∫–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω —Ç–æ–±–æ–π –≤ –¥—Ä—É–≥–æ–º —á–∞—Ç–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —É–¥–∞–ª—è—Ç—å –ª–∏—à—å –±—ã —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–ª–æ—Å—å.
–≠—Ç–æ—Ç –∫–æ–¥ –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –º–æ–∏–º–∏ –¥–µ–Ω—å–≥–∞–º–∏! –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ–≤–µ—Ä—è–π —Å–µ–±—è —Å–∞–º.

–ê–ù–ê–õ–ò–ó–ê –ö–û–î–ê –ú–¢5 SIDEZ –°–ò–°–¢–ï–ú–´:

–ö–û–ù–¢–ï–ö–°–¢: –†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏ –¥–ª—è –ú–¢5 –∏–∑ 3-—Ö –º–æ–¥—É–ª–µ–π:
1. CoreLib.mqh - –æ–±—â–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (—Å—Ç—Ä—É–∫—Ç—É—Ä—ã, —É—Ç–∏–ª–∏—Ç—ã)
2. RiskManager.mq5 - –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä —Ä–∏—Å–∫–æ–≤
3. PositionManager.mq5 - –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–∑–∏—Ü–∏–π —Å —Ç—Ä–µ–π–ª–∏–Ω–≥–æ–º

–¶–ï–õ–¨ –ê–ù–ê–õ–ò–ó–ê: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

–ö–õ–Æ–ß–ï–í–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:

1. ARCHITECTURE:
- RiskManager - –ì–õ–ê–í–ù–´–ô –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä. –í—Å–µ —Ä–µ—à–µ–Ω–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –æ—Ç –Ω–µ–≥–æ
- PositionManager - –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å, —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —É RiskManager
- CoreLib - –æ–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π

2. RISK MANAGER –î–û–õ–ñ–ï–ù:
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å PnL (–¥–Ω–µ–≤–Ω–æ–π/–Ω–µ–¥–µ–ª—å–Ω—ã–π) –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤ (TP/SL)
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫—É —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
- –ü—Ä–∏–Ω–∏–º–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ —Å–∏–≥–Ω–∞–ª—ã (Telegram) - –∑–∞–≥–æ—Ç–æ–≤–∫–∞ –≤ –∫–æ–¥–µ

3. POSITION MANAGER –î–û–õ–ñ–ï–ù:
- –£–ø—Ä–∞–≤–ª—è—Ç—å —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏ (—Ç—Ä–µ–π–ª–∏–Ω–≥, —á–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ)
- –ü–†–û–í–ï–†–Ø–¢–¨ –†–ê–ó–†–ï–®–ï–ù–ò–ï –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏
- –ó–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏, –µ—Å–ª–∏ RiskManager –∑–∞–ø—Ä–µ—Ç–∏–ª —Ç–æ—Ä–≥–æ–≤–ª—é

4. –¢–û–†–ì–û–í–´–ô –®–õ–Æ–ó (–í–°–¢–†–û–ï–ù –í RISKMANAGER):
- –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –î–û –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ - –æ—Ä–¥–µ—Ä –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

5. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò:
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: GLOBAL_TRADE_BLOCK
- –§–∞–π–ª—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ OnTrade() —Å–æ–±—ã—Ç–∏—è

6. –û–ñ–ò–î–ê–ï–ú–´–ï –û–®–ò–ë–ö–ò –î–õ–Ø –ü–û–ò–°–ö–ê:
- –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ MQL5
- –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö PnL
- –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏/—Ä–µ—Å—É—Ä—Å–æ–≤
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

//+------------------------------------------------------------------+
//|                                                    SIDEZ_RiskManager.mq5 |
//|                              Copyright ¬© 2025, SIDEZ LLC          |
//|                                             https://www.sidez.ru  |
//+------------------------------------------------------------------+
#property copyright "Copyright ¬© 2025, SIDEZ LLC"
#property link "https://www.sidez.ru"
#property version "1.0"
#property description "–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Ä–∏—Å–∫–æ–≤ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ—Ä—Ç—Ñ–µ–ª—è"
#property strict

// –ü–æ–º–µ—á–∞–µ–º –¥–ª—è CoreLib, —á—Ç–æ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω—ã –∫–∞–∫ input-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã
#define ENABLE_CORRELATION_CHECK_DEFINED
#define SIGNAL_COMMAND_PREFIX_DEFINED

//--- –í–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
#include "..\Include\SIDEZ_CoreLib.mqh"

//+------------------------------------------------------------------+
//|                         –í–•–û–î–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´                        |
//+------------------------------------------------------------------+
input group "=== –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ RiskManager ===" input string RiskManagerName = "SIDEZ RiskManager"; // –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–≤–µ—Ç–Ω–∏–∫–∞
input int CheckInterval = 1;                                                                             // –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ç–∏–∫–∏)
input bool EnableAutoReset = true;                                                                       // –ê–≤—Ç–æ—Å–±—Ä–æ—Å –≤ –Ω–∞—á–∞–ª–µ –¥–Ω—è/–Ω–µ–¥–µ–ª–∏
input string DailyResetTime = "01:01";                                                                   // –í—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ –¥–Ω–µ–≤–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤
input string WeeklyResetTime = "Mon 01:01";                                                              // –í—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ –Ω–µ–¥–µ–ª—å–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤

input group "=== –î–Ω–µ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã —Ä–∏—Å–∫–∞ ===" input double DailyTakeProfit = 250.0; // –î–Ω–µ–≤–Ω–æ–π TP ($)
input double DailyStopLoss = -150.0;                                             // –î–Ω–µ–≤–Ω–æ–π SL ($)
input int MaxDailyTrades = 5;                                                    // –ú–∞–∫—Å. –°–î–ï–õ–û–ö –≤ –¥–µ–Ω—å (–≤—Å–µ —Å–¥–µ–ª–∫–∏)
input int MaxSimultaneousPositions = 3;                                          // –ú–∞–∫—Å. –û–î–ù–û–í–†–ï–ú–ï–ù–ù–´–• –ø–æ–∑–∏—Ü–∏–π

input group "=== –ù–µ–¥–µ–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã —Ä–∏—Å–∫–∞ ===" input double WeeklyTakeProfit = 1250.0; // –ù–µ–¥–µ–ª—å–Ω—ã–π TP ($)
input double WeeklyStopLoss = -750.0;                                                // –ù–µ–¥–µ–ª—å–Ω—ã–π SL ($)
input int MaxWeeklyTrades = 25;                                                      // –ú–∞–∫—Å. –°–î–ï–õ–û–ö –≤ –Ω–µ–¥–µ–ª—é
input int MaxSimultaneousPositionsWeekly = 10;                                       // –ú–∞–∫—Å. –û–î–ù–û–í–†–ï–ú–ï–ù–ù–´–• –ø–æ–∑–∏—Ü–∏–π (–Ω–µ–¥–µ–ª—è)

input group "=== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–º –Ω–∞ —Å–¥–µ–ª–∫—É ===" input double MaxRiskPerTrade = 2; // –ú–∞–∫—Å. —Ä–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (% –æ—Ç –±–∞–ª–∞–Ω—Å–∞)
input bool UseDynamicRisk = true;                                                   // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫
input double MinRiskPercent = 0.5;                                                  // –ú–∏–Ω. —Ä–∏—Å–∫ –ø–æ—Å–ª–µ —É–±—ã—Ç–∫–æ–≤ (%)
input double MaxRiskPercent = 3.0;                                                  // –ú–∞–∫—Å. —Ä–∏—Å–∫ –ø–æ—Å–ª–µ –ø—Ä–∏–±—ã–ª–µ–π (%)
input int LossStreakToReduce = 3;                                                   // –°–µ—Ä–∏—è —É–±—ã—Ç–∫–æ–≤ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∏—Å–∫–∞
input int ProfitStreakToIncrease = 3;                                               // –°–µ—Ä–∏—è –ø—Ä–∏–±—ã–ª–µ–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ä–∏—Å–∫–∞

input group "=== –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫ ===" input bool EnableCorrelationCheck = true; // –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
input string CorrelationPairs = "FUTMESZ25:FUTMGCG26, FUTMESZ25:FUTCLZ25";          // –ü–∞—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é

input group "=== –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ ===" input bool CloseAllAtSessionEnd = true; // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –≤—Å—ë –≤ –∫–æ–Ω—Ü–µ —Å–µ—Å—Å–∏–∏
input string TradingSessionEnd = "23:45";                                             // –û–∫–æ–Ω—á–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
input bool CloseAllOnFriday = true;                                                   // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –≤—Å—ë –≤ –ø—è—Ç–Ω–∏—Ü—É
input string FridayCloseTime = "23:45";                                               // –í—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤ –ø—è—Ç–Ω–∏—Ü—É

input group "=== –í–Ω–µ—à–Ω–∏–µ —Å–∏–≥–Ω–∞–ª—ã (Telegram) ===" input bool EnableExternalSignals = true; // –ü—Ä–∏–Ω–∏–º–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ —Å–∏–≥–Ω–∞–ª—ã
input string SignalCommandPrefix = "/trade";                                              // –ü—Ä–µ—Ñ–∏–∫—Å –∫–æ–º–∞–Ω–¥

input group "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —à–ª—é–∑–∞ ===" input bool RM_EnableTradeGateway = true; // –í–∫–ª—é—á–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–π —à–ª—é–∑
input string RM_GatewayAllowedMagics = "10001001,20002002,50005000";                     // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –º–∞–≥–∏–∫–∏

input group "=== –ö–æ–Ω—Ç—Ä–æ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –¥–æ—Å—Ç—É–ø–∞ ===" input bool UseWhiteList = true; // –í–ö–õ–Æ–ß–ò–¢–¨ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
input string AllowedInstruments = "XAUUSD,FUTMESH26,FUTMGCG26,EURUSD,GBPUSD";         // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
input bool BlockOtherExperts = false;                                                 // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–æ–≤–µ—Ç–Ω–∏–∫–∏
input bool BlockManualTradingOnLimit = true;                                          // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä—É—á–Ω—É—é —Ç–æ—Ä–≥–æ–≤–ª—é –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤

//+------------------------------------------------------------------+
//|                    –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï                        |
//+------------------------------------------------------------------+
int g_TickCounter = 0;
datetime g_LastCheckTime = 0;
bool g_IsInitialized = false;
string g_CurrentSymbol = "";
double g_LastBalance = 0;
double g_LastEquity = 0;
bool g_ForceCloseAll = false;          // –§–ª–∞–≥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
datetime g_LastTradeExecutionTime = 0; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Å–¥–µ–ª–∫–∏

//+------------------------------------------------------------------+
//| –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ (–≤—Å–µ—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)     |
//+------------------------------------------------------------------+
int GetDailyTradesCount()
{
    int count = 0;
    datetime todayStart = iTime(_Symbol, PERIOD_D1, 0);

    int totalDeals = HistoryDealsTotal();

    for (int i = 0; i < totalDeals; i++)
    {
        ulong ticket = HistoryDealGetTicket(i);
        if (ticket > 0)
        {
            datetime dealTime = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME);
            long dealType = HistoryDealGetInteger(ticket, DEAL_TYPE);

            if ((dealType == DEAL_TYPE_BUY || dealType == DEAL_TYPE_SELL) &&
                dealTime >= todayStart &&
                dealTime > g_GlobalState.lastDailyReset) // –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞
            {
                count++;
            }
        }
    }

    return count;
}

//+------------------------------------------------------------------+
//| –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–¥–µ–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫                            |
//+------------------------------------------------------------------+
int GetWeeklyTradesCount()
{
    int count = 0;
    datetime weekStart = GetWeekStartTime();

    int totalDeals = HistoryDealsTotal();

    for (int i = 0; i < totalDeals; i++)
    {
        ulong ticket = HistoryDealGetTicket(i);
        if (ticket > 0)
        {
            datetime dealTime = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME);
            long dealType = HistoryDealGetInteger(ticket, DEAL_TYPE);

            if ((dealType == DEAL_TYPE_BUY || dealType == DEAL_TYPE_SELL) &&
                dealTime >= weekStart &&
                dealTime > g_GlobalState.lastWeeklyReset) // –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞
            {
                count++;
            }
        }
    }

    return count;
}

//+------------------------------------------------------------------+
//| –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏                                  |
//+------------------------------------------------------------------+
datetime GetWeekStartTime()
{
    MqlDateTime dt;
    TimeCurrent(dt);

    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏
    int daysToMonday = (dt.day_of_week == 0) ? 6 : (dt.day_of_week - 1);
    dt.day -= daysToMonday;
    dt.hour = 0;
    dt.min = 0;
    dt.sec = 0;

    return StructToTime(dt);
}

//+------------------------------------------------------------------+
//| –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π                             |
//+------------------------------------------------------------------+
int GetDailyPositionsCount()
{
    int count = 0;
    datetime todayStart = iTime(_Symbol, PERIOD_D1, 0);

    int totalDeals = HistoryDealsTotal();

    for (int i = 0; i < totalDeals; i++)
    {
        ulong ticket = HistoryDealGetTicket(i);
        if (ticket > 0)
        {
            datetime dealTime = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME);
            long dealType = HistoryDealGetInteger(ticket, DEAL_TYPE);

            if ((dealType == DEAL_TYPE_BUY || dealType == DEAL_TYPE_SELL) && dealTime >= todayStart)
            {
                count++;
            }
        }
    }

    return count;
}

//+------------------------------------------------------------------+
//| –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–¥–µ–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π                           |
//+------------------------------------------------------------------+
int GetWeeklyPositionsCount()
{
    int count = 0;
    datetime weekStart = GetWeekStartTime();

    int totalDeals = HistoryDealsTotal();

    for (int i = 0; i < totalDeals; i++)
    {
        ulong ticket = HistoryDealGetTicket(i);
        if (ticket > 0)
        {
            datetime dealTime = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME);
            long dealType = HistoryDealGetInteger(ticket, DEAL_TYPE);

            if ((dealType == DEAL_TYPE_BUY || dealType == DEAL_TYPE_SELL) && dealTime >= weekStart)
            {
                count++;
            }
        }
    }

    return count;
}

//+------------------------------------------------------------------+
//| –ü–æ–ª—É—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∑–∞ –¥–µ–Ω—å |
//+------------------------------------------------------------------+
int GetMaxDailySimultaneousPositions()
{
    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∑–∞ –¥–µ–Ω—å
    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    return PositionsTotal();
}

//+------------------------------------------------------------------+
//| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å–¥–µ–ª–æ–∫ (RiskManager –≤–µ—Ä—Å–∏—è)                    |
//+------------------------------------------------------------------+
void RiskManager_UpdateTradeCountersLocal()
{
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫ –∑–∞ –¥–µ–Ω—å –∏ –Ω–µ–¥–µ–ª—é
    g_GlobalState.dailyTradesCount = GetDailyTradesCount();
    g_GlobalState.weeklyTradesCount = GetWeeklyTradesCount();

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
    g_GlobalState.dailyPositionsCount = PositionsTotal();  // –¢–µ–∫—É—â–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    g_GlobalState.weeklyPositionsCount = PositionsTotal(); // –î–ª—è –Ω–µ–¥–µ–ª–∏ —Ç–æ–∂–µ —Ç–µ–∫—É—â–∏–µ
}

//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
{
    Print("========================================");
    Print(RiskManagerName, " v", CORE_VERSION, " –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");

    // --- –ü–†–ò–û–†–ò–¢–ï–¢–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ê–ö–¢–ò–í–ù–û–ô –ë–õ–û–ö–ò–†–û–í–ö–ò ---
    bool hasActiveLock = IsGlobalTradeLockActive();

    if (hasActiveLock)
    {
        Print("‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –≥–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞!");

        // –î–û–ë–ê–í–õ–Ø–ï–ú: –ª–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        Print("–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ ", TimeToString(TimeCurrent()));

        // –ü–†–û–í–ï–†–Ø–ï–ú, –ù–ï –£–°–¢–ê–†–ï–õ–ê –õ–ò –ë–õ–û–ö–ò–†–û–í–ö–ê
        datetime lockTime = 0;
        string lockMessage = "";
        double reason = 0;
        double dailyPnL = 0;
        double weeklyPnL = 0;

        if (FileIsExist("SIDEZ/TradeLock.bin", FILE_COMMON))
        {
            int handle = FileOpen("SIDEZ/TradeLock.bin", FILE_READ | FILE_BIN | FILE_COMMON);
            if (handle != INVALID_HANDLE)
            {
                lockTime = (datetime)FileReadLong(handle);
                reason = FileReadDouble(handle);
                lockMessage = FileReadString(handle);
                dailyPnL = FileReadDouble(handle);
                weeklyPnL = FileReadDouble(handle);
                FileClose(handle);

                // –î–û–ë–ê–í–õ–Ø–ï–ú: –ø–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥
                Print("–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞–π–¥–µ–Ω–∞: –≤—Ä–µ–º—è=", TimeToString(lockTime),
                      " –ø—Ä–∏—á–∏–Ω–∞=", lockMessage,
                      " dailyPnL=", dailyPnL, " weeklyPnL=", weeklyPnL);

                // –û–ü–†–ï–î–ï–õ–Ø–ï–ú, –£–°–¢–ê–†–ï–õ–ê –õ–ò –ë–õ–û–ö–ò–†–û–í–ö–ê (—Å—Ç–∞—Ä—à–µ –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è)
                datetime startOfToday = iTime(_Symbol, PERIOD_D1, 0);

                // –î–û–ë–ê–í–õ–Ø–ï–ú: –ª–æ–≥ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
                Print("–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞=", TimeToString(lockTime),
                      " vs –Ω–∞—á–∞–ª–æ –¥–Ω—è=", TimeToString(startOfToday));

                if (lockTime < startOfToday)
                {
                    // –ë–õ–û–ö–ò–†–û–í–ö–ê –£–°–¢–ê–†–ï–õ–ê - –°–ù–ò–ú–ê–ï–ú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
                    Print("‚ö† –°–Ω–∏–º–∞–µ–º –£–°–¢–ê–†–ï–í–®–£–Æ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –æ—Ç ", TimeToString(lockTime));
                    Print("–ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±—ã–ª–∞: ", lockMessage);
                    Print("PnL –Ω–∞ –º–æ–º–µ–Ω—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –î–µ–Ω—å=$", dailyPnL, " –ù–µ–¥–µ–ª—è=$", weeklyPnL);

                    RemoveGlobalTradeLock();
                    hasActiveLock = false;

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                    g_GlobalState.dailyTPReached = false;
                    g_GlobalState.dailySLReached = false;
                    g_GlobalState.weeklyTPReached = false;
                    g_GlobalState.weeklySLReached = false;
                    g_GlobalState.allowNewTrades = true;
                    g_GlobalState.blockManualTrading = false;

                    // –î–û–ë–ê–í–õ–Ø–ï–ú: —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤ PnL –Ω–∞ –º–æ–º–µ–Ω—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                    Print("PnL –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–Ω—è—Ç–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –î–µ–Ω—å=$", g_GlobalState.dailyPnLTotal,
                          " –ù–µ–¥–µ–ª—è=$", g_GlobalState.weeklyPnLTotal);

                    Print("‚úÖ –£—Å—Ç–∞—Ä–µ–≤—à–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞. –¢–æ—Ä–≥–æ–≤–ª—è –†–ê–ó–†–ï–®–ï–ù–ê.");

                    // –î–û–ë–ê–í–õ–Ø–ï–ú: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    Core_SaveGlobalState();
                }
                else
                {
                    // –ë–õ–û–ö–ò–†–û–í–ö–ê –ê–ö–¢–£–ê–õ–¨–ù–ê - –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï
                    Print("‚ö† –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç ", TimeToString(lockTime));
                    Print("–ü—Ä–∏—á–∏–Ω–∞: ", lockMessage);
                    Print("PnL –Ω–∞ –º–æ–º–µ–Ω—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –î–µ–Ω—å=$", dailyPnL, " –ù–µ–¥–µ–ª—è=$", weeklyPnL);

                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏
                    if (MathRound(reason) == 1)
                    {
                        g_GlobalState.dailyTPReached = true;
                        Print("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –¥–Ω–µ–≤–Ω–æ–π TP –¥–æ—Å—Ç–∏–≥–Ω—É—Ç");
                    }
                    else if (MathRound(reason) == 2)
                    {
                        g_GlobalState.dailySLReached = true;
                        Print("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –¥–Ω–µ–≤–Ω–æ–π SL –¥–æ—Å—Ç–∏–≥–Ω—É—Ç");
                    }
                    else if (MathRound(reason) == 3)
                    {
                        g_GlobalState.weeklyTPReached = true;
                        Print("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –Ω–µ–¥–µ–ª—å–Ω—ã–π TP –¥–æ—Å—Ç–∏–≥–Ω—É—Ç");
                    }
                    else if (MathRound(reason) == 4)
                    {
                        g_GlobalState.weeklySLReached = true;
                        Print("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –Ω–µ–¥–µ–ª—å–Ω—ã–π SL –¥–æ—Å—Ç–∏–≥–Ω—É—Ç");
                    }
                    else if (MathRound(reason) == 5)
                    {
                        Print("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: —Ä—É—á–Ω–∞—è/—Å–∏—Å—Ç–µ–º–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞");
                    }

                    g_GlobalState.allowNewTrades = false;

                    // –î–û–ë–ê–í–õ–Ø–ï–ú: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ PnL —Å –º–æ–º–µ–Ω—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                    double currentDailyPnL = RiskManager_CalculateTotalPnL(true, true);
                    double currentWeeklyPnL = RiskManager_CalculateTotalPnL(false, true);

                    Print("–¢–µ–∫—É—â–∏–π PnL vs –º–æ–º–µ–Ω—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:",
                          " –î–µ–Ω—å: $", currentDailyPnL, " vs $", dailyPnL,
                          " –ù–µ–¥–µ–ª—è: $", currentWeeklyPnL, " vs $", weeklyPnL);

                    // –î–û–ë–ê–í–õ–Ø–ï–ú: –µ—Å–ª–∏ PnL —É–ª—É—á—à–∏–ª—Å—è, –≤–æ–∑–º–æ–∂–Ω–æ —Å—Ç–æ–∏—Ç —Å–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É?
                    if (currentDailyPnL > dailyPnL && reason == 2) // –ï—Å–ª–∏ –±—ã–ª SL, –Ω–æ —Å–µ–π—á–∞—Å –ª—É—á—à–µ
                    {
                        Print("‚ö† –¢–µ–∫—É—â–∏–π PnL –ª—É—á—à–µ —á–µ–º –Ω–∞ –º–æ–º–µ–Ω—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä–∫–∞...");
                    }

                    // –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å—Ä–∞–∑—É - —ç—Ç–æ —Å–¥–µ–ª–∞–µ—Ç OnTick()
                    // –ù–æ –î–û–ë–ê–í–õ–Ø–ï–ú –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    Print("‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –ê–∫—Ç–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞! –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã –≤ OnTick()");
                }
            }
            else
            {
                Print("‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏!");
                // –ü–æ–ø—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª
                FileDelete("SIDEZ/TradeLock.bin", FILE_COMMON);
                RemoveGlobalTradeLock();
                hasActiveLock = false;
                Print("–£–¥–∞–ª–µ–Ω –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏");
            }
        }
        else
        {
            // –§–∞–π–ª–∞ –Ω–µ—Ç, –Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –µ—Å—Ç—å - –æ—á–∏—â–∞–µ–º
            Print("‚ö† –§–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–∞");

            // –î–û–ë–ê–í–õ–Ø–ï–ú: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            if (g_GlobalState.dailyTPReached || g_GlobalState.dailySLReached ||
                g_GlobalState.weeklyTPReached || g_GlobalState.weeklySLReached)
            {
                Print("‚ö† –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ñ–ª–∞–≥–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏:");
                Print("  dailyTPReached=", g_GlobalState.dailyTPReached);
                Print("  dailySLReached=", g_GlobalState.dailySLReached);
                Print("  weeklyTPReached=", g_GlobalState.weeklyTPReached);
                Print("  weeklySLReached=", g_GlobalState.weeklySLReached);

                // –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á—Ç–æ –¥–µ–ª–∞—Ç—å?
                Print("‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ! –§–ª–∞–≥–∏ –µ—Å—Ç—å, –Ω–æ —Ñ–∞–π–ª–∞ –Ω–µ—Ç.");
            }

            RemoveGlobalTradeLock();
            hasActiveLock = false;

            // –î–û–ë–ê–í–õ–Ø–ï–ú: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
            g_GlobalState.dailyTPReached = false;
            g_GlobalState.dailySLReached = false;
            g_GlobalState.weeklyTPReached = false;
            g_GlobalState.weeklySLReached = false;
            g_GlobalState.allowNewTrades = true;
            g_GlobalState.blockManualTrading = false;

            Print("‚úÖ –û—á–∏—â–µ–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞");
        }

        // –î–û–ë–ê–í–õ–Ø–ï–ú: –∏—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
        if (!hasActiveLock)
        {
            Print("‚úÖ –ò–¢–û–ì: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ù–ï –∞–∫—Ç–∏–≤–Ω–∞. –¢–æ—Ä–≥–æ–≤–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞.");
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å —Å—Ä–∞–∑—É
            UpdateInfoPanel();
        }
        else
        {
            Print("üî¥ –ò–¢–û–ì: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ê–ö–¢–ò–í–ù–ê. –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞.");
            Print("–ü—Ä–∏—á–∏–Ω–∞: ", lockMessage, " (", TimeToString(lockTime), ")");

            // –î–û–ë–ê–í–õ–Ø–ï–ú: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            if (PositionsTotal() > 0)
            {
                Print("üö® –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ...");
                ForceCloseAllPositionsInstantly();
            }
        }
    }
    else
    {
        // –î–û–ë–ê–í–õ–Ø–ï–ú: –ª–æ–≥ –∫–æ–≥–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ—Ç
        Print("‚úÖ –ì–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ù–ï –∞–∫—Ç–∏–≤–Ω–∞. –¢–æ—Ä–≥–æ–≤–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞.");

        // –î–û–ë–ê–í–õ–Ø–ï–ú: –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ñ–ª–∞–≥–∏ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        if (g_GlobalState.dailyTPReached || g_GlobalState.dailySLReached ||
            g_GlobalState.weeklyTPReached || g_GlobalState.weeklySLReached)
        {
            Print("‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ñ–ª–∞–≥–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏!");
            Print("–°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...");

            g_GlobalState.dailyTPReached = false;
            g_GlobalState.dailySLReached = false;
            g_GlobalState.weeklyTPReached = false;
            g_GlobalState.weeklySLReached = false;
            g_GlobalState.allowNewTrades = true;
            g_GlobalState.blockManualTrading = false;

            Core_SaveGlobalState();
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —à–ª—é–∑
    if (RM_EnableTradeGateway)
    {
        g_TradeGateway.SetExpertMagicNumber(MAGIC_RISK_MANAGER);
        g_TradeGateway.SetDeviationInPoints(10);

        // –ü–∞—Ä—Å–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –º–∞–≥–∏–∫–∏
        ParseAllowedMagics(RM_GatewayAllowedMagics, g_AllowedMagicsArray, g_AllowedMagicsCount);

        Print("–¢–æ—Ä–≥–æ–≤—ã–π —à–ª—é–∑ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù");
        Print("–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –º–∞–≥–∏—á–µ—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞: ", RM_GatewayAllowedMagics);
    }

    // --- –°–ê–ú–û–í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–Æ–©–ê–Ø–°–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê ---
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (!Core_LoadGlobalState())
    {
        Print("–°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ");
    }
    else
    {
        // 2. –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ë–õ–û–ö–ò–†–û–í–ö–£ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
        if (g_GlobalState.dailyTPReached || g_GlobalState.dailySLReached ||
            g_GlobalState.weeklyTPReached || g_GlobalState.weeklySLReached)
        {
            Print("–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ì–õ–û–ë–ê–õ–¨–ù–û–ô –ë–õ–û–ö–ò–†–û–í–ö–ò...");

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ª–∏ —É–∂–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
            if (!IsGlobalTradeLockActive())
            {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
                int reason = 0;
                if (g_GlobalState.dailyTPReached)
                    reason = 1;
                else if (g_GlobalState.dailySLReached)
                    reason = 2;
                else if (g_GlobalState.weeklyTPReached)
                    reason = 3;
                else if (g_GlobalState.weeklySLReached)
                    reason = 4;

                SetGlobalTradeLock(reason, "Auto-restored on RiskManager restart");

                // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏—Å—å –ø–æ–∫–∞ RiskManager –±—ã–ª –≤—ã–∫–ª—é—á–µ–Ω)
                ForceCloseAllPositionsInstantly();
            }
            else
            {
                Print("–ì–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞");
            }
        }
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–û–†–†–ï–õ–Ø–¶–ò–û–ù–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê ---
    if (EnableCorrelationCheck)
    {
        // –ü–∞—Ä—Å–∏–Ω–≥ CorrelationPairs –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        string pairs[];
        int count = StringSplit(CorrelationPairs, ',', pairs);
        for (int i = 0; i < count; i++)
        {
            Print("–ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –ø–∞—Ä–∞: ", pairs[i]);
            // TODO: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞—Ä
        }
    }

    //--- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏
    g_Trade.SetExpertMagicNumber(MAGIC_RISK_MANAGER);
    g_Trade.SetDeviationInPoints(10);
    //--- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –∏–∑ –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    g_GlobalState.dailyTradesLimit = MaxDailyTrades;
    g_GlobalState.weeklyTradesLimit = MaxWeeklyTrades;
    g_GlobalState.maxSimultaneousPositionsDaily = MaxSimultaneousPositions;
    g_GlobalState.maxSimultaneousPositionsWeekly = MaxSimultaneousPositionsWeekly;
    g_GlobalState.maxRiskPerTrade = MaxRiskPerTrade;
    g_GlobalState.dailyTakeProfit = DailyTakeProfit;
    g_GlobalState.dailyStopLoss = DailyStopLoss;
    g_GlobalState.weeklyTakeProfit = WeeklyTakeProfit;
    g_GlobalState.weeklyStopLoss = WeeklyStopLoss;

    //--- –ù–ê–°–¢–†–û–ô–ö–ê –ë–ï–õ–û–ì–û –°–ü–ò–°–ö–ê –ò –ö–û–ù–¢–†–û–õ–Ø –î–û–°–¢–£–ü–ê
    g_GlobalState.useWhiteList = UseWhiteList;
    g_GlobalState.blockManualTrading = false; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞
    g_GlobalState.blockOtherExperts = BlockOtherExperts;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ input –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
    if (UseWhiteList && AllowedInstruments != "")
    {
        Print("=== –ó–ê–ì–†–£–ó–ö–ê –ë–ï–õ–û–ì–û –°–ü–ò–°–ö–ê ===");
        Print("–ü–∞—Ä–∞–º–µ—Ç—Ä AllowedInstruments: '", AllowedInstruments, "'");

        // –û–ß–ò–©–ê–ï–ú –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –°–ü–ò–°–û–ö
        for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
        {
            ZeroMemory(g_GlobalState.allowedInstruments[i]);
        }
        g_GlobalState.allowedInstrumentsCount = 0;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫
        LoadWhiteListFromString(AllowedInstruments);

        // –ü–†–û–í–ï–†–Ø–ï–ú, –ß–¢–û –ó–ê–ì–†–£–ó–ò–õ–û–°–¨
        Print("–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: ", g_GlobalState.allowedInstrumentsCount);
        PrintWhiteList();

        // –¢–ï–°–¢: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É IsInstrumentAllowed
        string testSymbols = "XAUUSD,FUTMGCG26,EURUSD,GBPUSD,FUTMESH26";
        string symbols[];
        int count = StringSplit(testSymbols, ',', symbols);

        for (int i = 0; i < count; i++)
        {
            string sym = symbols[i];
            bool allowed = IsInstrumentAllowed(sym);
            Print("–¢–ï–°–¢ IsInstrumentAllowed[", sym, "] = ", allowed ? "–î–ê" : "–ù–ï–¢");
        }

        // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        Core_SaveGlobalState();
        Print("=== –ö–û–ù–ï–¶ –ó–ê–ì–†–£–ó–ö–ò –ë–ï–õ–û–ì–û –°–ü–ò–°–ö–ê ===");
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ input –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
    if (UseWhiteList && AllowedInstruments != "")
    {
        Print("=== –ó–ê–ì–†–£–ó–ö–ê –ë–ï–õ–û–ì–û –°–ü–ò–°–ö–ê ===");

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫
        LoadWhiteListFromString(AllowedInstruments);

        // –°–ò–ù–•–†–û–ù–ò–ó–ò–†–£–ï–ú –° –î–†–£–ì–ò–ú–ò –ú–û–î–£–õ–Ø–ú–ò
        SyncWhiteListBetweenModules();

        Print("=== –ö–û–ù–ï–¶ –ó–ê–ì–†–£–ó–ö–ò –ë–ï–õ–û–ì–û –°–ü–ò–°–ö–ê ===");
    }
    else if (UseWhiteList)
    {
        // –ï—Å–ª–∏ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –≤–∫–ª—é—á–µ–Ω, –Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä –ø—É—Å—Ç–æ–π - –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        LoadWhiteListFromSync();
    }

    //--- –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    g_GlobalState.dailyPositionsLimit = MaxDailyTrades;
    g_GlobalState.weeklyPositionsLimit = MaxWeeklyTrades;

    //--- –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    g_LastBalance = AccountInfoDouble(ACCOUNT_BALANCE);
    g_LastEquity = AccountInfoDouble(ACCOUNT_EQUITY);
    g_CurrentSymbol = Symbol();

    //--- –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —Å–¥–µ–ª–æ–∫ –∏ PnL
    RiskManager_UpdateTradeCountersLocal();
    RiskManager_UpdateClosedPnLCounters();

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤
    CheckResetConditions();

    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    Core_SaveGlobalState();

    //--- –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
    CreateInfoPanel();

    Print("–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: $", DoubleToString(g_LastBalance, 2));
    Print("–î–Ω–µ–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: ", g_GlobalState.dailyTradesCount, "/", MaxDailyTrades);
    Print("–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ", PositionsTotal(), "/", MaxSimultaneousPositions);
    Print("–î–Ω–µ–≤–Ω–æ–π PnL: $", DoubleToString(g_GlobalState.dailyPnLTotal, 2));
    Print("–†–∞–∑—Ä–µ—à–µ–Ω—ã –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏: ", g_GlobalState.allowNewTrades ? "–î–ê" : "–ù–ï–¢");
    Print("========================================");

    g_IsInitialized = true;
    EventSetTimer(1);
    return (INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò                                          |
//+------------------------------------------------------------------+
void DebugTradeLockStatus()
{
    Print("=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò ===");

    // 1. –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
    if (GlobalVariableCheck(GLOBAL_LOCK_VAR))
    {
        double value = GlobalVariableGet(GLOBAL_LOCK_VAR);
        Print("1. –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: ", value, " (", (value > 0 ? "–ê–ö–¢–ò–í–ù–ê" : "–Ω–µ –∞–∫—Ç–∏–≤–Ω–∞"), ")");
    }
    else
    {
        Print("1. –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢");
    }

    // 2. –§–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    if (FileIsExist("SIDEZ/TradeLock.bin", FILE_COMMON))
    {
        int handle = FileOpen("SIDEZ/TradeLock.bin", FILE_READ | FILE_BIN | FILE_COMMON);
        if (handle != INVALID_HANDLE)
        {
            datetime lockTime = (datetime)FileReadLong(handle);
            double reason = FileReadDouble(handle);
            string message = FileReadString(handle);
            FileClose(handle);

            Print("2. –§–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –°–£–©–ï–°–¢–í–£–ï–¢");
            Print("   –í—Ä–µ–º—è: ", TimeToString(lockTime));
            Print("   –ü—Ä–∏—á–∏–Ω–∞: ", message, " (–∫–æ–¥: ", reason, ")");
            Print("   –í–æ–∑—Ä–∞—Å—Ç: ", (TimeCurrent() - lockTime), " —Å–µ–∫—É–Ω–¥");
        }
        else
        {
            Print("2. –§–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –ü–û–í–†–ï–ñ–î–ï–ù");
        }
    }
    else
    {
        Print("2. –§–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –ù–ï–¢");
    }

    // 3. –§–ª–∞–≥–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    Print("3. –§–ª–∞–≥–∏ –≤ g_GlobalState:");
    Print("   dailyTPReached: ", g_GlobalState.dailyTPReached);
    Print("   dailySLReached: ", g_GlobalState.dailySLReached);
    Print("   weeklyTPReached: ", g_GlobalState.weeklyTPReached);
    Print("   weeklySLReached: ", g_GlobalState.weeklySLReached);
    Print("   allowNewTrades: ", g_GlobalState.allowNewTrades);
    Print("   blockManualTrading: ", g_GlobalState.blockManualTrading);

    // 4. –¢–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏
    Print("4. –¢–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏: ", PositionsTotal());

    // 5. –†–µ–∑—É–ª—å—Ç–∞—Ç IsGlobalTradeLockActive()
    Print("5. IsGlobalTradeLockActive(): ", IsGlobalTradeLockActive() ? "–î–ê" : "–ù–ï–¢");

    Print("=================================");
}

// –í—ã–∑–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –∏–ª–∏ –≤ OnTick() –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+
void OnTick()
{
    if (!g_IsInitialized)
        return;

    g_TickCounter++;

    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—â–µ
    if (g_TickCounter % 10 != 0)
        return; // –ö–∞–∂–¥—ã–µ 10 —Ç–∏–∫–æ–≤!

    // --- –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò ---
    static bool lastLockStatus = false;

    bool currentLockStatus = IsGlobalTradeLockActive();

    if (currentLockStatus)
    {
        // –ü–µ—á–∞—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
        if (!lastLockStatus)
        {
            Print("üî¥ –ì–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
        }

        // –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë
        if (PositionsTotal() > 0)
        {
            Print("üî¥ –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ");
            ForceCloseAllPositionsInstantly();
        }

        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞
        if (OrdersTotal() > 0)
        {
            Print("üî¥ –£–¥–∞–ª—è–µ–º –≤—Å–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞");
            BlockAllPendingOrders();
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        lastLockStatus = true;

        // –í—ã—Ö–æ–¥–∏–º –∏–∑ OnTick - –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        return;
    }
    else
    {
        // –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞, –ø–µ—á–∞—Ç–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑
        if (lastLockStatus)
        {
            Print("‚úÖ –ì–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞");
            lastLockStatus = false;
        }
    }

    //--- –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏ —ç–∫–≤–∏—Ç–∏
    double currentBalance = AccountInfoDouble(ACCOUNT_BALANCE);
    double currentEquity = AccountInfoDouble(ACCOUNT_EQUITY);

    if (currentBalance != g_LastBalance || currentEquity != g_LastEquity)
    {
        g_LastBalance = currentBalance;
        g_LastEquity = currentEquity;
    }

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è —Å–±—Ä–æ—Å–∞
    if (EnableAutoReset)
    {
        CheckResetConditions();
    }

    //--- –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —Å–¥–µ–ª–æ–∫ (–í–°–ï–ì–î–ê –ø—Ä–∏ —Ç–∏–∫–µ!)
    RiskManager_UpdateTradeCountersLocal();

    //--- –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ PnL (–ß–ò–°–¢–´–ô PnL!)
    RiskManager_UpdateClosedPnLCounters();

    //--- –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π PnL
    if (g_GlobalState.dailyPnLTotal > g_GlobalState.maxDailyPnL)
        g_GlobalState.maxDailyPnL = g_GlobalState.dailyPnLTotal;

    if (g_GlobalState.weeklyPnLTotal > g_GlobalState.maxWeeklyPnL)
        g_GlobalState.maxWeeklyPnL = g_GlobalState.weeklyPnLTotal;

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã (–ø–æ –ß–ò–°–¢–û–ú–£ PnL!)
    CheckRiskLimits();

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
    if (CloseAllAtSessionEnd)
    {
        CheckSessionEnd();
    }

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏ (–ø—è—Ç–Ω–∏—Ü–∞)
    if (CloseAllOnFriday)
    {
        CheckFridayClose();
    }

    //--- –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∏—Å–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–µ—Ä–∏–π
    UpdateDynamicRisk();

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
    if (g_ForceCloseAll)
    {
        ExecuteForceCloseAll();
    }

    //--- –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 200 —Ç–∏–∫–æ–≤
    if (g_TickCounter % 200 == 0)
    {
        Print("RiskManager status: Daily PnL=$", DoubleToString(g_GlobalState.dailyPnLTotal, 2),
              " | Weekly PnL=$", DoubleToString(g_GlobalState.weeklyPnLTotal, 2),
              " | Daily TP=$", DailyTakeProfit, " | Daily SL=$", DailyStopLoss,
              " | Positions=", PositionsTotal(),
              " | Risk=", DoubleToString(g_GlobalState.currentRiskPercent, 1), "%",
              " | Daily Trades=", g_GlobalState.dailyPositionsCount, "/", MaxDailyTrades);
    }

    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –ò–õ–ò –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    static datetime lastAutoSave = 0;
    if (TimeCurrent() - lastAutoSave >= 60)
    {
        Core_SaveGlobalState();
        lastAutoSave = TimeCurrent();
    }

    //--- –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
    UpdateInfoPanel();

    //--- –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
    UpdateChartComment();
}

//+------------------------------------------------------------------+
//| OnTimer - –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø                                    |
//+------------------------------------------------------------------+
void OnTimer()
{
    // 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏
    if (RM_EnableTradeGateway && BlockNonGatewayTrades)
    {
        MonitorUnauthorizedTrades();
    }

    // 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Telegram —Å–∏–≥–Ω–∞–ª—ã
    if (EnableExternalSignals && g_HasTelegramSignal && !g_TelegramSignal.processed)
    {
        ExecuteTelegramSignal();
    }

    // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
    RiskManager_UpdateTradeCountersLocal();
    RiskManager_UpdateClosedPnLCounters();

    // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    CheckAndUpdateBlockStatus();

    // 5. –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å
    UpdateInfoPanel();
}

//+------------------------------------------------------------------+
//| –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤                                |
//+------------------------------------------------------------------+
void CheckResetConditions()
{
    MqlDateTime dt;
    TimeCurrent(dt);

    //--- –§–æ—Ä–º–∏—Ä—É–µ–º –≤—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ "HH:MM"
    int resetHour, resetMinute;
    if (ParseTimeString(DailyResetTime, resetHour, resetMinute))
    {
        MqlDateTime resetDt = dt;
        resetDt.hour = resetHour;
        resetDt.min = resetMinute;
        resetDt.sec = 0;
        datetime resetTimeToday = StructToTime(resetDt);

        //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–Ω–µ–≤–Ω–æ–π —Å–±—Ä–æ—Å
        if (TimeCurrent() >= resetTimeToday && g_GlobalState.lastDailyReset < resetTimeToday)
        {
            //--- –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–Ω–µ–≤–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
            g_GlobalState.dailyTPReached = false;
            g_GlobalState.dailySLReached = false;
            g_GlobalState.dailyPositionsCount = 0;
            g_GlobalState.dailyPnLStart = RiskManager_CalculateTotalPnL(true, false);
            g_GlobalState.dailyPnLTotal = 0;
            g_GlobalState.totalClosedProfitToday = 0;
            g_GlobalState.totalClosedLossToday = 0;
            g_GlobalState.maxDailyPnL = 0;
            g_GlobalState.lastDailyReset = resetTimeToday;
            g_GlobalState.allowNewTrades = true;
            g_GlobalState.lossStreak = 0;
            g_GlobalState.profitStreak = 0;

            // ‚úÖ –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –†–£–ß–ù–£–Æ –¢–û–†–ì–û–í–õ–Æ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
            g_GlobalState.blockManualTrading = false;

            Print("=== –î–ù–ï–í–ù–û–ô –°–ë–†–û–° ===");
            Print("–í—Ä–µ–º—è: ", TimeToString(TimeCurrent()));
            Print("–°–±—Ä–æ—à–µ–Ω—ã –¥–Ω–µ–≤–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –∏ –ª–∏–º–∏—Ç—ã");
            Print("–†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –†–ê–ó–†–ï–®–ï–ù–ê");
            Print("–ù–∞—á–∞–ª—å–Ω—ã–π PnL: $", DoubleToString(g_GlobalState.dailyPnLStart, 2));
        }
    }

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–¥–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
    if (dt.day_of_week == 1) // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
    {
        if (ParseTimeString(StringSubstr(WeeklyResetTime, 4), resetHour, resetMinute))
        {
            MqlDateTime weeklyResetDt = dt;
            weeklyResetDt.hour = resetHour;
            weeklyResetDt.min = resetMinute;
            weeklyResetDt.sec = 0;
            datetime weeklyResetTime = StructToTime(weeklyResetDt);

            if (TimeCurrent() >= weeklyResetTime && g_GlobalState.lastWeeklyReset < weeklyResetTime)
            {
                //--- –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ–¥–µ–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
                g_GlobalState.weeklyTPReached = false;
                g_GlobalState.weeklySLReached = false;
                g_GlobalState.weeklyPositionsCount = 0;
                g_GlobalState.weeklyPnLStart = RiskManager_CalculateTotalPnL(false, false);
                g_GlobalState.weeklyPnLTotal = 0;
                g_GlobalState.totalClosedProfitWeek = 0;
                g_GlobalState.totalClosedLossWeek = 0;
                g_GlobalState.maxWeeklyPnL = 0;
                g_GlobalState.lastWeeklyReset = weeklyResetTime;

                // ‚úÖ –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –†–£–ß–ù–£–Æ –¢–û–†–ì–û–í–õ–Æ –ø—Ä–∏ –Ω–µ–¥–µ–ª—å–Ω–æ–º —Å–±—Ä–æ—Å–µ
                g_GlobalState.blockManualTrading = false;

                Print("=== –ù–ï–î–ï–õ–¨–ù–´–ô –°–ë–†–û–° ===");
                Print("–í—Ä–µ–º—è: ", TimeToString(TimeCurrent()));
                Print("–°–±—Ä–æ—à–µ–Ω—ã –Ω–µ–¥–µ–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –∏ –ª–∏–º–∏—Ç—ã");
                Print("–†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –†–ê–ó–†–ï–®–ï–ù–ê");
                Print("–ù–∞—á–∞–ª—å–Ω—ã–π –Ω–µ–¥–µ–ª—å–Ω—ã–π PnL: $", DoubleToString(g_GlobalState.weeklyPnLStart, 2));
            }
        }
    }
}

//+------------------------------------------------------------------+
//| –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ –≤—Ä–µ–º–µ–Ω–∏                                           |
//+------------------------------------------------------------------+
bool ParseTimeString(string timeStr, int &hour, int &minute)
{
    string parts[];
    int count = StringSplit(timeStr, ':', parts);

    if (count >= 2)
    {
        hour = (int)StringToInteger(parts[0]);
        minute = (int)StringToInteger(parts[1]);

        if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59)
            return true;
    }

    hour = 0;
    minute = 1;
    return false;
}

//+------------------------------------------------------------------+
//| –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ —Ä–∏—Å–∫–∞ –ø–æ PnL (—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π —Ä—É—á–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏)   |
//+------------------------------------------------------------------+
void CheckRiskLimits()
{
    //--- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω–µ–≤–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤ –ø–æ PnL
    if (!g_GlobalState.dailyTPReached && DailyTakeProfit > 0 && g_GlobalState.dailyPnLTotal >= DailyTakeProfit)
    {
        g_GlobalState.dailyTPReached = true;
        g_GlobalState.allowNewTrades = false;

        // –ë–õ–û–ö–ò–†–£–ï–ú –†–£–ß–ù–£–Æ –¢–û–†–ì–û–í–õ–Æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è
        if (BlockManualTradingOnLimit)
        {
            g_GlobalState.blockManualTrading = true;
            Print("‚ö† –î–æ—Å—Ç–∏–≥–Ω—É—Ç –¥–Ω–µ–≤–Ω–æ–π TP. –†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê.");
        }

        g_ForceCloseAll = true;

        Print("========================================");
        Print("–î–ù–ï–í–ù–û–ô TAKE PROFIT –î–û–°–¢–ò–ì–ù–£–¢!");
        Print("–¢–µ–∫—É—â–∏–π PnL: $", DoubleToString(g_GlobalState.dailyPnLTotal, 2));
        Print("–¶–µ–ª—å: $", DailyTakeProfit);
        if (BlockManualTradingOnLimit)
            Print("–†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê –¥–æ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤");
        Print("========================================");

        Alert("–î–Ω–µ–≤–Ω–æ–π Take Profit –¥–æ—Å—Ç–∏–≥–Ω—É—Ç! –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã.");
    }

    if (!g_GlobalState.dailySLReached && DailyStopLoss < 0 && g_GlobalState.dailyPnLTotal <= DailyStopLoss)
    {
        g_GlobalState.dailySLReached = true;
        g_GlobalState.allowNewTrades = false;

        // –ë–õ–û–ö–ò–†–£–ï–ú –†–£–ß–ù–£–Æ –¢–û–†–ì–û–í–õ–Æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è
        if (BlockManualTradingOnLimit)
        {
            g_GlobalState.blockManualTrading = true;
            Print("‚ö† –î–æ—Å—Ç–∏–≥–Ω—É—Ç –¥–Ω–µ–≤–Ω–æ–π SL. –†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê.");
        }

        g_ForceCloseAll = true;

        Print("========================================");
        Print("–î–ù–ï–í–ù–û–ô STOP LOSS –î–û–°–¢–ò–ì–ù–£–¢!");
        Print("–¢–µ–∫—É—â–∏–π PnL: $", DoubleToString(g_GlobalState.dailyPnLTotal, 2));
        Print("–õ–∏–º–∏—Ç: $", DailyStopLoss);
        if (BlockManualTradingOnLimit)
            Print("–†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê –¥–æ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤");
        Print("========================================");

        Alert("–î–Ω–µ–≤–Ω–æ–π Stop Loss –¥–æ—Å—Ç–∏–≥–Ω—É—Ç! –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã.");
    }

    //--- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–¥–µ–ª—å–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤ –ø–æ PnL
    if (!g_GlobalState.weeklyTPReached && WeeklyTakeProfit > 0 && g_GlobalState.weeklyPnLTotal >= WeeklyTakeProfit)
    {
        g_GlobalState.weeklyTPReached = true;
        g_GlobalState.allowNewTrades = false;

        // –ë–õ–û–ö–ò–†–£–ï–ú –†–£–ß–ù–£–Æ –¢–û–†–ì–û–í–õ–Æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è
        if (BlockManualTradingOnLimit)
        {
            g_GlobalState.blockManualTrading = true;
            Print("‚ö† –î–æ—Å—Ç–∏–≥–Ω—É—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π TP. –†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê.");
        }

        g_ForceCloseAll = true;

        Print("========================================");
        Print("–ù–ï–î–ï–õ–¨–ù–´–ô TAKE PROFIT –î–û–°–¢–ò–ì–ù–£–¢!");
        Print("–¢–µ–∫—É—â–∏–π –Ω–µ–¥–µ–ª—å–Ω—ã–π PnL: $", DoubleToString(g_GlobalState.weeklyPnLTotal, 2));
        Print("–¶–µ–ª—å: $", WeeklyTakeProfit);
        if (BlockManualTradingOnLimit)
            Print("–†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê –¥–æ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤");
        Print("========================================");

        Alert("–ù–µ–¥–µ–ª—å–Ω—ã–π Take Profit –¥–æ—Å—Ç–∏–≥–Ω—É—Ç! –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã.");
    }

    if (!g_GlobalState.weeklySLReached && WeeklyStopLoss < 0 && g_GlobalState.weeklyPnLTotal <= WeeklyStopLoss)
    {
        g_GlobalState.weeklySLReached = true;
        g_GlobalState.allowNewTrades = false;

        // –ë–õ–û–ö–ò–†–£–ï–ú –†–£–ß–ù–£–Æ –¢–û–†–ì–û–í–õ–Æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è
        if (BlockManualTradingOnLimit)
        {
            g_GlobalState.blockManualTrading = true;
            Print("‚ö† –î–æ—Å—Ç–∏–≥–Ω—É—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π SL. –†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê.");
        }

        g_ForceCloseAll = true;

        Print("========================================");
        Print("–ù–ï–î–ï–õ–¨–ù–´–ô STOP LOSS –î–û–°–¢–ò–ì–ù–£–¢!");
        Print("–¢–µ–∫—É—â–∏–π –Ω–µ–¥–µ–ª—å–Ω—ã–π PnL: $", DoubleToString(g_GlobalState.weeklyPnLTotal, 2));
        Print("–õ–∏–º–∏—Ç: $", WeeklyStopLoss);
        if (BlockManualTradingOnLimit)
            Print("–†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê –¥–æ —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤");
        Print("========================================");

        Alert("–ù–µ–¥–µ–ª—å–Ω—ã–π Stop Loss –¥–æ—Å—Ç–∏–≥–Ω—É—Ç! –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã.");
    }

    //--- –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ª–∏–º–∏—Ç–æ–≤ —Å–¥–µ–ª–æ–∫ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
    bool shouldBlock = false;
    string blockReason = "";

    // 1. –õ–∏–º–∏—Ç—ã —Å–¥–µ–ª–æ–∫ –∑–∞ –¥–µ–Ω—å
    if (g_GlobalState.dailyTradesCount >= MaxDailyTrades)
    {
        shouldBlock = true;
        blockReason = StringFormat("–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç —Å–¥–µ–ª–æ–∫: %d/%d",
                                   g_GlobalState.dailyTradesCount, MaxDailyTrades);
        Print("‚ö† –î–æ—Å—Ç–∏–≥–Ω—É—Ç –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç —Å–¥–µ–ª–æ–∫: ", g_GlobalState.dailyTradesCount, "/", MaxDailyTrades);
    }

    // 2. –õ–∏–º–∏—Ç—ã —Å–¥–µ–ª–æ–∫ –∑–∞ –Ω–µ–¥–µ–ª—é
    if (g_GlobalState.weeklyTradesCount >= MaxWeeklyTrades)
    {
        shouldBlock = true;
        blockReason = StringFormat("–ù–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç —Å–¥–µ–ª–æ–∫: %d/%d",
                                   g_GlobalState.weeklyTradesCount, MaxWeeklyTrades);
        Print("‚ö† –î–æ—Å—Ç–∏–≥–Ω—É—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç —Å–¥–µ–ª–æ–∫: ", g_GlobalState.weeklyTradesCount, "/", MaxWeeklyTrades);
    }

    // 3. –õ–∏–º–∏—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π (–¥–µ–Ω—å)
    int currentPositions = PositionsTotal();
    if (currentPositions >= MaxSimultaneousPositions)
    {
        shouldBlock = true;
        blockReason = StringFormat("–õ–∏–º–∏—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: %d/%d",
                                   currentPositions, MaxSimultaneousPositions);
        Print("‚ö† –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ", currentPositions, "/", MaxSimultaneousPositions);
    }

    // 4. –õ–∏–º–∏—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π (–Ω–µ–¥–µ–ª—è)
    if (currentPositions >= MaxSimultaneousPositionsWeekly)
    {
        shouldBlock = true;
        blockReason = StringFormat("–ù–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –æ–¥–Ω–æ–≤—Ä. –ø–æ–∑–∏—Ü–∏–π: %d/%d",
                                   currentPositions, MaxSimultaneousPositionsWeekly);
        Print("‚ö† –î–æ—Å—Ç–∏–≥–Ω—É—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π: ", currentPositions, "/", MaxSimultaneousPositionsWeekly);
    }

    // 5. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    if (shouldBlock && !IsGlobalTradeLockActive())
    {
        g_GlobalState.allowNewTrades = false;

        // –ë–õ–û–ö–ò–†–£–ï–ú –†–£–ß–ù–£–Æ –¢–û–†–ì–û–í–õ–Æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –æ–ø—Ü–∏—è
        if (BlockManualTradingOnLimit)
        {
            g_GlobalState.blockManualTrading = true;
            Print("‚ö† –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Å–¥–µ–ª–æ–∫/–ø–æ–∑–∏—Ü–∏–π. –†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê.");
        }

        SetGlobalTradeLock(5, blockReason); // 5 = Manual/System lock

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤
        if (PositionsTotal() > 0)
        {
            Print("üö® –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –ø–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é –ª–∏–º–∏—Ç–æ–≤...");
            ForceCloseAllPositionsInstantly();
        }

        Alert("–¢–û–†–ì–û–í–õ–Ø –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê: " + blockReason);
    }
}

//+------------------------------------------------------------------+
//| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–∏—Å–∫–∞                                   |
//+------------------------------------------------------------------+
void UpdateDynamicRisk()
{
    if (!UseDynamicRisk)
        return;

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–µ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫
    CalculateProfitLossStreaks();

    //--- –ï—Å–ª–∏ –±—ã–ª–∞ —Å–µ—Ä–∏—è —É–±—ã—Ç–∫–æ–≤ - —É–º–µ–Ω—å—à–∞–µ–º —Ä–∏—Å–∫
    if (g_GlobalState.lossStreak >= LossStreakToReduce)
    {
        double newRisk = g_GlobalState.currentRiskPercent * 0.7;
        if (newRisk < MinRiskPercent)
            newRisk = MinRiskPercent;

        if (newRisk != g_GlobalState.currentRiskPercent)
        {
            g_GlobalState.currentRiskPercent = newRisk;
            Print("–£–º–µ–Ω—å—à–µ–Ω —Ä–∏—Å–∫ –¥–æ ", DoubleToString(g_GlobalState.currentRiskPercent, 1), "% –ø–æ—Å–ª–µ ",
                  g_GlobalState.lossStreak, " —É–±—ã—Ç–∫–æ–≤ –ø–æ–¥—Ä—è–¥");
        }
    }

    //--- –ï—Å–ª–∏ –±—ã–ª–∞ —Å–µ—Ä–∏—è –ø—Ä–∏–±—ã–ª–µ–π - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∏—Å–∫ (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º)
    if (g_GlobalState.profitStreak >= ProfitStreakToIncrease)
    {
        double newRisk = g_GlobalState.currentRiskPercent * 1.2;
        if (newRisk > MaxRiskPercent)
            newRisk = MaxRiskPercent;

        if (newRisk != g_GlobalState.currentRiskPercent)
        {
            g_GlobalState.currentRiskPercent = newRisk;
            Print("–£–≤–µ–ª–∏—á–µ–Ω —Ä–∏—Å–∫ –¥–æ ", DoubleToString(g_GlobalState.currentRiskPercent, 1), "% –ø–æ—Å–ª–µ ",
                  g_GlobalState.profitStreak, " –ø—Ä–∏–±—ã–ª–µ–π –ø–æ–¥—Ä—è–¥");
        }
    }
}

//+------------------------------------------------------------------+
//| –†–∞—Å—á–µ—Ç —Å–µ—Ä–∏–π –ø—Ä–∏–±—ã–ª–µ–π/—É–±—ã—Ç–∫–æ–≤                                    |
//+------------------------------------------------------------------+
void CalculateProfitLossStreaks()
{
    //--- –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–¥–µ–ª–æ–∫
    //--- –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–¥–µ–ª–æ–∫

    int totalDeals = HistoryDealsTotal();
    int recentDeals = MathMin(totalDeals, 100);
    int profitCount = 0;
    int lossCount = 0;

    for (int i = 0; i < recentDeals; i++)
    {
        ulong ticket = HistoryDealGetTicket(i);
        if (ticket > 0)
        {
            long dealType = HistoryDealGetInteger(ticket, DEAL_TYPE);
            if (dealType == DEAL_TYPE_BUY || dealType == DEAL_TYPE_SELL)
            {
                double profit = HistoryDealGetDouble(ticket, DEAL_PROFIT);

                if (profit > 0)
                {
                    profitCount++;
                    lossCount = 0;
                }
                else if (profit < 0)
                {
                    lossCount++;
                    profitCount = 0;
                }
            }
        }
    }

    //--- –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–∏–∏
    if (profitCount > 0)
    {
        g_GlobalState.profitStreak = profitCount;
        g_GlobalState.lossStreak = 0;
    }
    else if (lossCount > 0)
    {
        g_GlobalState.lossStreak = lossCount;
        g_GlobalState.profitStreak = 0;
    }
}

//+------------------------------------------------------------------+
//| –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–æ–π —Å–µ—Å—Å–∏–∏                               |
//+------------------------------------------------------------------+
void CheckSessionEnd()
{
    MqlDateTime dt;
    TimeCurrent(dt);

    int currentMinutes = dt.hour * 60 + dt.min;
    int endHour, endMinute;

    if (ParseTimeString(TradingSessionEnd, endHour, endMinute))
    {
        int endMinutes = endHour * 60 + endMinute;

        //--- –ó–∞–∫—Ä—ã–≤–∞–µ–º –∑–∞ 25 –º–∏–Ω—É—Ç –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è
        if (currentMinutes >= endMinutes - 25 && currentMinutes < endMinutes)
        {
            if (PositionsTotal() > 0)
            {
                Print("–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Ç–æ—Ä–≥–æ–≤–∞—è —Å–µ—Å—Å–∏—è, –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏...");
                g_ForceCloseAll = true;
            }
        }
    }
}

//+------------------------------------------------------------------+
//| –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤ –ø—è—Ç–Ω–∏—Ü—É                                      |
//+------------------------------------------------------------------+
void CheckFridayClose()
{
    MqlDateTime dt;
    TimeCurrent(dt);

    if (dt.day_of_week == 5) // –ü—è—Ç–Ω–∏—Ü–∞
    {
        int currentMinutes = dt.hour * 60 + dt.min;
        int closeHour, closeMinute;

        if (ParseTimeString(FridayCloseTime, closeHour, closeMinute))
        {
            int closeMinutes = closeHour * 60 + closeMinute;

            //--- –ó–∞–∫—Ä—ã–≤–∞–µ–º –∑–∞ 30 –º–∏–Ω—É—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
            if (currentMinutes >= closeMinutes - 30 && currentMinutes < closeMinutes)
            {
                if (PositionsTotal() > 0)
                {
                    Print("–ü—è—Ç–Ω–∏—Ü–∞, –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–Ω—ã–º–∏...");
                    g_ForceCloseAll = true;
                }
            }
        }
    }
}

/*
//+------------------------------------------------------------------+
//| –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤                                   |
//+------------------------------------------------------------------+
void CheckCorrelationRisks()
{
   //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Ç–æ—Ä–≥—É–µ–º –ª–∏ –º—ã —Å–∏–ª—å–Ω–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
   for(int i = 0; i < g_GlobalState.correlationCount; i++)
   {
      string pair = g_GlobalState.correlationPairs[i];
      string symbols[];

      if(StringSplit(pair, ':', symbols) == 2)
      {
         string sym1 = symbols[0];
         string sym2 = symbols[1];

         //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –æ–±–æ–∏–º —Å–∏–º–≤–æ–ª–∞–º
         bool hasSym1 = HasOpenPositions(sym1);
         bool hasSym2 = HasOpenPositions(sym2);

         if(hasSym1 && hasSym2)
         {
            Print("–í–ù–ò–ú–ê–ù–ò–ï: –û—Ç–∫—Ä—ã—Ç—ã –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–∞—Ä–µ ", sym1, " –∏ ", sym2);

            //--- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –æ–¥–Ω–æ–π –∏–∑ –ø–æ–∑–∏—Ü–∏–π
            if(g_GlobalState.correlationValues[i] > 0.7) // –í—ã—Å–æ–∫–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è
            {
               Print("–í—ã—Å–æ–∫–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è (", g_GlobalState.correlationValues[i], "). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–∫—Ä—ã—Ç—å –æ–¥–Ω—É –∏–∑ –ø–æ–∑–∏—Ü–∏–π.");
            }
         }
      }
   }
}
*/

//+------------------------------------------------------------------+
//| –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø–æ —Å–∏–º–≤–æ–ª—É                     |
//+------------------------------------------------------------------+
bool HasOpenPositions(string symbol)
{
    for (int i = 0; i < PositionsTotal(); i++)
    {
        ulong ticket = PositionGetTicket(i);
        if (PositionSelectByTicket(ticket))
        {
            string posSymbol = PositionGetString(POSITION_SYMBOL);
            if (posSymbol == symbol)
                return true;
        }
    }
    return false;
}

//+------------------------------------------------------------------+
//| –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π                   |
//+------------------------------------------------------------------+
void ExecuteForceCloseAll()
{
    if (!g_ForceCloseAll)
        return;

    Print("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π...");

    int closedCount = CloseAllPositions("Force Close");

    if (closedCount > 0)
    {
        Print("–ó–∞–∫—Ä—ã—Ç–æ ", closedCount, " –ø–æ–∑–∏—Ü–∏–π");
    }

    g_ForceCloseAll = false;

    //--- –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–±–Ω–æ–≤–ª—è–µ–º PnL
    RiskManager_UpdateClosedPnLCounters();
}

//+------------------------------------------------------------------+
//| –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π                                            |
//+------------------------------------------------------------------+
int CloseAllPositions(string reason)
{
    Print("–ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π. –ü—Ä–∏—á–∏–Ω–∞: ", reason);
    Print("–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è: ", PositionsTotal());

    int closedCount = 0;
    int totalPositions = PositionsTotal();

    //--- –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–∏–∫–µ—Ç—ã
    ulong tickets[];
    ArrayResize(tickets, totalPositions);

    for (int i = 0; i < totalPositions; i++)
    {
        tickets[i] = PositionGetTicket(i);
    }

    //--- –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é
    for (int i = 0; i < totalPositions; i++)
    {
        if (tickets[i] == 0)
            continue;

        if (PositionSelectByTicket(tickets[i]))
        {
            string symbol = PositionGetString(POSITION_SYMBOL);
            double volume = PositionGetDouble(POSITION_VOLUME);
            long type = PositionGetInteger(POSITION_TYPE);
            double profit = PositionGetDouble(POSITION_PROFIT);

            Print("–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ #", tickets[i], ": ", symbol,
                  " –û–±—ä–µ–º: ", DoubleToString(volume, 2),
                  " –¢–∏–ø: ", (type == POSITION_TYPE_BUY ? "BUY" : "SELL"),
                  " –ü—Ä–∏–±—ã–ª—å: $", DoubleToString(profit, 2));

            //--- –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
            if (g_Trade.PositionClose(tickets[i]))
            {
                closedCount++;
                Print("  –£—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞");

                //--- –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
                g_GlobalState.dailyPositionsCount++;
                g_GlobalState.weeklyPositionsCount++;
            }
            else
            {
                Print("  –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏. –ö–æ–¥: ", g_Trade.ResultRetcode(),
                      " - ", g_Trade.ResultRetcodeDescription());
            }

            Sleep(50); // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞
        }
    }

    Print("–û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ", closedCount, " –∑–∞–∫—Ä—ã—Ç–æ –∏–∑ ", totalPositions);

    if (PositionsTotal() > 0)
    {
        Alert("–í–Ω–∏–º–∞–Ω–∏–µ: ", PositionsTotal(), " –ø–æ–∑–∏—Ü–∏–π –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!");
    }

    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    Core_SaveGlobalState();

    return closedCount;
}

//+------------------------------------------------------------------+
//| –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏                                   |
//+------------------------------------------------------------------+
void CreateInfoPanel()
{
    //--- –§–æ–Ω –ø–∞–Ω–µ–ª–∏
    ObjectCreate(0, "RiskManager_Panel_BG", OBJ_RECTANGLE_LABEL, 0, 0, 0);
    ObjectSetInteger(0, "RiskManager_Panel_BG", OBJPROP_XDISTANCE, 10);
    ObjectSetInteger(0, "RiskManager_Panel_BG", OBJPROP_YDISTANCE, 20);
    ObjectSetInteger(0, "RiskManager_Panel_BG", OBJPROP_XSIZE, 300);
    ObjectSetInteger(0, "RiskManager_Panel_BG", OBJPROP_YSIZE, 220); // –£–≤–µ–ª–∏—á–∏–ª–∏ –Ω–∞ 20
    ObjectSetInteger(0, "RiskManager_Panel_BG", OBJPROP_BGCOLOR, clrBlack);
    ObjectSetInteger(0, "RiskManager_Panel_BG", OBJPROP_BORDER_TYPE, BORDER_FLAT);
    ObjectSetInteger(0, "RiskManager_Panel_BG", OBJPROP_BORDER_COLOR, clrGray);

    //--- –ó–∞–≥–æ–ª–æ–≤–æ–∫
    ObjectCreate(0, "RiskManager_Panel_Title", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "RiskManager_Panel_Title", OBJPROP_TEXT, RiskManagerName);
    ObjectSetInteger(0, "RiskManager_Panel_Title", OBJPROP_XDISTANCE, 20);
    ObjectSetInteger(0, "RiskManager_Panel_Title", OBJPROP_YDISTANCE, 30);
    ObjectSetInteger(0, "RiskManager_Panel_Title", OBJPROP_COLOR, clrYellow);
    ObjectSetInteger(0, "RiskManager_Panel_Title", OBJPROP_FONTSIZE, 10);

    //--- –î–Ω–µ–≤–Ω–æ–π PnL
    ObjectCreate(0, "RiskManager_Panel_DailyPnL", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "RiskManager_Panel_DailyPnL", OBJPROP_TEXT, "–î–Ω–µ–≤–Ω–æ–π PnL: $0.00");
    ObjectSetInteger(0, "RiskManager_Panel_DailyPnL", OBJPROP_XDISTANCE, 20);
    ObjectSetInteger(0, "RiskManager_Panel_DailyPnL", OBJPROP_YDISTANCE, 55);
    ObjectSetInteger(0, "RiskManager_Panel_DailyPnL", OBJPROP_COLOR, clrWhite);

    //--- –ù–µ–¥–µ–ª—å–Ω—ã–π PnL
    ObjectCreate(0, "RiskManager_Panel_WeeklyPnL", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "RiskManager_Panel_WeeklyPnL", OBJPROP_TEXT, "–ù–µ–¥–µ–ª—å–Ω—ã–π PnL: $0.00");
    ObjectSetInteger(0, "RiskManager_Panel_WeeklyPnL", OBJPROP_XDISTANCE, 20);
    ObjectSetInteger(0, "RiskManager_Panel_WeeklyPnL", OBJPROP_YDISTANCE, 75);
    ObjectSetInteger(0, "RiskManager_Panel_WeeklyPnL", OBJPROP_COLOR, clrWhite);

    //--- –°—Ç–∞—Ç—É—Å —Ç–æ—Ä–≥–æ–≤–ª–∏
    ObjectCreate(0, "RiskManager_Panel_TradeStatus", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "RiskManager_Panel_TradeStatus", OBJPROP_TEXT, "–¢–æ—Ä–≥–æ–≤–ª—è: –†–ê–ó–†–ï–®–ï–ù–ê");
    ObjectSetInteger(0, "RiskManager_Panel_TradeStatus", OBJPROP_XDISTANCE, 20);
    ObjectSetInteger(0, "RiskManager_Panel_TradeStatus", OBJPROP_YDISTANCE, 95);
    ObjectSetInteger(0, "RiskManager_Panel_TradeStatus", OBJPROP_COLOR, clrLime);

    //--- –î–Ω–µ–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏
    ObjectCreate(0, "RiskManager_Panel_DailyTrades", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "RiskManager_Panel_DailyTrades", OBJPROP_TEXT, "–î–Ω–µ–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏: 0/10");
    ObjectSetInteger(0, "RiskManager_Panel_DailyTrades", OBJPROP_XDISTANCE, 20);
    ObjectSetInteger(0, "RiskManager_Panel_DailyTrades", OBJPROP_YDISTANCE, 115);
    ObjectSetInteger(0, "RiskManager_Panel_DailyTrades", OBJPROP_COLOR, clrWhite);

    //--- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    ObjectCreate(0, "RiskManager_Panel_Simultaneous", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "RiskManager_Panel_Simultaneous", OBJPROP_TEXT, "–û–¥–Ω–æ–≤—Ä. –ø–æ–∑–∏—Ü–∏–∏: 0/3");
    ObjectSetInteger(0, "RiskManager_Panel_Simultaneous", OBJPROP_XDISTANCE, 20);
    ObjectSetInteger(0, "RiskManager_Panel_Simultaneous", OBJPROP_YDISTANCE, 135);
    ObjectSetInteger(0, "RiskManager_Panel_Simultaneous", OBJPROP_COLOR, clrWhite);

    //--- –†–∏—Å–∫
    ObjectCreate(0, "RiskManager_Panel_Risk", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "RiskManager_Panel_Risk", OBJPROP_TEXT, "–¢–µ–∫—É—â–∏–π —Ä–∏—Å–∫: 1.0%");
    ObjectSetInteger(0, "RiskManager_Panel_Risk", OBJPROP_XDISTANCE, 20);
    ObjectSetInteger(0, "RiskManager_Panel_Risk", OBJPROP_YDISTANCE, 155);
    ObjectSetInteger(0, "RiskManager_Panel_Risk", OBJPROP_COLOR, clrWhite);

    //--- –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    ObjectCreate(0, "RiskManager_Panel_OpenPositions", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "RiskManager_Panel_OpenPositions", OBJPROP_TEXT, "–û—Ç–∫—Ä—ã—Ç–æ –ø–æ–∑–∏—Ü–∏–π: 0");
    ObjectSetInteger(0, "RiskManager_Panel_OpenPositions", OBJPROP_XDISTANCE, 20);
    ObjectSetInteger(0, "RiskManager_Panel_OpenPositions", OBJPROP_YDISTANCE, 175);
    ObjectSetInteger(0, "RiskManager_Panel_OpenPositions", OBJPROP_COLOR, clrWhite);

    //--- –í—Ä–µ–º—è
    ObjectCreate(0, "RiskManager_Panel_Time", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "RiskManager_Panel_Time", OBJPROP_TEXT, "–û–±–Ω–æ–≤–ª–µ–Ω–æ: --:--:--");
    ObjectSetInteger(0, "RiskManager_Panel_Time", OBJPROP_XDISTANCE, 20);
    ObjectSetInteger(0, "RiskManager_Panel_Time", OBJPROP_YDISTANCE, 195);
    ObjectSetInteger(0, "RiskManager_Panel_Time", OBJPROP_COLOR, clrSilver);
    ObjectSetInteger(0, "RiskManager_Panel_Time", OBJPROP_FONTSIZE, 8);
}

//+------------------------------------------------------------------+
//| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏                                 |
//+------------------------------------------------------------------+
void UpdateInfoPanel()
{
    //--- –î–Ω–µ–≤–Ω–æ–π PnL
    string dailyPnLText = "–î–Ω–µ–≤–Ω–æ–π PnL: $" + DoubleToString(g_GlobalState.dailyPnLTotal, 2);
    color dailyPnLColor = (g_GlobalState.dailyPnLTotal >= 0) ? clrLime : clrRed;
    ObjectSetString(0, "RiskManager_Panel_DailyPnL", OBJPROP_TEXT, dailyPnLText);
    ObjectSetInteger(0, "RiskManager_Panel_DailyPnL", OBJPROP_COLOR, dailyPnLColor);

    //--- –ù–µ–¥–µ–ª—å–Ω—ã–π PnL
    string weeklyPnLText = "–ù–µ–¥–µ–ª—å–Ω—ã–π PnL: $" + DoubleToString(g_GlobalState.weeklyPnLTotal, 2);
    color weeklyPnLColor = (g_GlobalState.weeklyPnLTotal >= 0) ? clrLime : clrRed;
    ObjectSetString(0, "RiskManager_Panel_WeeklyPnL", OBJPROP_TEXT, weeklyPnLText);
    ObjectSetInteger(0, "RiskManager_Panel_WeeklyPnL", OBJPROP_COLOR, weeklyPnLColor);

    //--- –°—Ç–∞—Ç—É—Å —Ç–æ—Ä–≥–æ–≤–ª–∏
    string tradeStatus = "–¢–æ—Ä–≥–æ–≤–ª—è: ";
    color statusColor = clrLime;

    if (!g_GlobalState.allowNewTrades || g_GlobalState.dailyTPReached || g_GlobalState.dailySLReached ||
        g_GlobalState.weeklyTPReached || g_GlobalState.weeklySLReached)
    {
        tradeStatus += "–ó–ê–ü–†–ï–©–ï–ù–ê";
        statusColor = clrRed;
    }
    else
    {
        tradeStatus += "–†–ê–ó–†–ï–®–ï–ù–ê";
    }

    ObjectSetString(0, "RiskManager_Panel_TradeStatus", OBJPROP_TEXT, tradeStatus);
    ObjectSetInteger(0, "RiskManager_Panel_TradeStatus", OBJPROP_COLOR, statusColor);

    //--- –î–Ω–µ–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ (–í–°–ï —Ç–æ—Ä–≥–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)
    string dailyTradesText = "–î–Ω–µ–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏: " + IntegerToString(g_GlobalState.dailyTradesCount) +
                             "/" + IntegerToString(MaxDailyTrades);
    ObjectSetString(0, "RiskManager_Panel_DailyTrades", OBJPROP_TEXT, dailyTradesText);

    //--- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–µ–π—á–∞—Å)
    int simultaneousPositions = PositionsTotal();
    string simultaneousText = "–û–¥–Ω–æ–≤—Ä. –ø–æ–∑–∏—Ü–∏–∏: " + IntegerToString(simultaneousPositions) +
                              "/" + IntegerToString(MaxSimultaneousPositions);
    color simultaneousColor = (simultaneousPositions < MaxSimultaneousPositions) ? clrWhite : clrRed;
    ObjectSetString(0, "RiskManager_Panel_Simultaneous", OBJPROP_TEXT, simultaneousText);
    ObjectSetInteger(0, "RiskManager_Panel_Simultaneous", OBJPROP_COLOR, simultaneousColor);

    //--- –†–∏—Å–∫
    string riskText = "–¢–µ–∫—É—â–∏–π —Ä–∏—Å–∫: " + DoubleToString(g_GlobalState.currentRiskPercent, 1) + "%";
    ObjectSetString(0, "RiskManager_Panel_Risk", OBJPROP_TEXT, riskText);

    //--- –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è)
    string positionsText = "–û—Ç–∫—Ä—ã—Ç–æ –ø–æ–∑–∏—Ü–∏–π: " + IntegerToString(simultaneousPositions);
    ObjectSetString(0, "RiskManager_Panel_OpenPositions", OBJPROP_TEXT, positionsText);

    //--- –í—Ä–µ–º—è
    string timeText = "–û–±–Ω–æ–≤–ª–µ–Ω–æ: " + TimeToString(TimeCurrent(), TIME_SECONDS);
    ObjectSetString(0, "RiskManager_Panel_Time", OBJPROP_TEXT, timeText);
}

//+------------------------------------------------------------------+
//| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ                                |
//+------------------------------------------------------------------+
void UpdateChartComment()
{
    string comment = RiskManagerName + " v" + CORE_VERSION + "\n";
    comment += "================================\n";

    //--- –°—Ç–∞—Ç—É—Å
    if (g_GlobalState.dailyTPReached)
        comment += "–°–¢–ê–¢–£–°: –î–ù–ï–í–ù–û–ô TP –î–û–°–¢–ò–ì–ù–£–¢\n";
    else if (g_GlobalState.dailySLReached)
        comment += "–°–¢–ê–¢–£–°: –î–ù–ï–í–ù–û–ô SL –î–û–°–¢–ò–ì–ù–£–¢\n";
    else if (g_GlobalState.weeklyTPReached)
        comment += "–°–¢–ê–¢–£–°: –ù–ï–î–ï–õ–¨–ù–´–ô TP –î–û–°–¢–ò–ì–ù–£–¢\n";
    else if (g_GlobalState.weeklySLReached)
        comment += "–°–¢–ê–¢–£–°: –ù–ï–î–ï–õ–¨–ù–´–ô SL –î–û–°–¢–ò–ì–ù–£–¢\n";
    else if (!g_GlobalState.allowNewTrades)
        comment += "–°–¢–ê–¢–£–°: –¢–û–†–ì–û–í–õ–Ø –ó–ê–ü–†–ï–©–ï–ù–ê\n";
    else
        comment += "–°–¢–ê–¢–£–°: –ê–ö–¢–ò–í–ï–ù\n";

    comment += "================================\n";

    //--- PnL
    comment += "–î–Ω–µ–≤–Ω–æ–π PnL: $" + DoubleToString(g_GlobalState.dailyPnLTotal, 2) + "\n";
    comment += "–ù–µ–¥–µ–ª—å–Ω—ã–π PnL: $" + DoubleToString(g_GlobalState.weeklyPnLTotal, 2) + "\n";
    comment += "–ú–∞–∫—Å. –¥–Ω–µ–≤–Ω–æ–π PnL: $" + DoubleToString(g_GlobalState.maxDailyPnL, 2) + "\n";

    comment += "--------------------------------\n";

    //--- –°—á–µ—Ç—á–∏–∫–∏
    comment += "–î–Ω–µ–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: " + IntegerToString(g_GlobalState.dailyPositionsCount) +
               "/" + IntegerToString(MaxDailyTrades) + "\n";
    comment += "–ù–µ–¥–µ–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫: " + IntegerToString(g_GlobalState.weeklyPositionsCount) +
               "/" + IntegerToString(MaxWeeklyTrades) + "\n";
    comment += "–û—Ç–∫—Ä—ã—Ç–æ —Å–µ–π—á–∞—Å: " + IntegerToString(PositionsTotal()) + "\n";

    comment += "--------------------------------\n";

    //--- –†–∏—Å–∫
    comment += "–¢–µ–∫—É—â–∏–π —Ä–∏—Å–∫: " + DoubleToString(g_GlobalState.currentRiskPercent, 1) + "%\n";
    comment += "–°–µ—Ä–∏—è —É–±—ã—Ç–∫–æ–≤: " + IntegerToString(g_GlobalState.lossStreak) + "\n";
    comment += "–°–µ—Ä–∏—è –ø—Ä–∏–±—ã–ª–µ–π: " + IntegerToString(g_GlobalState.profitStreak) + "\n";

    comment += "--------------------------------\n";

    //--- –õ–∏–º–∏—Ç—ã
    comment += "–î–Ω–µ–≤–Ω–æ–π TP: $" + DoubleToString(DailyTakeProfit, 0) + "\n";
    comment += "–î–Ω–µ–≤–Ω–æ–π SL: $" + DoubleToString(DailyStopLoss, 0) + "\n";
    comment += "–ù–µ–¥–µ–ª—å–Ω—ã–π TP: $" + DoubleToString(WeeklyTakeProfit, 0) + "\n";
    comment += "–ù–µ–¥–µ–ª—å–Ω—ã–π SL: $" + DoubleToString(WeeklyStopLoss, 0);

    Comment(comment);
}

//+------------------------------------------------------------------+
//| –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π                                      |
//+------------------------------------------------------------------+
void OnTrade()
{
    //--- –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏
    g_LastTradeExecutionTime = TimeCurrent();

    //--- –ü—Ä–∏ —Ç–æ—Ä–≥–æ–≤–æ–º —Å–æ–±—ã—Ç–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
    RiskManager_UpdateClosedPnLCounters();

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã
    CheckRiskLimits();

    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    Core_SaveGlobalState();
}

//+------------------------------------------------------------------+
//| –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π (–¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤)                        |
//+------------------------------------------------------------------+
void OnChartEvent(const int id, const long &lparam, const double &dparam, const string &sparam)
{
    //--- –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –∏–∑ —á–∞—Ç–∞ –≥—Ä–∞—Ñ–∏–∫–∞
    if (id == CHARTEVENT_OBJECT_CREATE && StringFind(sparam, "Command_") >= 0)
    {
        if (EnableExternalSignals)
        {
            RiskManager_ProcessExternalSignal(sparam);
        }
    }

    // –í —Ñ—É–Ω–∫—Ü–∏–∏ OnChartEvent() –¥–æ–±–∞–≤–∏—Ç—å:
    if (id == CHARTEVENT_OBJECT_CLICK)
    {
        if (sparam == "ShowWhiteListBtn")
        {
            PrintWhiteList();
            Alert("–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –≤—ã–≤–µ–¥–µ–Ω –≤ –∂—É—Ä–Ω–∞–ª");
        }
        else if (sparam == "AddCurrentSymbolBtn")
        {
            if (AddToWhiteList(Symbol(), true, 0, 0, "–î–æ–±–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é"))
            {
                Alert("–°–∏–º–≤–æ–ª " + Symbol() + " –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫!");
            }
        }
        if (sparam == "TestLockBtn")
        {
            if (MessageBox("–¢–µ—Å—Ç: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É?",
                           "–¢–µ—Å—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏", MB_YESNO | MB_ICONQUESTION) == IDYES)
            {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
                g_GlobalState.dailySLReached = true;
                g_GlobalState.allowNewTrades = false;
                SetGlobalTradeLock(2, "–¢–µ—Å—Ç–æ–≤–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞");
                ForceCloseAllPositionsInstantly();
                Alert("‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!");
            }
        }
        else if (sparam == "TestUnlockBtn")
        {
            if (MessageBox("–¢–µ—Å—Ç: –°–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É?",
                           "–¢–µ—Å—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏", MB_YESNO | MB_ICONQUESTION) == IDYES)
            {
                RemoveGlobalTradeLock();
                g_GlobalState.dailySLReached = false;
                g_GlobalState.allowNewTrades = true;
                Alert("‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞!");
            }
        }
    }

    // –í —Ñ—É–Ω–∫—Ü–∏—é OnChartEvent() –¥–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É:
    else if (sparam == "ClearOldLockBtn")
    {
        if (MessageBox("–°–Ω—è—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É? (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ—Ç—Å—è —É—Ç—Ä–æ–º)",
                       "–°–Ω—è—Ç–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏", MB_YESNO | MB_ICONQUESTION) == IDYES)
        {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞—Ä–µ–ª–∞ –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
            if (FileIsExist("SIDEZ/TradeLock.bin", FILE_COMMON))
            {
                int handle = FileOpen("SIDEZ/TradeLock.bin", FILE_READ | FILE_BIN | FILE_COMMON);
                if (handle != INVALID_HANDLE)
                {
                    datetime lockTime = (datetime)FileReadLong(handle);
                    FileClose(handle);

                    Print("–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ", TimeToString(lockTime));

                    RemoveGlobalTradeLock();
                    g_GlobalState.dailyTPReached = false;
                    g_GlobalState.dailySLReached = false;
                    g_GlobalState.weeklyTPReached = false;
                    g_GlobalState.weeklySLReached = false;
                    g_GlobalState.allowNewTrades = true;
                    g_GlobalState.blockManualTrading = false;

                    Alert("‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞! –¢–æ—Ä–≥–æ–≤–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞.");
                }
            }
        }
    }

    //--- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –ø–∞–Ω–µ–ª–∏
    if (id == CHARTEVENT_OBJECT_CLICK)
    {
        //--- –ü—Ä–∏–º–µ—Ä: –∫–Ω–æ–ø–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
        if (sparam == "RiskManager_CloseAllBtn")
        {
            if (MessageBox("–ó–∞–∫—Ä—ã—Ç—å –í–°–ï –ø–æ–∑–∏—Ü–∏–∏?", "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", MB_YESNO | MB_ICONQUESTION) == IDYES)
            {
                g_ForceCloseAll = true;
                Alert("–ó–∞–ø—É—â–µ–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π!");
            }
        }
    }
    else if (sparam == "DebugLockBtn")
    {
        DebugTradeLockStatus();
        Alert("–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, —Å–º–æ—Ç—Ä–∏—Ç–µ –∂—É—Ä–Ω–∞–ª");
    }
}

//+------------------------------------------------------------------+
//| Expert deinitialization function                                 |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
{
    Print("RiskManager –¥–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è. –ü—Ä–∏—á–∏–Ω–∞: ", reason);

    //--- –°–ò–ù–•–†–û–ù–ò–ó–ò–†–£–ï–ú –ë–ï–õ–´–ô –°–ü–ò–°–û–ö –ü–ï–†–ï–î –í–´–•–û–î–û–ú
    if (g_GlobalState.useWhiteList)
    {
        SyncWhiteListBetweenModules();
    }

    //--- –û—Ç–∫–ª—é—á–∞–µ–º —Ç–∞–π–º–µ—Ä
    EventKillTimer();

    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
    Core_SaveGlobalState();

    //--- –£–¥–∞–ª—è–µ–º –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã
    ObjectDelete(0, "RiskManager_Panel_BG");
    ObjectDelete(0, "RiskManager_Panel_Title");
    ObjectDelete(0, "RiskManager_Panel_DailyPnL");
    ObjectDelete(0, "RiskManager_Panel_WeeklyPnL");
    ObjectDelete(0, "RiskManager_Panel_TradeStatus");
    ObjectDelete(0, "RiskManager_Panel_DailyTrades");
    ObjectDelete(0, "RiskManager_Panel_Risk");
    ObjectDelete(0, "RiskManager_Panel_OpenPositions");
    ObjectDelete(0, "RiskManager_Panel_Time");

    //--- –û—á–∏—â–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    Comment("");
}

//+------------------------------------------------------------------+
//| –°–±—Ä–æ—Å –≤—Å–µ—Ö –ª–∏–º–∏—Ç–æ–≤                                               |
//+------------------------------------------------------------------+
void RiskManager_ResetAllLimits()
{
    g_GlobalState.dailyTPReached = false;
    g_GlobalState.dailySLReached = false;
    g_GlobalState.weeklyTPReached = false;
    g_GlobalState.weeklySLReached = false;
    g_GlobalState.allowNewTrades = true;
    g_GlobalState.dailyPositionsCount = 0;
    g_GlobalState.weeklyPositionsCount = 0;
    g_GlobalState.dailyPnLStart = RiskManager_CalculateTotalPnL(true, false);
    g_GlobalState.weeklyPnLStart = RiskManager_CalculateTotalPnL(false, false);
    g_GlobalState.dailyPnLTotal = 0;
    g_GlobalState.weeklyPnLTotal = 0;
    g_GlobalState.totalClosedProfitToday = 0;
    g_GlobalState.totalClosedLossToday = 0;
    g_GlobalState.totalClosedProfitWeek = 0;
    g_GlobalState.totalClosedLossWeek = 0;

    Print("–í—Å–µ –ª–∏–º–∏—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã!");
    Core_SaveGlobalState();
}

//+------------------------------------------------------------------+
//| –ú–û–ù–ò–¢–û–† –ù–ï–ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–´–• –°–î–ï–õ–û–ö (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)          |
//+------------------------------------------------------------------+
//+------------------------------------------------------------------+
//| –ú–û–ù–ò–¢–û–† –ù–ï–ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–´–• –°–î–ï–õ–û–ö (–ò–ù–°–¢–†–£–ú–ï–ù–¢-–¶–ï–ù–¢–†–ò–ß–ù–ê–Ø –õ–û–ì–ò–ö–ê) |
//+------------------------------------------------------------------+
void MonitorUnauthorizedTrades()
{
    if (!RM_EnableTradeGateway && BlockNonGatewayTrades)
        return;

    int closedCount = 0;

    for (int i = PositionsTotal() - 1; i >= 0; i--)
    {
        ulong ticket = PositionGetTicket(i);
        if (PositionSelectByTicket(ticket))
        {
            string symbol = PositionGetString(POSITION_SYMBOL);
            long magic = PositionGetInteger(POSITION_MAGIC);

            bool shouldClose = false;
            string reason = "";

            // 1. –ü–†–ò–û–†–ò–¢–ï–¢: –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)
            if (g_GlobalState.useWhiteList && !IsInstrumentAllowed(symbol))
            {
                shouldClose = true;
                reason = "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç '" + symbol + "' –Ω–µ –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ";
            }
            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä—É—á–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ (–µ—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è —Ä—É—á–Ω–∞—è)
            else if (magic == 0 && g_GlobalState.blockManualTrading)
            {
                shouldClose = true;
                reason = "–†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã –ª–∏–º–∏—Ç—ã)";
            }
            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–≥–∏—Ö —Å–æ–≤–µ—Ç–Ω–∏–∫–æ–≤ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
            else if (g_GlobalState.blockOtherExperts && magic != 0 &&
                     magic != MAGIC_RISK_MANAGER && magic != MAGIC_POSITION_MANAGER)
            {
                shouldClose = true;
                reason = "–¢–æ—Ä–≥–æ–≤–ª—è –¥—Ä—É–≥–∏–º–∏ —Å–æ–≤–µ—Ç–Ω–∏–∫–∞–º–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–∞";
            }

            if (shouldClose)
            {
                Print("‚ö† –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è #", ticket,
                      " —Å–∏–º–≤–æ–ª: ", symbol, " –º–∞–≥–∏–∫: ", magic, " –ø—Ä–∏—á–∏–Ω–∞: ", reason);

                Print("üö® –ó–∞–∫—Ä—ã—Ç–∏–µ –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏");
                ClosePositionImmediately(ticket, reason);
                closedCount++;
            }
        }
    }

    if (closedCount > 0)
    {
        Print("‚úÖ –ó–∞–∫—Ä—ã—Ç–æ ", closedCount, " –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π");
    }
}

//+------------------------------------------------------------------+
//| –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –®–õ–Æ–ó–ê                              |
//+------------------------------------------------------------------+

//--- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
void CreateTestButtons()
{
    // –ö–Ω–æ–ø–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    ObjectCreate(0, "TestLockBtn", OBJ_BUTTON, 0, 0, 0);
    ObjectSetString(0, "TestLockBtn", OBJPROP_TEXT, "–¢–µ—Å—Ç: –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å");
    ObjectSetInteger(0, "TestLockBtn", OBJPROP_XDISTANCE, 320);
    ObjectSetInteger(0, "TestLockBtn", OBJPROP_YDISTANCE, 30);
    ObjectSetInteger(0, "TestLockBtn", OBJPROP_XSIZE, 120);
    ObjectSetInteger(0, "TestLockBtn", OBJPROP_YSIZE, 20);
    ObjectSetInteger(0, "TestLockBtn", OBJPROP_COLOR, clrWhite);
    ObjectSetInteger(0, "TestLockBtn", OBJPROP_BGCOLOR, clrRed);

    // –ö–Ω–æ–ø–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    ObjectCreate(0, "TestUnlockBtn", OBJ_BUTTON, 0, 0, 0);
    ObjectSetString(0, "TestUnlockBtn", OBJPROP_TEXT, "–¢–µ—Å—Ç: –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å");
    ObjectSetInteger(0, "TestUnlockBtn", OBJPROP_XDISTANCE, 320);
    ObjectSetInteger(0, "TestUnlockBtn", OBJPROP_YDISTANCE, 55);
    ObjectSetInteger(0, "TestUnlockBtn", OBJPROP_XSIZE, 120);
    ObjectSetInteger(0, "TestUnlockBtn", OBJPROP_YSIZE, 20);
    ObjectSetInteger(0, "TestUnlockBtn", OBJPROP_COLOR, clrWhite);
    ObjectSetInteger(0, "TestUnlockBtn", OBJPROP_BGCOLOR, clrGreen);

    // –ö–Ω–æ–ø–∫–∞ —Å–Ω—è—Ç–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    ObjectCreate(0, "ClearOldLockBtn", OBJ_BUTTON, 0, 0, 0);
    ObjectSetString(0, "ClearOldLockBtn", OBJPROP_TEXT, "–°–Ω—è—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É");
    ObjectSetInteger(0, "ClearOldLockBtn", OBJPROP_XDISTANCE, 320);
    ObjectSetInteger(0, "ClearOldLockBtn", OBJPROP_YDISTANCE, 80);
    ObjectSetInteger(0, "ClearOldLockBtn", OBJPROP_XSIZE, 150);
    ObjectSetInteger(0, "ClearOldLockBtn", OBJPROP_YSIZE, 20);
    ObjectSetInteger(0, "ClearOldLockBtn", OBJPROP_COLOR, clrWhite);
    ObjectSetInteger(0, "ClearOldLockBtn", OBJPROP_BGCOLOR, clrOrange);

    // –ö–Ω–æ–ø–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    ObjectCreate(0, "DebugLockBtn", OBJ_BUTTON, 0, 0, 0);
    ObjectSetString(0, "DebugLockBtn", OBJPROP_TEXT, "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏");
    ObjectSetInteger(0, "DebugLockBtn", OBJPROP_XDISTANCE, 320);
    ObjectSetInteger(0, "DebugLockBtn", OBJPROP_YDISTANCE, 130);
    ObjectSetInteger(0, "DebugLockBtn", OBJPROP_XSIZE, 150);
    ObjectSetInteger(0, "DebugLockBtn", OBJPROP_YSIZE, 20);
    ObjectSetInteger(0, "DebugLockBtn", OBJPROP_COLOR, clrWhite);
    ObjectSetInteger(0, "DebugLockBtn", OBJPROP_BGCOLOR, clrPurple);
}

//+------------------------------------------------------------------+
//| –ö–ù–û–ü–ö–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ë–ï–õ–´–ú –°–ü–ò–°–ö–û–ú                            |
//+------------------------------------------------------------------+
void CreateWhiteListButtons()
{
    // –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
    ObjectCreate(0, "ShowWhiteListBtn", OBJ_BUTTON, 0, 0, 0);
    ObjectSetString(0, "ShowWhiteListBtn", OBJPROP_TEXT, "–ü–æ–∫–∞–∑–∞—Ç—å –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫");
    ObjectSetInteger(0, "ShowWhiteListBtn", OBJPROP_XDISTANCE, 320);
    ObjectSetInteger(0, "ShowWhiteListBtn", OBJPROP_YDISTANCE, 80);
    ObjectSetInteger(0, "ShowWhiteListBtn", OBJPROP_XSIZE, 120);
    ObjectSetInteger(0, "ShowWhiteListBtn", OBJPROP_YSIZE, 20);
    ObjectSetInteger(0, "ShowWhiteListBtn", OBJPROP_COLOR, clrWhite);
    ObjectSetInteger(0, "ShowWhiteListBtn", OBJPROP_BGCOLOR, clrBlue);

    // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–∏–º–≤–æ–ª–∞
    ObjectCreate(0, "AddCurrentSymbolBtn", OBJ_BUTTON, 0, 0, 0);
    ObjectSetString(0, "AddCurrentSymbolBtn", OBJPROP_TEXT, "–î–æ–±–∞–≤–∏—Ç—å " + Symbol());
    ObjectSetInteger(0, "AddCurrentSymbolBtn", OBJPROP_XDISTANCE, 320);
    ObjectSetInteger(0, "AddCurrentSymbolBtn", OBJPROP_YDISTANCE, 105);
    ObjectSetInteger(0, "AddCurrentSymbolBtn", OBJPROP_XSIZE, 120);
    ObjectSetInteger(0, "AddCurrentSymbolBtn", OBJPROP_YSIZE, 20);
    ObjectSetInteger(0, "AddCurrentSymbolBtn", OBJPROP_COLOR, clrWhite);
    ObjectSetInteger(0, "AddCurrentSymbolBtn", OBJPROP_BGCOLOR, clrGreen);
}

//+------------------------------------------------------------------+

//+------------------------------------------------------------------+
//|                                                     SIDEZ_CoreLib.mqh |
//|                              Copyright ¬© 2025, SIDEZ LLC          |
//|                                             https://www.sidez.ru |
//+------------------------------------------------------------------+
#property copyright "Copyright ¬© 2025, SIDEZ LLC"
#property link "https://www.sidez.ru"
#property version "1.0"
#property description "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–≤–µ—Ç–Ω–∏–∫–æ–≤"
#property strict

//--- –í–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ MT5
#include <Trade\Trade.mqh>
#include <Trade\PositionInfo.mqh>
#include <Trade\OrderInfo.mqh>
#include <Trade\AccountInfo.mqh>
#include <Trade\SymbolInfo.mqh>
#include <Arrays\ArrayObj.mqh>
#include <Files\FileBin.mqh>
#include <Math\Stat\Math.mqh>

//+------------------------------------------------------------------+
//|                         –ö–û–ù–°–¢–ê–ù–¢–´ –°–ò–°–¢–ï–ú–´                        |
//+------------------------------------------------------------------+
#define CORE_VERSION "1.0.2025"
#define SHARED_STATE_FILE "SIDEZ/GlobalState.bin"
#define INSTRUMENT_CONFIG_FILE "SIDEZ/InstrumentConfig.bin"

//--- –ú–∞–≥–∏—á–µ—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
#define MAGIC_RISK_MANAGER 10001001
#define MAGIC_POSITION_MANAGER 20002002

//+------------------------------------------------------------------+
//|                    –û–°–ù–û–í–ù–´–ï –°–¢–†–£–ö–¢–£–†–´ –î–ê–ù–ù–´–•                     |
//+------------------------------------------------------------------+

//--- –†–µ–∂–∏–º—ã –±–µ–∑—É–±—ã—Ç–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ Position Manager)
enum ENUM_BREAKEVEN_MODE
{
    BE_MODE_NONE = 0,         // –ë–µ–∑ –±–µ–∑—É–±—ã—Ç–∫–∞
    BE_MODE_FIXED_MONEY = 1,  // –§–∏–∫—Å. —Å—É–º–º–∞ –≤ $
    BE_MODE_FIXED_PIPS = 2,   // –§–∏–∫—Å. –ø—É–Ω–∫—Ç—ã
    BE_MODE_PERCENT_TO_TP = 3 // % –ø—É—Ç–∏ –∫ TP
};

//--- –†–µ–∂–∏–º—ã Stop Loss (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–æ –≤—Å–µ–º –∫–æ–¥–µ)
enum ENUM_SL_MODE
{
    SL_NONE = 0,
    SL_MONEY = 1,
    SL_PIPS = 2,
    SL_PERCENT = 3,
    SL_ATR = 4
};

//--- –†–µ–∂–∏–º—ã Take Profit (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–æ –≤—Å–µ–º –∫–æ–¥–µ)
enum ENUM_TP_MODE
{
    TP_NONE = 0,
    TP_MONEY = 1,
    TP_PIPS = 2,
    TP_PERCENT = 3,
    TP_ATR = 4,
    TP_RR = 5
};

//--- –†–µ–∂–∏–º—ã Trailing Stop (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–æ –≤—Å–µ–º –∫–æ–¥–µ)
enum ENUM_TS_MODE
{
    TS_NONE = 0,
    TS_FIXED = 1,
    TS_ATR = 2,
    TS_PERCENT = 3
};

//--- –£—Ä–æ–≤–µ–Ω—å —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
struct SPartialCloseLevel
{
    bool enabled;                      // –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ —É—Ä–æ–≤–µ–Ω—å
    double triggerPercent;             // % –æ—Ç TP –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    double closePercent;               // % –ø–æ–∑–∏—Ü–∏–∏ –∫ –∑–∞–∫—Ä—ã—Ç–∏—é
    ENUM_BREAKEVEN_MODE breakevenMode; // –†–µ–∂–∏–º –±–µ–∑—É–±—ã—Ç–∫–∞
    double breakevenValue;             // –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞
    bool executed;                     // –£–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
    datetime executionTime;            // –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
};

//--- –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (RiskManager)
struct SAllowedInstrument
{
    string symbol;         // –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "EURUSD", "XAUUSD")
    bool enabled;          // –†–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
    double maxVolume;      // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    double maxRiskPercent; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ % –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    string comment;        // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–û—Å–Ω–æ–≤–Ω–∞—è –ø–∞—Ä–∞", "–•–µ–¥–∂–∏—Ä–æ–≤–∞–Ω–∏–µ")
};

#define MAX_ALLOWED_INSTRUMENTS 10 // –ú–∞–∫—Å–∏–º—É–º —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

//--- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (Position Manager)
struct SInstrumentConfig
{
    //--- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    string symbol;
    double contractSize;
    double tickValue;
    double tickSize;
    double point;
    double minLot;
    double lotStep;
    double maxPositionVolume;
    bool enabled;

    //--- –°—Ç–æ–ø-–ª–æ—Å—Å –∏ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç
    ENUM_SL_MODE slMode;
    ENUM_TP_MODE tpMode;
    double slValue;
    double tpValue;
    double atrMultiplierSL;
    double atrMultiplierTP;
    int atrPeriod;
    ENUM_TIMEFRAMES atrTimeframe;
    double rrRatio;

    //--- –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–¥–æ 5 —É—Ä–æ–≤–Ω–µ–π)
    SPartialCloseLevel partialLevels[5];
    int partialLevelsCount;

    //--- –¢—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø
    ENUM_TS_MODE tsMode;
    double tsStartProfit;
    double tsStep;
    double tsLockProfit;

    //--- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
    double currentVolume;
    double currentSL;
    double currentTP;
    double bestPrice;
    datetime positionOpenTime;
    bool positionActive;
    double calculatedTPPrice;
    double tpDistancePips;

    //--- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è —É—á–µ—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
    double originalSL; // –ò—Å—Ö–æ–¥–Ω—ã–π SL –¥–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ RiskManager
    double originalTP; // –ò—Å—Ö–æ–¥–Ω—ã–π TP –¥–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ RiskManager
};

//--- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—á–µ—Ç–∞ (RiskManager)
struct SGlobalState
{
    //--- –§–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    bool dailyTPReached;
    bool dailySLReached;
    bool weeklyTPReached;
    bool weeklySLReached;
    bool allowNewTrades;
    bool emergencyStop;

    //--- –°—á–µ—Ç—á–∏–∫–∏
    int dailyPositionsCount;
    int weeklyPositionsCount;
    int dailyPositionsLimit;
    int weeklyPositionsLimit;

    //--- –°—á–µ—Ç—á–∏–∫–∏ —Å–¥–µ–ª–æ–∫ (–æ—Ç–∫—Ä—ã—Ç—ã—Ö + –∑–∞–∫—Ä—ã—Ç—ã—Ö)
    int dailyTradesCount;  // –í—Å–µ —Å–¥–µ–ª–∫–∏ –∑–∞ –¥–µ–Ω—å
    int weeklyTradesCount; // –í—Å–µ —Å–¥–µ–ª–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é
    int dailyTradesLimit;  // –õ–∏–º–∏—Ç —Å–¥–µ–ª–æ–∫ –≤ –¥–µ–Ω—å
    int weeklyTradesLimit; // –õ–∏–º–∏—Ç —Å–¥–µ–ª–æ–∫ –≤ –Ω–µ–¥–µ–ª—é

    //--- –õ–∏–º–∏—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π
    int maxSimultaneousPositionsDaily;  // –ú–∞–∫—Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π (–¥–µ–Ω—å)
    int maxSimultaneousPositionsWeekly; // –ú–∞–∫—Å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π (–Ω–µ–¥–µ–ª—è)

    //--- –ü—Ä–∏–±—ã–ª—å/—É–±—ã—Ç–æ–∫ (–ò–°–ü–†–ê–í–õ–ï–ù–û: —Ö—Ä–∞–Ω–∏–º –ß–ò–°–¢–´–ô PnL)
    double dailyPnLTotal;  // –ß–∏—Å—Ç—ã–π –¥–Ω–µ–≤–Ω–æ–π PnL (–≤—Å–µ –∑–∞–∫—Ä—ã—Ç—ã–µ + –æ—Ç–∫—Ä—ã—Ç—ã–µ)
    double weeklyPnLTotal; // –ß–∏—Å—Ç—ã–π –Ω–µ–¥–µ–ª—å–Ω—ã–π PnL (–≤—Å–µ –∑–∞–∫—Ä—ã—Ç—ã–µ + –æ—Ç–∫—Ä—ã—Ç—ã–µ)
    double dailyPnLStart;  // –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —á–∏—Å—Ç–æ–≥–æ PnL
    double weeklyPnLStart; // –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ PnL
    double maxDailyPnL;    // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π –¥–Ω–µ–≤–Ω–æ–π PnL
    double maxWeeklyPnL;   // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π –Ω–µ–¥–µ–ª—å–Ω—ã–π PnL

    //--- –õ–∏–º–∏—Ç—ã —Ä–∏—Å–∫–æ–≤
    double dailyTakeProfit;  // –î–Ω–µ–≤–Ω–æ–π TP ($)
    double dailyStopLoss;    // –î–Ω–µ–≤–Ω–æ–π SL ($)
    double weeklyTakeProfit; // –ù–µ–¥–µ–ª—å–Ω—ã–π TP ($)
    double weeklyStopLoss;   // –ù–µ–¥–µ–ª—å–Ω—ã–π SL ($)

    //--- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    datetime lastDailyReset;
    datetime lastWeeklyReset;
    datetime riskManagerStartTime;
    datetime lastTradeTime;

    //--- –†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç
    double currentRiskPercent;
    int lossStreak;
    int profitStreak;
    double maxRiskPerTrade; // –ú–∞–∫—Å —Ä–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (%)

    //--- –ó–∞–∫—Ä—ã—Ç—ã–µ PnL
    double totalClosedProfitToday; // –°—É–º–º–∞—Ä–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –æ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫ —Å–µ–≥–æ–¥–Ω—è
    double totalClosedLossToday;   // –°—É–º–º–∞—Ä–Ω—ã–π —É–±—ã—Ç–æ–∫ –æ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫ —Å–µ–≥–æ–¥–Ω—è
    double totalClosedProfitWeek;  // –°—É–º–º–∞—Ä–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –æ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫ –∑–∞ –Ω–µ–¥–µ–ª—é
    double totalClosedLossWeek;    // –°—É–º–º–∞—Ä–Ω—ã–π —É–±—ã—Ç–æ–∫ –æ—Ç –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫ –∑–∞ –Ω–µ–¥–µ–ª—é

    //--- –ë–ï–õ–´–ô –°–ü–ò–°–û–ö –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í (–ù–û–í–û–ï!)
    SAllowedInstrument allowedInstruments[MAX_ALLOWED_INSTRUMENTS]; // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    int allowedInstrumentsCount;                                    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    bool useWhiteList;                                              // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫
    bool blockManualTrading;                                        // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä—É—á–Ω—É—é —Ç–æ—Ä–≥–æ–≤–ª—é
    bool blockOtherExperts;                                         // –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–æ–≤–µ—Ç–Ω–∏–∫–∏
};

//+------------------------------------------------------------------+
//|             –ö–ï–®–ò–†–û–í–ê–ù–ò–ï –°–¢–ê–¢–£–°–ê –ë–õ–û–ö–ò–†–û–í–ö–ò                      |
//+------------------------------------------------------------------+
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
struct SBlockStatusCache
{
    bool lastTradeAllowedStatus;   // –ü–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏
    string lastBlockReason;        // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    datetime lastStatusChangeTime; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    int printCounter;              // –°—á–µ—Ç—á–∏–∫ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ª–æ–≥–æ–≤
};

SBlockStatusCache g_BlockStatusCache;

//+------------------------------------------------------------------+
//|                –ì–õ–û–ë–ê–õ–¨–ù–´–ï –≠–ö–ó–ï–ú–ü–õ–Ø–†–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï                |
//+------------------------------------------------------------------+
SGlobalState g_GlobalState;
SInstrumentConfig g_Config;
CTrade g_Trade;
CPositionInfo g_PositionInfo;
COrderInfo g_OrderInfo;
CTrade g_TradeGateway;
string g_AllowedMagicsArray[];
int g_AllowedMagicsCount = 0;
bool g_HasTelegramSignal = false;
bool BlockNonGatewayTrades = true;
bool EnableTradeGateway = true;                             // –í–∫–ª—é—á–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–π —à–ª—é–∑
string GatewayAllowedMagics = "10001001,20002002,50005000"; // –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –º–∞–≥–∏–∫–∏

//--- –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –∏ –≤–Ω–µ—à–Ω–∏–µ —Å–∏–≥–Ω–∞–ª—ã
#ifndef ENABLE_CORRELATION_CHECK_DEFINED
bool EnableCorrelationCheck = false; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ –≤–∫–ª—é—á–∞—é—â–µ–º —Ñ–∞–π–ª–µ
#endif

#ifndef SIGNAL_COMMAND_PREFIX_DEFINED
string SignalCommandPrefix = "/"; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ –≤–∫–ª—é—á–∞—é—â–µ–º —Ñ–∞–π–ª–µ
#endif

//+------------------------------------------------------------------+
//|             –§–£–ù–ö–¶–ò–ò –†–ê–ë–û–¢–´ –° –§–ê–ô–õ–ê–ú–ò –°–û–°–¢–û–Ø–ù–ò–Ø                   |
//+------------------------------------------------------------------+

//--- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
bool Core_SaveGlobalState()
{
    static datetime lastSaveTime = 0;
    static string lastStateHash = "";

    // –°–æ–∑–¥–∞–µ–º —Ö—ç—à —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    string currentHash = "";

    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–ª–∞–≥–∏
    currentHash += StringFormat("%d%d%d%d%d%d",
                                g_GlobalState.dailyTPReached, g_GlobalState.dailySLReached,
                                g_GlobalState.weeklyTPReached, g_GlobalState.weeklySLReached,
                                g_GlobalState.allowNewTrades, g_GlobalState.emergencyStop);

    // –°—á–µ—Ç—á–∏–∫–∏ –ø–æ–∑–∏—Ü–∏–π –∏ —Å–¥–µ–ª–æ–∫
    currentHash += StringFormat("|P%d%d|T%d%d",
                                g_GlobalState.dailyPositionsCount, g_GlobalState.weeklyPositionsCount,
                                g_GlobalState.dailyTradesCount, g_GlobalState.weeklyTradesCount);

    // PnL –∑–Ω–∞—á–µ–Ω–∏—è (–æ–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –¥–æ 2 –∑–Ω–∞–∫–æ–≤)
    currentHash += StringFormat("|PnL%.0f%.0f",
                                NormalizeDouble(g_GlobalState.dailyPnLTotal, 2),
                                NormalizeDouble(g_GlobalState.weeklyPnLTotal, 2));

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
    currentHash += StringFormat("|WL%d%d%d%d",
                                g_GlobalState.useWhiteList, g_GlobalState.blockManualTrading,
                                g_GlobalState.blockOtherExperts, g_GlobalState.allowedInstrumentsCount);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 5 –º–∏–Ω—É—Ç
    bool shouldLog = (currentHash != lastStateHash) ||
                     (TimeCurrent() - lastSaveTime >= 300); // 5 –º–∏–Ω—É—Ç

    int handle = FileOpen(SHARED_STATE_FILE, FILE_WRITE | FILE_BIN | FILE_COMMON);
    if (handle == INVALID_HANDLE)
    {
        Print("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è: ", GetLastError());
        return false;
    }

    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ü–û–õ–ï –ó–ê –ü–û–õ–ï–ú (–∏–∑-–∑–∞ —Å—Ç—Ä–æ–∫)
    // –ü—Ä–æ—Å—Ç—ã–µ —Ç–∏–ø—ã
    FileWriteLong(handle, g_GlobalState.dailyTPReached);
    FileWriteLong(handle, g_GlobalState.dailySLReached);
    FileWriteLong(handle, g_GlobalState.weeklyTPReached);
    FileWriteLong(handle, g_GlobalState.weeklySLReached);
    FileWriteLong(handle, g_GlobalState.allowNewTrades);
    FileWriteLong(handle, g_GlobalState.emergencyStop);

    FileWriteInteger(handle, g_GlobalState.dailyPositionsCount);
    FileWriteInteger(handle, g_GlobalState.weeklyPositionsCount);
    FileWriteInteger(handle, g_GlobalState.dailyPositionsLimit);
    FileWriteInteger(handle, g_GlobalState.weeklyPositionsLimit);

    FileWriteInteger(handle, g_GlobalState.dailyTradesCount);
    FileWriteInteger(handle, g_GlobalState.weeklyTradesCount);
    FileWriteInteger(handle, g_GlobalState.dailyTradesLimit);
    FileWriteInteger(handle, g_GlobalState.weeklyTradesLimit);

    FileWriteInteger(handle, g_GlobalState.maxSimultaneousPositionsDaily);
    FileWriteInteger(handle, g_GlobalState.maxSimultaneousPositionsWeekly);

    FileWriteDouble(handle, g_GlobalState.dailyPnLTotal);
    FileWriteDouble(handle, g_GlobalState.weeklyPnLTotal);
    FileWriteDouble(handle, g_GlobalState.dailyPnLStart);
    FileWriteDouble(handle, g_GlobalState.weeklyPnLStart);
    FileWriteDouble(handle, g_GlobalState.maxDailyPnL);
    FileWriteDouble(handle, g_GlobalState.maxWeeklyPnL);

    FileWriteDouble(handle, g_GlobalState.dailyTakeProfit);
    FileWriteDouble(handle, g_GlobalState.dailyStopLoss);
    FileWriteDouble(handle, g_GlobalState.weeklyTakeProfit);
    FileWriteDouble(handle, g_GlobalState.weeklyStopLoss);

    FileWriteLong(handle, g_GlobalState.lastDailyReset);
    FileWriteLong(handle, g_GlobalState.lastWeeklyReset);
    FileWriteLong(handle, g_GlobalState.riskManagerStartTime);
    FileWriteLong(handle, g_GlobalState.lastTradeTime);

    FileWriteDouble(handle, g_GlobalState.currentRiskPercent);
    FileWriteInteger(handle, g_GlobalState.lossStreak);
    FileWriteInteger(handle, g_GlobalState.profitStreak);
    FileWriteDouble(handle, g_GlobalState.maxRiskPerTrade);

    FileWriteDouble(handle, g_GlobalState.totalClosedProfitToday);
    FileWriteDouble(handle, g_GlobalState.totalClosedLossToday);
    FileWriteDouble(handle, g_GlobalState.totalClosedProfitWeek);
    FileWriteDouble(handle, g_GlobalState.totalClosedLossWeek);

    //--- –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫
    FileWriteLong(handle, g_GlobalState.useWhiteList);
    FileWriteLong(handle, g_GlobalState.blockManualTrading);
    FileWriteLong(handle, g_GlobalState.blockOtherExperts);
    FileWriteInteger(handle, g_GlobalState.allowedInstrumentsCount);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
    for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
    {
        FileWriteString(handle, g_GlobalState.allowedInstruments[i].symbol);
        FileWriteLong(handle, g_GlobalState.allowedInstruments[i].enabled);
        FileWriteDouble(handle, g_GlobalState.allowedInstruments[i].maxVolume);
        FileWriteDouble(handle, g_GlobalState.allowedInstruments[i].maxRiskPercent);
        FileWriteString(handle, g_GlobalState.allowedInstruments[i].comment);
    }

    FileClose(handle);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ö—ç—à –∏ –≤—Ä–µ–º—è
    lastStateHash = currentHash;
    lastSaveTime = TimeCurrent();

    // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–ª–∏ —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç
    if (shouldLog)
    {
        static int saveCounter = 0;
        saveCounter++;

        Print("–ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ (#", saveCounter,
              ") | –î–Ω–µ–≤–Ω–æ–π PnL: $", DoubleToString(g_GlobalState.dailyPnLTotal, 2),
              " | –ù–µ–¥–µ–ª—å–Ω—ã–π: $", DoubleToString(g_GlobalState.weeklyPnLTotal, 2),
              " | –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫: ", g_GlobalState.allowedInstrumentsCount, " –∏–Ω—Å—Ç—Ä.");
    }

    return true;
}

//--- –ó–∞–≥—Ä—É–∑–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
bool Core_LoadGlobalState()
{
    int handle = FileOpen(SHARED_STATE_FILE, FILE_READ | FILE_BIN | FILE_COMMON);
    if (handle == INVALID_HANDLE)
    {
        //--- –§–∞–π–ª–∞ –Ω–µ—Ç, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        Print("–§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π...");
        Core_InitializeDefaultState();
        return false;
    }

    //--- –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ü–û–õ–ï –ó–ê –ü–û–õ–ï–ú
    // –ü—Ä–æ—Å—Ç—ã–µ —Ç–∏–ø—ã
    g_GlobalState.dailyTPReached = FileReadLong(handle) != 0;
    g_GlobalState.dailySLReached = FileReadLong(handle) != 0;
    g_GlobalState.weeklyTPReached = FileReadLong(handle) != 0;
    g_GlobalState.weeklySLReached = FileReadLong(handle) != 0;
    g_GlobalState.allowNewTrades = FileReadLong(handle) != 0;
    g_GlobalState.emergencyStop = FileReadLong(handle) != 0;

    g_GlobalState.dailyPositionsCount = FileReadInteger(handle);
    g_GlobalState.weeklyPositionsCount = FileReadInteger(handle);
    g_GlobalState.dailyPositionsLimit = FileReadInteger(handle);
    g_GlobalState.weeklyPositionsLimit = FileReadInteger(handle);

    g_GlobalState.dailyTradesCount = FileReadInteger(handle);
    g_GlobalState.weeklyTradesCount = FileReadInteger(handle);
    g_GlobalState.dailyTradesLimit = FileReadInteger(handle);
    g_GlobalState.weeklyTradesLimit = FileReadInteger(handle);

    g_GlobalState.maxSimultaneousPositionsDaily = FileReadInteger(handle);
    g_GlobalState.maxSimultaneousPositionsWeekly = FileReadInteger(handle);

    g_GlobalState.dailyPnLTotal = FileReadDouble(handle);
    g_GlobalState.weeklyPnLTotal = FileReadDouble(handle);
    g_GlobalState.dailyPnLStart = FileReadDouble(handle);
    g_GlobalState.weeklyPnLStart = FileReadDouble(handle);
    g_GlobalState.maxDailyPnL = FileReadDouble(handle);
    g_GlobalState.maxWeeklyPnL = FileReadDouble(handle);

    g_GlobalState.dailyTakeProfit = FileReadDouble(handle);
    g_GlobalState.dailyStopLoss = FileReadDouble(handle);
    g_GlobalState.weeklyTakeProfit = FileReadDouble(handle);
    g_GlobalState.weeklyStopLoss = FileReadDouble(handle);

    g_GlobalState.lastDailyReset = (datetime)FileReadLong(handle);
    g_GlobalState.lastWeeklyReset = (datetime)FileReadLong(handle);
    g_GlobalState.riskManagerStartTime = (datetime)FileReadLong(handle);
    g_GlobalState.lastTradeTime = (datetime)FileReadLong(handle);

    g_GlobalState.currentRiskPercent = FileReadDouble(handle);
    g_GlobalState.lossStreak = FileReadInteger(handle);
    g_GlobalState.profitStreak = FileReadInteger(handle);
    g_GlobalState.maxRiskPerTrade = FileReadDouble(handle);

    g_GlobalState.totalClosedProfitToday = FileReadDouble(handle);
    g_GlobalState.totalClosedLossToday = FileReadDouble(handle);
    g_GlobalState.totalClosedProfitWeek = FileReadDouble(handle);
    g_GlobalState.totalClosedLossWeek = FileReadDouble(handle);

    //--- –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫
    g_GlobalState.useWhiteList = FileReadLong(handle) != 0;
    g_GlobalState.blockManualTrading = FileReadLong(handle) != 0;
    g_GlobalState.blockOtherExperts = FileReadLong(handle) != 0;
    g_GlobalState.allowedInstrumentsCount = FileReadInteger(handle);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–∂–¥—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
    for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
    {
        g_GlobalState.allowedInstruments[i].symbol = FileReadString(handle);
        g_GlobalState.allowedInstruments[i].enabled = FileReadLong(handle) != 0;
        g_GlobalState.allowedInstruments[i].maxVolume = FileReadDouble(handle);
        g_GlobalState.allowedInstruments[i].maxRiskPercent = FileReadDouble(handle);
        g_GlobalState.allowedInstruments[i].comment = FileReadString(handle);
    }

    FileClose(handle);

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –≤—ã–≤–æ–¥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    Print("–ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ | ",
          "–î–Ω–µ–≤–Ω–æ–π PnL: $", DoubleToString(g_GlobalState.dailyPnLTotal, 2),
          " | –ù–µ–¥–µ–ª—å–Ω—ã–π: $", DoubleToString(g_GlobalState.weeklyPnLTotal, 2),
          " | –°–¥–µ–ª–æ–∫ —Å–µ–≥–æ–¥–Ω—è: ", g_GlobalState.dailyTradesCount,
          " | –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫: ", g_GlobalState.allowedInstrumentsCount, " –∏–Ω—Å—Ç—Ä.");

    return true;
}

//--- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
void Core_InitializeDefaultState()
{
    //--- –û–±–Ω—É–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    ZeroMemory(g_GlobalState);

    //--- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    g_GlobalState.allowNewTrades = true;
    g_GlobalState.dailyPositionsLimit = 10;
    g_GlobalState.weeklyPositionsLimit = 50;
    g_GlobalState.currentRiskPercent = 1.0;
    g_GlobalState.maxRiskPerTrade = 2.0;
    g_GlobalState.riskManagerStartTime = TimeCurrent();

    //--- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã —Ä–∏—Å–∫–æ–≤
    g_GlobalState.dailyTakeProfit = 250.0;   // –î–Ω–µ–≤–Ω–æ–π TP –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    g_GlobalState.dailyStopLoss = -100.0;    // –î–Ω–µ–≤–Ω–æ–π SL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    g_GlobalState.weeklyTakeProfit = 1250.0; // –ù–µ–¥–µ–ª—å–Ω—ã–π TP –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    g_GlobalState.weeklyStopLoss = -750.0;   // –ù–µ–¥–µ–ª—å–Ω—ã–π SL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    //--- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫–∏ PnL
    g_GlobalState.dailyPnLStart = RiskManager_CalculateTotalPnL(true, false);
    g_GlobalState.weeklyPnLStart = RiskManager_CalculateTotalPnL(false, false);
    g_GlobalState.dailyPnLTotal = 0;
    g_GlobalState.weeklyPnLTotal = 0;

    //--- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫
    g_GlobalState.useWhiteList = false; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω
    g_GlobalState.blockManualTrading = false;
    g_GlobalState.blockOtherExperts = false;
    g_GlobalState.allowedInstrumentsCount = 0;

    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º
    Core_SaveGlobalState();
    Print("–ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é");
}

//+------------------------------------------------------------------+
//|              –§–£–ù–ö–¶–ò–ò –ë–ï–õ–û–ì–û –°–ü–ò–°–ö–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í                 |
//+------------------------------------------------------------------+

bool IsInstrumentAllowed(string symbol)
{
    // –ï—Å–ª–∏ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –≤—ã–∫–ª—é—á–µ–Ω - –≤—Å—ë —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
    if (!g_GlobalState.useWhiteList)
    {
        // –¢–û–õ–¨–ö–û –î–ï–ë–ê–ì: –≤—ã–≤–æ–¥–∏–º —Ä–∞–∑ –≤ 100 —Ç–∏–∫–æ–≤
        static int debugCounter = 0;
        if (++debugCounter % 100 == 0)
            Print("IsInstrumentAllowed[", symbol, "]: –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –≤—ã–∫–ª—é—á–µ–Ω, —Ä–∞–∑—Ä–µ—à–µ–Ω–æ");
        return true;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Å—Ç–æ–π —Å–∏–º–≤–æ–ª
    if (symbol == "" || symbol == NULL)
    {
        Print("IsInstrumentAllowed: –ü–£–°–¢–û–ô —Å–∏–º–≤–æ–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º false");
        return false;
    }

    // –û–ß–ò–©–ê–ï–ú –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–π —Å–∏–º–≤–æ–ª
    string checkSymbol = symbol;
    StringReplace(checkSymbol, " ", "");
    StringReplace(checkSymbol, "¬†", ""); // –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª
    StringToUpper(checkSymbol);

    if (checkSymbol == "")
    {
        Print("IsInstrumentAllowed: –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —Å–∏–º–≤–æ–ª –ø—É—Å—Ç–æ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º false");
        return false;
    }

    // –î–ï–ë–ê–ì: –≤—ã–≤–æ–¥–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
    static int lastPrintCount = -1;
    static datetime lastPrintTime = 0;

    if (g_GlobalState.allowedInstrumentsCount != lastPrintCount ||
        (TimeCurrent() - lastPrintTime) > 300) // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    {
        Print("IsInstrumentAllowed: –ü—Ä–æ–≤–µ—Ä—è–µ–º ", symbol, " (", checkSymbol, ")",
              " (–≤—Å–µ–≥–æ –≤ —Å–ø–∏—Å–∫–µ: ", g_GlobalState.allowedInstrumentsCount, ")");
        lastPrintCount = g_GlobalState.allowedInstrumentsCount;
        lastPrintTime = TimeCurrent();
    }

    // –í —Ü–∏–∫–ª–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–æ–≤:
    for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
    {
        string allowedSymbol = g_GlobalState.allowedInstruments[i].symbol;

        // –û–ß–ò–©–ê–ï–ú —Å–∏–º–≤–æ–ª –∏–∑ —Å–ø–∏—Å–∫–∞
        StringReplace(allowedSymbol, " ", "");
        StringReplace(allowedSymbol, "¬†", ""); // –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª
        StringToUpper(allowedSymbol);

        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –∑–∞–ø–∏—Å–∏
        if (allowedSymbol == "" || allowedSymbol == " ")
            continue;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        if (allowedSymbol == checkSymbol)
        {
            bool result = g_GlobalState.allowedInstruments[i].enabled;

            // –ö–ï–®–ò–†–û–í–ê–ù–ò–ï –°–¢–ê–¢–£–°–ê - –ª–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            static string lastAllowedSymbol = "";
            static string lastAllowedResult = "";
            static datetime lastAllowedLogTime = 0;

            string currentResultStr = result ? "allowed" : "blocked";
            string cacheKey = checkSymbol + ":" + currentResultStr;

            bool shouldLogAllowed = (cacheKey != (lastAllowedSymbol + ":" + lastAllowedResult)) ||
                                    (TimeCurrent() - lastAllowedLogTime) > 60;

            if (shouldLogAllowed)
            {
                Print("‚úÖ IsInstrumentAllowed[", symbol, " (", checkSymbol, ")]: –ù–ê–ô–î–ï–ù –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ, —Ä–∞–∑—Ä–µ—à–µ–Ω–æ=", result);
                lastAllowedSymbol = checkSymbol;
                lastAllowedResult = currentResultStr;
                lastAllowedLogTime = TimeCurrent();
            }

            return result;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –º–∞—Å–∫–æ–π
        if (StringFind(allowedSymbol, "*") >= 0)
        {
            // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è "*" –≤ –∫–æ–Ω—Ü–µ
            if (StringFind(allowedSymbol, "*") == StringLen(allowedSymbol) - 1)
            {
                string prefix = StringSubstr(allowedSymbol, 0, StringLen(allowedSymbol) - 1);
                if (StringFind(checkSymbol, prefix) == 0) // –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞
                {
                    bool result = g_GlobalState.allowedInstruments[i].enabled;
                    Print("‚úÖ IsInstrumentAllowed[", symbol, " (", checkSymbol, ")]: —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –º–∞—Å–∫–æ–π ", allowedSymbol, ", —Ä–∞–∑—Ä–µ—à–µ–Ω–æ=", result);
                    return result;
                }
            }
        }
    }

    // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ
    // –û–ì–†–ê–ù–ò–ß–ò–í–ê–ï–ú –ß–ê–°–¢–û–¢–£ –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø - –¢–û–õ–¨–ö–û –ü–†–ò –ò–ó–ú–ï–ù–ï–ù–ò–ò –°–¢–ê–¢–£–°–ê
    static string lastBlockedSymbol = "";
    static string lastBlockedStatus = ""; // "blocked" –∏–ª–∏ "allowed"
    static datetime lastBlockedTime = 0;

    string currentStatus = "blocked";

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª—é—á –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    string statusKey = checkSymbol + ":" + currentStatus;

    // –õ–æ–≥–∏—Ä—É–µ–º –µ—Å–ª–∏:
    // 1. –°–º–µ–Ω–∏–ª—Å—è —Å–∏–º–≤–æ–ª
    // 2. –°–º–µ–Ω–∏–ª—Å—è —Å—Ç–∞—Ç—É—Å (–±—ã–ª —Ä–∞–∑—Ä–µ—à–µ–Ω, —Å—Ç–∞–ª –∑–∞–ø—Ä–µ—â–µ–Ω)
    // 3. –ü—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 60 —Å–µ–∫—É–Ω–¥ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ª–æ–≥–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
    bool shouldLog = (statusKey != (lastBlockedSymbol + ":" + lastBlockedStatus)) ||
                     (TimeCurrent() - lastBlockedTime) > 60;

    if (shouldLog)
    {
        Print("‚ùå IsInstrumentAllowed[", symbol, " (", checkSymbol, ")]: –ù–ï –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ. –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞.");

        // –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –±–ª–æ–∫–µ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∏–º–≤–æ–ª–∞)
        if (lastBlockedSymbol != checkSymbol)
        {
            Print("    –í—Å–µ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ: ", g_GlobalState.allowedInstrumentsCount);
            for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
            {
                if (g_GlobalState.allowedInstruments[i].symbol != "")
                {
                    string cleanSym = g_GlobalState.allowedInstruments[i].symbol;
                    StringReplace(cleanSym, " ", "");
                    StringReplace(cleanSym, "¬†", "");
                    Print("    ", i + 1, ". '", g_GlobalState.allowedInstruments[i].symbol,
                          "' -> '", cleanSym, "'");
                }
            }
        }

        lastBlockedSymbol = checkSymbol;
        lastBlockedStatus = currentStatus;
        lastBlockedTime = TimeCurrent();
    }

    return false;
}

//--- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫
bool AddToWhiteList(string symbol, bool enabled = true, double maxVolume = 0,
                    double maxRiskPercent = 0, string comment = "")
{
    // –î–û–ë–ê–í–ò–¢–¨ –û–ß–ò–°–¢–ö–£ –°–ò–ú–í–û–õ–ê
    StringReplace(symbol, " ", "");
    StringReplace(symbol, "¬†", ""); // –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª
    StringToUpper(symbol);

    // –ü–†–û–í–ï–†–ö–ê: –ø—É—Å—Ç–æ–π —Å–∏–º–≤–æ–ª
    if (symbol == "" || symbol == " ")
    {
        Print("–û—à–∏–±–∫–∞: –ø—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–π —Å–∏–º–≤–æ–ª –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫!");
        return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏ –ª–∏–º–∏—Ç
    if (g_GlobalState.allowedInstrumentsCount >= MAX_ALLOWED_INSTRUMENTS)
    {
        Print("–û—à–∏–±–∫–∞: –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (", MAX_ALLOWED_INSTRUMENTS, ")");
        return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
    for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
    {
        string existingSymbol = g_GlobalState.allowedInstruments[i].symbol;
        StringReplace(existingSymbol, " ", "");
        StringReplace(existingSymbol, "¬†", "");
        StringToUpper(existingSymbol);

        if (existingSymbol == symbol)
        {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
            g_GlobalState.allowedInstruments[i].enabled = enabled;
            g_GlobalState.allowedInstruments[i].maxVolume = maxVolume;
            g_GlobalState.allowedInstruments[i].maxRiskPercent = maxRiskPercent;
            g_GlobalState.allowedInstruments[i].comment = comment;
            Print("–û–±–Ω–æ–≤–ª–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ: ", symbol);
            return true;
        }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
    int idx = g_GlobalState.allowedInstrumentsCount;
    g_GlobalState.allowedInstruments[idx].symbol = symbol; // —É–∂–µ –æ—á–∏—â–µ–Ω–Ω—ã–π
    g_GlobalState.allowedInstruments[idx].enabled = enabled;
    g_GlobalState.allowedInstruments[idx].maxVolume = maxVolume;
    g_GlobalState.allowedInstruments[idx].maxRiskPercent = maxRiskPercent;
    g_GlobalState.allowedInstruments[idx].comment = comment;

    g_GlobalState.allowedInstrumentsCount++;

    Print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫: '", symbol,
          "' (–≤—Å–µ–≥–æ: ", g_GlobalState.allowedInstrumentsCount, ")");

    return true;
}

//--- –£–¥–∞–ª–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
bool RemoveFromWhiteList(string symbol)
{
    for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
    {
        if (g_GlobalState.allowedInstruments[i].symbol == symbol)
        {
            // –°–¥–≤–∏–≥–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            for (int j = i; j < g_GlobalState.allowedInstrumentsCount - 1; j++)
            {
                g_GlobalState.allowedInstruments[j] = g_GlobalState.allowedInstruments[j + 1];
            }

            g_GlobalState.allowedInstrumentsCount--;

            // –û—á–∏—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç
            ZeroMemory(g_GlobalState.allowedInstruments[g_GlobalState.allowedInstrumentsCount]);

            Print("–£–¥–∞–ª–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞: ", symbol,
                  " (–æ—Å—Ç–∞–ª–æ—Å—å: ", g_GlobalState.allowedInstrumentsCount, ")");

            Core_SaveGlobalState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            return true;
        }
    }

    Print("–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ: ", symbol);
    return false;
}

//--- –ü–æ–∫–∞–∑–∞—Ç—å –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫
void PrintWhiteList()
{
    if (g_GlobalState.allowedInstrumentsCount == 0)
    {
        Print("–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç");
        return;
    }

    Print("=== –ë–ï–õ–´–ô –°–ü–ò–°–û–ö –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í (", g_GlobalState.allowedInstrumentsCount, ") ===");
    for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—É—Å—Ç–æ–π –ª–∏ —Å–∏–º–≤–æ–ª
        if (g_GlobalState.allowedInstruments[i].symbol == "" ||
            g_GlobalState.allowedInstruments[i].symbol == " ")
        {
            Print(i + 1, ". <–ü–£–°–¢–û–ô –°–ò–ú–í–û–õ> - –£–î–ê–õ–ò–¢–¨!");
            continue;
        }

        Print(i + 1, ". ", g_GlobalState.allowedInstruments[i].symbol,
              " | –í–∫–ª: ", g_GlobalState.allowedInstruments[i].enabled ? "–î–∞" : "–ù–µ—Ç",
              " | –ú–∞–∫—Å. –æ–±—ä–µ–º: ", DoubleToString(g_GlobalState.allowedInstruments[i].maxVolume, 2),
              " | –ú–∞–∫—Å. —Ä–∏—Å–∫: ", DoubleToString(g_GlobalState.allowedInstruments[i].maxRiskPercent, 2), "%",
              " | ", g_GlobalState.allowedInstruments[i].comment);
    }
    Print("========================================");
}

//--- –ó–∞–≥—Ä—É–∑–∏—Ç—å –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ —Å—Ç—Ä–æ–∫–∏ (–¥–ª—è input –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
void LoadWhiteListFromString(string whiteListStr)
{
    if (whiteListStr == "" || whiteListStr == " ")
        return;

    Print("–ó–∞–≥—Ä—É–∑–∫–∞ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏: ", whiteListStr);

    // –û–ß–ò–©–ê–ï–ú —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
    for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
    {
        ZeroMemory(g_GlobalState.allowedInstruments[i]);
    }
    g_GlobalState.allowedInstrumentsCount = 0;

    string symbols[];
    int count = StringSplit(whiteListStr, ',', symbols);

    Print("–ù–∞–π–¥–µ–Ω–æ ", count, " —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ");

    for (int i = 0; i < count; i++)
    {
        string symbol = StringTrim(symbols[i]);

        // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ï –û–ß–ò–©–ï–ù–ò–ï: —É–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã
        StringReplace(symbol, " ", "");
        StringReplace(symbol, " ", ""); // –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª

        if (symbol == "" || symbol == " ")
        {
            Print("–ü—Ä–æ–ø—É—â–µ–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ ", i);
            continue;
        }

        // –ü–†–ò–í–û–î–ò–ú –ö –í–ï–†–•–ù–ï–ú–£ –†–ï–ì–ò–°–¢–†–£ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
        StringToUpper(symbol);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        bool alreadyExists = false;
        for (int j = 0; j < g_GlobalState.allowedInstrumentsCount; j++)
        {
            if (g_GlobalState.allowedInstruments[j].symbol == symbol)
            {
                alreadyExists = true;
                Print("–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ", symbol, " —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç)");
                break;
            }
        }

        if (!alreadyExists)
        {
            AddToWhiteList(symbol, true, 0, 0, "–ò–∑ input –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤");
        }
    }

    Print("–ó–∞–≥—Ä—É–∂–µ–Ω–æ ", g_GlobalState.allowedInstrumentsCount, " —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫");
}

//+------------------------------------------------------------------+
//| –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ë–ï–õ–û–ì–û –°–ü–ò–°–ö–ê –ú–ï–ñ–î–£ –ú–û–î–£–õ–Ø–ú–ò                      |
//+------------------------------------------------------------------+
bool SyncWhiteListBetweenModules()
{
    // –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –æ–±—â–µ–π –ø–∞–ø–∫–µ
    string syncFile = "SIDEZ/WhiteListSync.bin";
    int handle = FileOpen(syncFile, FILE_WRITE | FILE_BIN | FILE_COMMON);

    if (handle == INVALID_HANDLE)
    {
        Print("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞");
        return false;
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –í–°–ï —Å–∏–º–≤–æ–ª—ã —Å –û–ß–ò–°–¢–ö–û–ô
    FileWriteInteger(handle, g_GlobalState.allowedInstrumentsCount);

    for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
    {
        string cleanSymbol = g_GlobalState.allowedInstruments[i].symbol;
        // –ñ–ï–°–¢–ö–ê–Ø –û–ß–ò–°–¢–ö–ê: —É–¥–∞–ª—è–µ–º –í–°–ï –ø—Ä–æ–±–µ–ª—ã –∏ –Ω–µ–ø–µ—á–∞—Ç–∞–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã
        StringReplace(cleanSymbol, " ", "");
        StringReplace(cleanSymbol, "¬†", "");  // –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª
        StringReplace(cleanSymbol, "\t", ""); // —Ç–∞–±—É–ª—è—Ü–∏—è
        StringReplace(cleanSymbol, "\r", ""); // –≤–æ–∑–≤—Ä–∞—Ç –∫–∞—Ä–µ—Ç–∫–∏
        StringReplace(cleanSymbol, "\n", ""); // –ø–µ—Ä–µ–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏
        StringToUpper(cleanSymbol);

        FileWriteString(handle, cleanSymbol);
        FileWriteLong(handle, g_GlobalState.allowedInstruments[i].enabled);
        FileWriteDouble(handle, g_GlobalState.allowedInstruments[i].maxVolume);
        FileWriteDouble(handle, g_GlobalState.allowedInstruments[i].maxRiskPercent);

        // –û—á–∏—â–∞–µ–º –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        string cleanComment = g_GlobalState.allowedInstruments[i].comment;
        StringReplace(cleanComment, "\t", "");
        StringReplace(cleanComment, "\r", "");
        StringReplace(cleanComment, "\n", "");
        FileWriteString(handle, cleanComment);
    }

    FileClose(handle);

    Print("‚úÖ –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏: ",
          g_GlobalState.allowedInstrumentsCount, " –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤");

    return true;
}

bool LoadWhiteListFromSync()
{
    string syncFile = "SIDEZ/WhiteListSync.bin";
    int handle = FileOpen(syncFile, FILE_READ | FILE_BIN | FILE_COMMON);

    if (handle == INVALID_HANDLE)
        return false;

    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
    for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
        ZeroMemory(g_GlobalState.allowedInstruments[i]);
    g_GlobalState.allowedInstrumentsCount = 0;

    // –ß–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    int count = FileReadInteger(handle);
    if (count > MAX_ALLOWED_INSTRUMENTS)
        count = MAX_ALLOWED_INSTRUMENTS;

    for (int i = 0; i < count; i++)
    {
        string symbol = FileReadString(handle);
        bool enabled = FileReadLong(handle) != 0;
        double maxVolume = FileReadDouble(handle);
        double maxRiskPercent = FileReadDouble(handle);
        string comment = FileReadString(handle);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        AddToWhiteList(symbol, enabled, maxVolume, maxRiskPercent, comment);
    }

    FileClose(handle);

    Print("‚úÖ –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ",
          g_GlobalState.allowedInstrumentsCount, " –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤");

    return true;
}

//+------------------------------------------------------------------+
//|                 –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–°–ß–ï–¢–ê PnL (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï)           |
//+------------------------------------------------------------------+

//--- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ß–ò–°–¢–´–ô PnL (–æ—Ç–∫—Ä—ã—Ç—ã–µ + –∑–∞–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏)
double RiskManager_CalculateTotalPnL(bool daily = true, bool includeOpen = true)
{
    double totalPnL = 0;
    MqlDateTime dt;
    TimeCurrent(dt);

    if (daily)
    {
        //--- –î–ª—è –¥–Ω–µ–≤–Ω–æ–≥–æ PnL: –≤—Å–µ —Å–¥–µ–ª–∫–∏ —Å –Ω–∞—á–∞–ª–∞ –¥–Ω—è
        dt.hour = 0;
        dt.min = 0;
        dt.sec = 0;
    }
    else
    {
        //--- –î–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ PnL: –≤—Å–µ —Å–¥–µ–ª–∫–∏ —Å –Ω–∞—á–∞–ª–∞ –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
        dt.day -= dt.day_of_week - 1;
        dt.hour = 0;
        dt.min = 0;
        dt.sec = 0;
    }

    datetime startTime = StructToTime(dt);

    //--- 1. –°—á–∏—Ç–∞–µ–º –∑–∞–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥
    if (HistorySelect(startTime, TimeCurrent()))
    {
        int totalDeals = HistoryDealsTotal();
        for (int i = 0; i < totalDeals; i++)
        {
            ulong ticket = HistoryDealGetTicket(i);
            if (ticket > 0)
            {
                long dealType = HistoryDealGetInteger(ticket, DEAL_TYPE);
                if (dealType == DEAL_TYPE_BUY || dealType == DEAL_TYPE_SELL)
                {
                    totalPnL += HistoryDealGetDouble(ticket, DEAL_PROFIT);
                    totalPnL += HistoryDealGetDouble(ticket, DEAL_COMMISSION);
                    totalPnL += HistoryDealGetDouble(ticket, DEAL_SWAP);
                }
            }
        }
    }

    //--- 2. –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
    if (includeOpen)
    {
        for (int i = 0; i < PositionsTotal(); i++)
        {
            ulong ticket = PositionGetTicket(i);
            if (PositionSelectByTicket(ticket))
            {
                totalPnL += PositionGetDouble(POSITION_PROFIT);
                totalPnL += PositionGetDouble(POSITION_SWAP);
            }
        }
    }

    return totalPnL;
}

//--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∏—Å–∫ –ø–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º
bool CheckCorrelationRisk(string symbol)
{
    if (!EnableCorrelationCheck)
        return true;

    // –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º - –≤–µ—Ä–Ω—É—Ç—å false

    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
    // –ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
    return true;
}

//--- –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç—ã—Ö –ø—Ä–∏–±—ã–ª–µ–π/—É–±—ã—Ç–∫–æ–≤
void RiskManager_UpdateClosedPnLCounters()
{
    MqlDateTime dt;
    TimeCurrent(dt);

    //--- –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏
    g_GlobalState.totalClosedProfitToday = 0;
    g_GlobalState.totalClosedLossToday = 0;
    g_GlobalState.totalClosedProfitWeek = 0;
    g_GlobalState.totalClosedLossWeek = 0;

    //--- –ù–∞—á–∞–ª–æ –¥–Ω—è
    MqlDateTime dayStart = dt;
    dayStart.hour = 0;
    dayStart.min = 0;
    dayStart.sec = 0;
    datetime startOfDay = StructToTime(dayStart);

    //--- –ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏
    MqlDateTime weekStart = dt;
    weekStart.day -= weekStart.day_of_week - 1;
    weekStart.hour = 0;
    weekStart.min = 0;
    weekStart.sec = 0;
    datetime startOfWeek = StructToTime(weekStart);

    if (HistorySelect(startOfDay, TimeCurrent()))
    {
        int totalDeals = HistoryDealsTotal();
        for (int i = 0; i < totalDeals; i++)
        {
            ulong ticket = HistoryDealGetTicket(i);
            if (ticket > 0)
            {
                long dealType = HistoryDealGetInteger(ticket, DEAL_TYPE);
                if (dealType == DEAL_TYPE_BUY || dealType == DEAL_TYPE_SELL)
                {
                    datetime dealTime = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME);
                    double profit = HistoryDealGetDouble(ticket, DEAL_PROFIT);

                    //--- –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —Å–¥–µ–ª–∫–∏
                    if (dealTime >= startOfDay)
                    {
                        if (profit > 0)
                            g_GlobalState.totalClosedProfitToday += profit;
                        else
                            g_GlobalState.totalClosedLossToday += MathAbs(profit);
                    }

                    //--- –ù–µ–¥–µ–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏
                    if (dealTime >= startOfWeek)
                    {
                        if (profit > 0)
                            g_GlobalState.totalClosedProfitWeek += profit;
                        else
                            g_GlobalState.totalClosedLossWeek += MathAbs(profit);
                    }
                }
            }
        }
    }

    //--- –í—ã—á–∏—Å–ª—è–µ–º –ß–ò–°–¢–´–ô PnL
    g_GlobalState.dailyPnLTotal = g_GlobalState.totalClosedProfitToday - g_GlobalState.totalClosedLossToday;
    g_GlobalState.weeklyPnLTotal = g_GlobalState.totalClosedProfitWeek - g_GlobalState.totalClosedLossWeek;

    //--- –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–±—ã–ª—å –æ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π
    double openProfit = 0;
    for (int i = 0; i < PositionsTotal(); i++)
    {
        ulong ticket = PositionGetTicket(i);
        if (PositionSelectByTicket(ticket))
        {
            openProfit += PositionGetDouble(POSITION_PROFIT);
        }
    }

    g_GlobalState.dailyPnLTotal += openProfit;
    g_GlobalState.weeklyPnLTotal += openProfit;
}

//+------------------------------------------------------------------+
//|              –§–£–ù–ö–¶–ò–ò RISK_MANAGER (–ú–æ–¥—É–ª–∏ 1 –∏ 4)                    |
//+------------------------------------------------------------------+

//--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –ª–∏ —Ç–æ—Ä–≥–æ–≤–ª—è (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞ –∏ –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï–ú –õ–û–ì–û–í)
bool RiskManager_IsTradeAllowed(string symbol = "")
{
    //--- –ü–ï–†–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: –≥–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (—Å–∞–º–∞—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è)
    if (IsGlobalTradeLockActive())
    {
        // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
        static bool lastGlobalLock = false;
        static datetime lastGlobalLockLog = 0;
        if (!lastGlobalLock || (TimeCurrent() - lastGlobalLockLog) > 60) // –†–∞–∑ –≤ –º–∏–Ω—É—Ç—É –º–∞–∫—Å–∏–º—É–º
        {
            Print("üî¥ RiskManager: —Ç–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞ - –∞–∫—Ç–∏–≤–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞");
            lastGlobalLock = true;
            lastGlobalLockLog = TimeCurrent();
        }
        return false;
    }

    //--- –í–¢–û–†–ê–Ø –ü–†–û–í–ï–†–ö–ê: –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    if (g_GlobalState.useWhiteList && symbol != "")
    {
        if (!IsInstrumentAllowed(symbol))
        {
            // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
            static string lastBlockedSymbol = "";
            static datetime lastBlockLogTime = 0;

            if (symbol != lastBlockedSymbol || (TimeCurrent() - lastBlockLogTime) > 30) // –†–∞–∑ –≤ 30 —Å–µ–∫ –Ω–∞ —Å–∏–º–≤–æ–ª
            {
                Print("üî¥ RiskManager: –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ", symbol, " –∑–∞–ø—Ä–µ—â–µ–Ω (–Ω–µ –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ)");
                lastBlockedSymbol = symbol;
                lastBlockLogTime = TimeCurrent();
            }
            return false;
        }
    }

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    static bool lastResult = true;
    static string lastBlockReason = "";
    static datetime lastLogTime = 0;

    //--- –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    bool currentResult = true;
    string currentBlockReason = "";

    if (!g_GlobalState.allowNewTrades)
    {
        currentResult = false;
        currentBlockReason = "–≥–ª–æ–±–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–µ—Ç";
    }
    else if (g_GlobalState.dailyTPReached)
    {
        currentResult = false;
        currentBlockReason = "–¥–æ—Å—Ç–∏–≥–Ω—É—Ç –¥–Ω–µ–≤–Ω–æ–π TP";
    }
    else if (g_GlobalState.dailySLReached)
    {
        currentResult = false;
        currentBlockReason = "–¥–æ—Å—Ç–∏–≥–Ω—É—Ç –¥–Ω–µ–≤–Ω–æ–π SL";
    }
    else if (g_GlobalState.weeklyTPReached)
    {
        currentResult = false;
        currentBlockReason = "–¥–æ—Å—Ç–∏–≥–Ω—É—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π TP";
    }
    else if (g_GlobalState.weeklySLReached)
    {
        currentResult = false;
        currentBlockReason = "–¥–æ—Å—Ç–∏–≥–Ω—É—Ç –Ω–µ–¥–µ–ª—å–Ω—ã–π SL";
    }
    else if (g_GlobalState.emergencyStop)
    {
        currentResult = false;
        currentBlockReason = "—ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞";
    }
    else if (!CheckCorrelationRisk(symbol))
    {
        currentResult = false;
        currentBlockReason = "–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π —Ä–∏—Å–∫";
    }
    //--- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –°–î–ï–õ–û–ö –∑–∞ –¥–µ–Ω—å
    else if (g_GlobalState.dailyTradesCount >= g_GlobalState.dailyTradesLimit)
    {
        currentResult = false;
        currentBlockReason = StringFormat("–ø—Ä–µ–≤—ã—à–µ–Ω –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –°–î–ï–õ–û–ö (%d/%d)",
                                          g_GlobalState.dailyTradesCount, g_GlobalState.dailyTradesLimit);
    }
    //--- 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –°–î–ï–õ–û–ö –∑–∞ –Ω–µ–¥–µ–ª—é
    else if (g_GlobalState.weeklyTradesCount >= g_GlobalState.weeklyTradesLimit)
    {
        currentResult = false;
        currentBlockReason = StringFormat("–ø—Ä–µ–≤—ã—à–µ–Ω –Ω–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –°–î–ï–õ–û–ö (%d/%d)",
                                          g_GlobalState.weeklyTradesCount, g_GlobalState.weeklyTradesLimit);
    }
    //--- 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –û–î–ù–û–í–†–ï–ú–ï–ù–ù–´–• –ø–æ–∑–∏—Ü–∏–π (–¥–µ–Ω—å)
    else
    {
        int currentSimultaneousPositions = PositionsTotal();
        if (currentSimultaneousPositions >= g_GlobalState.maxSimultaneousPositionsDaily)
        {
            currentResult = false;
            currentBlockReason = StringFormat("–ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π (%d/%d)",
                                              currentSimultaneousPositions, g_GlobalState.maxSimultaneousPositionsDaily);
        }
    }

    //--- –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å
    bool statusChanged = (currentResult != lastResult) || (currentBlockReason != lastBlockReason);

    //--- –õ–æ–≥–∏—Ä—É–µ–º –¢–û–õ–¨–ö–û –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ò–õ–ò —Ä–∞–∑ –≤ 60 —Å–µ–∫—É–Ω–¥
    bool shouldLog = statusChanged || (TimeCurrent() - lastLogTime) > 60;

    if (shouldLog)
    {
        if (!currentResult)
        {
            Print("üî¥ RiskManager: —Ç–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞ - ", currentBlockReason);
        }
        else
        {
            // –†–∞–∑—Ä–µ—à–µ–Ω–æ - –ª–æ–≥–∏—Ä—É–µ–º —Ä–µ–∂–µ (—Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç)
            static datetime lastAllowedLog = 0;
            if (TimeCurrent() - lastAllowedLog > 300) // 5 –º–∏–Ω—É—Ç
            {
                Print("‚úÖ RiskManager: —Ç–æ—Ä–≥–æ–≤–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞");
                lastAllowedLog = TimeCurrent();
            }
        }

        lastLogTime = TimeCurrent();
    }

    //--- –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à
    lastResult = currentResult;
    lastBlockReason = currentBlockReason;

    return currentResult;
}

//+------------------------------------------------------------------+
//|                –¢–ï–õ–ï–ì–†–ê–ú –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –í RISKMANAGER                |
//+------------------------------------------------------------------+

//--- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è Telegram —Å–∏–≥–Ω–∞–ª–æ–≤
struct STelegramSignal
{
    string command; // BUY, SELL, CLOSE
    string symbol;
    double price;
    double volume;
    double sl;
    double tp;
    datetime time;
    string chatId;
    bool processed;
};

STelegramSignal g_TelegramSignal;

//+------------------------------------------------------------------+
//| –û–ë–†–ê–ë–û–¢–ß–ò–ö –¢–ï–õ–ï–ì–†–ê–ú –°–ò–ì–ù–ê–õ–û–í                                    |
//+------------------------------------------------------------------+
void ProcessTelegramSignal(string signalText)
{
    // –ü—Ä–∏–º–µ—Ä —Å–∏–≥–Ω–∞–ª–∞: "BUY EURUSD 1.0 @1.20000 SL:1.19500 TP:1.21000"

    Print("Telegram —Å–∏–≥–Ω–∞–ª –ø–æ–ª—É—á–µ–Ω: ", signalText);

    // –ü–∞—Ä—Å–∏–º —Å–∏–≥–Ω–∞–ª
    string parts[];
    int count = StringSplit(signalText, ' ', parts);

    if (count >= 2)
    {
        g_TelegramSignal.command = parts[0];
        g_TelegramSignal.symbol = parts[1];
        g_TelegramSignal.time = TimeCurrent();
        g_TelegramSignal.processed = false;

        // –ü–∞—Ä—Å–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        for (int i = 2; i < count; i++)
        {
            if (parts[i] == "@" && i + 1 < count)
                g_TelegramSignal.price = StringToDouble(parts[i + 1]);
            else if (StringSubstr(parts[i], 0, 3) == "SL:")
                g_TelegramSignal.sl = StringToDouble(StringSubstr(parts[i], 3));
            else if (StringSubstr(parts[i], 0, 3) == "TP:")
                g_TelegramSignal.tp = StringToDouble(StringSubstr(parts[i], 3));
            else if (StringSubstr(parts[i], 0, 2) == "V:")
                g_TelegramSignal.volume = StringToDouble(StringSubstr(parts[i], 2));
        }

        g_HasTelegramSignal = true;
        Print("Telegram —Å–∏–≥–Ω–∞–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω: ", g_TelegramSignal.command, " ",
              g_TelegramSignal.symbol, " @", g_TelegramSignal.price);
    }
}

void RiskManager_ResetAllLimits();

//+------------------------------------------------------------------+
//| –û–ë–†–ê–ë–û–¢–ö–ê –í–ù–ï–®–ù–ò–• –°–ò–ì–ù–ê–õ–û–í RISKMANAGER                           |
//+------------------------------------------------------------------+
void RiskManager_ProcessExternalSignal(string signalText)
{
    Print("RiskManager: –ø–æ–ª—É—á–µ–Ω –≤–Ω–µ—à–Ω–∏–π —Å–∏–≥–Ω–∞–ª: ", signalText);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∫–æ–º–∞–Ω–¥—ã
    if (StringFind(signalText, SignalCommandPrefix) >= 0)
    {
        Print("–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã: ", signalText);

        // –ü—Ä–∏–º–µ—Ä: –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ —Å–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤
        if (StringFind(signalText, "/reset") >= 0)
        {
            RiskManager_ResetAllLimits();
            Print("–°–±—Ä–æ—à–µ–Ω—ã –≤—Å–µ –ª–∏–º–∏—Ç—ã –ø–æ –≤–Ω–µ—à–Ω–µ–π –∫–æ–º–∞–Ω–¥–µ");
        }
        // –ü—Ä–∏–º–µ—Ä: –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        else if (StringFind(signalText, "/lock") >= 0)
        {
            SetGlobalTradeLock(5, "External lock command");
            Print("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–Ω–µ—à–Ω–µ–π –∫–æ–º–∞–Ω–¥–µ");
        }
        // –ü—Ä–∏–º–µ—Ä: –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        else if (StringFind(signalText, "/unlock") >= 0)
        {
            RemoveGlobalTradeLock();
            Print("–°–Ω—è—Ç–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–Ω–µ—à–Ω–µ–π –∫–æ–º–∞–Ω–¥–µ");
        }
    }
}

//+------------------------------------------------------------------+
//| –í–´–ü–û–õ–ù–ï–ù–ò–ï –¢–ï–õ–ï–ì–†–ê–ú –°–ò–ì–ù–ê–õ–ê –ß–ï–†–ï–ó –®–õ–Æ–ó                          |
//+------------------------------------------------------------------+
void ExecuteTelegramSignal()
{
    if (!g_HasTelegramSignal || g_TelegramSignal.processed)
        return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª –ª–∏ —Å–∏–≥–Ω–∞–ª (–±–æ–ª—å—à–µ 1 –º–∏–Ω—É—Ç—ã)
    if (TimeCurrent() - g_TelegramSignal.time > 60)
    {
        Print("Telegram —Å–∏–≥–Ω–∞–ª —É—Å—Ç–∞—Ä–µ–ª (–±–æ–ª—å—à–µ 1 –º–∏–Ω—É—Ç—ã)");
        g_HasTelegramSignal = false;
        return;
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –†–ò–°–ö–ú–ï–ù–ï–î–ñ–ï–† –∫–∞–∫ —à–ª—é–∑!
    if (g_TelegramSignal.command == "BUY")
    {
        double volume = (g_TelegramSignal.volume > 0) ? g_TelegramSignal.volume : 0.1;

        // –í–´–ó–û–í –ß–ï–†–ï–ó RISKMANAGER GATEWAY
        if (!Gateway_Buy(volume, g_TelegramSignal.symbol,
                         g_TelegramSignal.price,
                         g_TelegramSignal.sl,
                         g_TelegramSignal.tp,
                         "Telegram Signal"))
        {
            Print("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å Telegram —Å–∏–≥–Ω–∞–ª BUY");
        }
        else
        {
            g_TelegramSignal.processed = true;
            Print("‚úÖ Telegram —Å–∏–≥–Ω–∞–ª BUY –≤—ã–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ RiskManager Gateway");
        }
    }
    else if (g_TelegramSignal.command == "SELL")
    {
        double volume = (g_TelegramSignal.volume > 0) ? g_TelegramSignal.volume : 0.1;

        if (!Gateway_Sell(volume, g_TelegramSignal.symbol,
                          g_TelegramSignal.price,
                          g_TelegramSignal.sl,
                          g_TelegramSignal.tp,
                          "Telegram Signal"))
        {
            Print("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å Telegram —Å–∏–≥–Ω–∞–ª SELL");
        }
        else
        {
            g_TelegramSignal.processed = true;
            Print("‚úÖ Telegram —Å–∏–≥–Ω–∞–ª SELL –≤—ã–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ RiskManager Gateway");
        }
    }
    else if (g_TelegramSignal.command == "CLOSE")
    {
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π –ø–æ —Å–∏–º–≤–æ–ª—É
        CloseAllSymbolPositions(g_TelegramSignal.symbol, "Telegram CLOSE signal");
        g_TelegramSignal.processed = true;
    }

    g_HasTelegramSignal = false;
}

//+------------------------------------------------------------------+
//| –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ —Å–¥–µ–ª–æ–∫ –∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π                |
//+------------------------------------------------------------------+
void RiskManager_UpdateTradeCounters()
{
    MqlDateTime dt;
    TimeCurrent(dt);

    //--- –ù–∞—á–∞–ª–æ –¥–Ω—è
    MqlDateTime dayStart = dt;
    dayStart.hour = 0;
    dayStart.min = 0;
    dayStart.sec = 0;
    datetime startOfDay = StructToTime(dayStart);

    //--- –ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏
    MqlDateTime weekStart = dt;
    weekStart.day -= weekStart.day_of_week - 1;
    weekStart.hour = 0;
    weekStart.min = 0;
    weekStart.sec = 0;
    datetime startOfWeek = StructToTime(weekStart);

    //--- –°—á–∏—Ç–∞–µ–º —Å–¥–µ–ª–∫–∏ –∑–∞ –¥–µ–Ω—å –∏ –Ω–µ–¥–µ–ª—é
    int dailyTrades = 0;
    int weeklyTrades = 0;

    if (HistorySelect(startOfDay, TimeCurrent()))
    {
        int totalDeals = HistoryDealsTotal();
        for (int i = 0; i < totalDeals; i++)
        {
            ulong ticket = HistoryDealGetTicket(i);
            if (ticket > 0)
            {
                long dealType = HistoryDealGetInteger(ticket, DEAL_TYPE);
                datetime dealTime = (datetime)HistoryDealGetInteger(ticket, DEAL_TIME);

                if (dealType == DEAL_TYPE_BUY || dealType == DEAL_TYPE_SELL)
                {
                    //--- –î–Ω–µ–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏
                    if (dealTime >= startOfDay)
                    {
                        dailyTrades++;
                    }

                    //--- –ù–µ–¥–µ–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏
                    if (dealTime >= startOfWeek)
                    {
                        weeklyTrades++;
                    }
                }
            }
        }
    }

    //--- –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ (–ù–û–í–´–ï –ø–æ–ª—è)
    g_GlobalState.dailyTradesCount = dailyTrades;
    g_GlobalState.weeklyTradesCount = weeklyTrades;

    //--- –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –ø–æ–ª—è)
    g_GlobalState.dailyPositionsCount = dailyTrades;
    g_GlobalState.weeklyPositionsCount = weeklyTrades;
}

//+------------------------------------------------------------------+
//|              –§–£–ù–ö–¶–ò–ò RISK_MANAGER –î–õ–Ø –ö–û–†–†–ï–ö–¶–ò–ò SL                  |
//+------------------------------------------------------------------+

//--- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —É–±—ã—Ç–æ–∫ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ SL
double CalculateLossAtSL(string symbol, ENUM_POSITION_TYPE type,
                         double entryPrice, double slPrice, double volume)
{
    double loss = 0;
    bool success = false;

    if (type == POSITION_TYPE_BUY)
    {
        success = OrderCalcProfit(ORDER_TYPE_BUY, symbol, volume, entryPrice, slPrice, loss);
    }
    else // SELL
    {
        success = OrderCalcProfit(ORDER_TYPE_SELL, symbol, volume, entryPrice, slPrice, loss);
    }

    if (!success)
    {
        Print("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —É–±—ã—Ç–∫–∞ –¥–ª—è ", symbol,
              " —Ç–∏–ø: ", EnumToString(type),
              " –æ–±—ä–µ–º: ", volume,
              " –≤—Ö–æ–¥: ", entryPrice,
              " SL: ", slPrice);
        return 0; // –∏–ª–∏ –ª—é–±–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }

    return MathAbs(loss);
}

//--- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â–∏–π —É–±—ã—Ç–æ–∫ –ø–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –ø–æ–∑–∏—Ü–∏—è–º
double CalculateCurrentOpenLoss(string symbol = "")
{
    double totalLoss = 0;

    for (int i = 0; i < PositionsTotal(); i++)
    {
        ulong ticket = PositionGetTicket(i);
        if (PositionSelectByTicket(ticket))
        {
            if (symbol == "" || PositionGetString(POSITION_SYMBOL) == symbol)
            {
                double profit = PositionGetDouble(POSITION_PROFIT);
                if (profit < 0)
                    totalLoss += MathAbs(profit);
            }
        }
    }

    return totalLoss;
}

//--- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–µ–∫—É—â—É—é –ø—Ä–∏–±—ã–ª—å –ø–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –ø–æ–∑–∏—Ü–∏—è–º
double CalculateCurrentOpenProfit(string symbol = "")
{
    double totalProfit = 0;

    for (int i = 0; i < PositionsTotal(); i++)
    {
        ulong ticket = PositionGetTicket(i);
        if (PositionSelectByTicket(ticket))
        {
            if (symbol == "" || PositionGetString(POSITION_SYMBOL) == symbol)
            {
                double profit = PositionGetDouble(POSITION_PROFIT);
                if (profit > 0)
                    totalProfit += profit;
            }
        }
    }

    return totalProfit;
}

//--- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–∏—Å–∫ –¥–ª—è —Å–¥–µ–ª–∫–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)
double RiskManager_CalculateMaxAllowedRisk(string symbol, ENUM_POSITION_TYPE type,
                                           double price, double volume)
{
    double balance = AccountInfoDouble(ACCOUNT_BALANCE);

    // 1. –†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (–≤ % –æ—Ç –±–∞–ª–∞–Ω—Å–∞)
    double maxRiskPerTrade = balance * g_GlobalState.maxRiskPerTrade / 100.0;

    // 2. –û—Å—Ç–∞–≤—à–∏–π—Å—è –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç —É–±—ã—Ç–∫–æ–≤ –° –£–ß–ï–¢–û–ú –¢–ï–ö–£–©–ï–ô –ü–†–ò–ë–´–õ–ò
    double currentNetDailyPnL = g_GlobalState.dailyPnLTotal; // –ß–ò–°–¢–´–ô PnL (–ø—Ä–∏–±—ã–ª—å - —É–±—ã—Ç–æ–∫)
    double remainingDailyLoss = MathAbs(g_GlobalState.dailyStopLoss) - MathAbs(currentNetDailyPnL);

    if (remainingDailyLoss < 0)
        remainingDailyLoss = 0;

    // 3. –û—Å—Ç–∞–≤—à–∏–π—Å—è –Ω–µ–¥–µ–ª—å–Ω—ã–π –ª–∏–º–∏—Ç —É–±—ã—Ç–∫–æ–≤ –° –£–ß–ï–¢–û–ú –¢–ï–ö–£–©–ï–ô –ü–†–ò–ë–´–õ–ò
    double currentNetWeeklyPnL = g_GlobalState.weeklyPnLTotal; // –ß–ò–°–¢–´–ô PnL
    double remainingWeeklyLoss = MathAbs(g_GlobalState.weeklyStopLoss) - MathAbs(currentNetWeeklyPnL);

    if (remainingWeeklyLoss < 0)
        remainingWeeklyLoss = 0;

    // 4. –¢–µ–∫—É—â–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —É–±—ã—Ç–∫–∏
    double currentOpenLoss = CalculateCurrentOpenLoss(symbol);

    // –ë–µ—Ä–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑ –≤—Å–µ—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    double maxAllowedLoss = MathMin(maxRiskPerTrade, remainingDailyLoss);
    maxAllowedLoss = MathMin(maxAllowedLoss, remainingWeeklyLoss);
    maxAllowedLoss = MathMin(maxAllowedLoss, maxRiskPerTrade - currentOpenLoss);

    // –£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ —É –Ω–∞—Å —É–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–±—ã–ª—å
    if (currentNetDailyPnL > 0)
    {
        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø—Ä–∏–±—ã–ª—å, –º–æ–∂–µ–º —Ä–∏—Å–∫–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ
        maxAllowedLoss += MathMin(currentNetDailyPnL * 0.5, maxRiskPerTrade * 2);
    }

    return MathMax(maxAllowedLoss, 0); // –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º
}

//--- –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å SL –ø–æ–¥ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)
bool RiskManager_AdjustSLForLimits(string symbol, ENUM_POSITION_TYPE type,
                                   double price, double volume,
                                   double &slPrice, double &tpPrice)
{
    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —É–±—ã—Ç–æ–∫
    double maxAllowedLoss = RiskManager_CalculateMaxAllowedRisk(symbol, type, price, volume);

    if (maxAllowedLoss <= 0)
    {
        Print("RiskManager: –Ω—É–ª–µ–≤–æ–π –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–∏—Å–∫. –°–¥–µ–ª–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.");
        return false;
    }

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∏—Å–∫ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–º—É SL
    double proposedLoss = CalculateLossAtSL(symbol, type, price, slPrice, volume);

    if (proposedLoss <= maxAllowedLoss)
    {
        // –†–∏—Å–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–æ–≤
        Print("RiskManager: —Ä–∏—Å–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–æ–≤: $", proposedLoss, " –∏–∑ $", maxAllowedLoss);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        if (type == POSITION_TYPE_BUY)
        {
            if (slPrice < price) // –≠—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π SL –¥–ª—è –ª–æ–Ω–≥–∞
                return true;
        }
        else
        {
            if (slPrice > price) // –≠—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π SL –¥–ª—è —à–æ—Ä—Ç–∞
                return true;
        }

        Print("RiskManager: –Ω–µ–≤–µ—Ä–Ω—ã–π SL –¥–ª—è —Ç–∏–ø–∞ –ø–æ–∑–∏—Ü–∏–∏");
        return false;
    }

    //--- –ù—É–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å SL
    Print("RiskManager: —Ä–∏—Å–∫ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç—ã: $", proposedLoss, " > $", maxAllowedLoss);

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ü–µ–Ω—É SL
    double point = SymbolInfoDouble(symbol, SYMBOL_POINT);
    double tickValue = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_VALUE);
    double tickSize = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_SIZE);

    if (tickValue <= 0 || tickSize <= 0)
        return false;

    double ticksPerPoint = tickSize / point;
    double pointValue = tickValue / ticksPerPoint;

    if (pointValue <= 0)
        return false;

    double maxPointsLoss = maxAllowedLoss / pointValue / volume;

    if (type == POSITION_TYPE_BUY)
    {
        double newSL = price - (maxPointsLoss * point);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
        double minStopDistance = SymbolInfoInteger(symbol, SYMBOL_TRADE_STOPS_LEVEL) * point;
        if (price - newSL < minStopDistance * 1.5) // –° –∑–∞–ø–∞—Å–æ–º 50%
        {
            Print("RiskManager: —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SL —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ —Ü–µ–Ω–µ. –°–¥–µ–ª–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.");
            return false;
        }

        slPrice = newSL;
        Print("RiskManager: SL —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Å ", price - (proposedLoss / (pointValue * volume) * point), " –Ω–∞ ", slPrice);
    }
    else // SELL
    {
        double newSL = price + (maxPointsLoss * point);

        double minStopDistance = SymbolInfoInteger(symbol, SYMBOL_TRADE_STOPS_LEVEL) * point;
        if (newSL - price < minStopDistance * 1.5)
        {
            Print("RiskManager: —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SL —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ —Ü–µ–Ω–µ. –°–¥–µ–ª–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.");
            return false;
        }

        slPrice = newSL;
        Print("RiskManager: SL —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Å ", price + (proposedLoss / (pointValue * volume) * point), " –Ω–∞ ", slPrice);
    }

    //--- –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º TP –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è RR ratio –∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if (tpPrice > 0 && type == POSITION_TYPE_BUY && tpPrice > price)
    {
        double originalSLDistance = MathAbs(price - (type == POSITION_TYPE_BUY ? price - (proposedLoss / (pointValue * volume) * point) : price + (proposedLoss / (pointValue * volume) * point)));
        double newSLDistance = MathAbs(price - slPrice);

        if (originalSLDistance > 0)
        {
            double rrRatio = MathAbs(tpPrice - price) / originalSLDistance;
            if (type == POSITION_TYPE_BUY)
                tpPrice = price + (newSLDistance * rrRatio);
            else
                tpPrice = price - (newSLDistance * rrRatio);

            Print("RiskManager: TP —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ ", tpPrice, " (RR: ", rrRatio, ")");
        }
    }
    else if (tpPrice > 0 && type == POSITION_TYPE_SELL && tpPrice < price)
    {
        double originalSLDistance = MathAbs(price - slPrice);
        double newSLDistance = MathAbs(price - slPrice);

        if (originalSLDistance > 0)
        {
            double rrRatio = MathAbs(price - tpPrice) / originalSLDistance;
            tpPrice = price - (newSLDistance * rrRatio);

            Print("RiskManager: TP —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ ", tpPrice, " (RR: ", rrRatio, ")");
        }
    }

    return true;
}

//+------------------------------------------------------------------+
//|           –§–£–ù–ö–¶–ò–ò POSITION MANAGER (–ú–æ–¥—É–ª–∏ 2 –∏ 3)               |
//+------------------------------------------------------------------+

//--- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
void InitializePMConfig(string symbol)
{
    ZeroMemory(g_Config);

    g_Config.symbol = symbol;
    g_Config.contractSize = SymbolInfoDouble(symbol, SYMBOL_TRADE_CONTRACT_SIZE);
    g_Config.tickValue = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_VALUE);
    g_Config.tickSize = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_SIZE);
    g_Config.point = SymbolInfoDouble(symbol, SYMBOL_POINT);
    g_Config.minLot = SymbolInfoDouble(symbol, SYMBOL_VOLUME_MIN);
    g_Config.lotStep = SymbolInfoDouble(symbol, SYMBOL_VOLUME_STEP);
    g_Config.maxPositionVolume = SymbolInfoDouble(symbol, SYMBOL_VOLUME_MAX);
    g_Config.enabled = true;

    if (g_Config.contractSize <= 0 || g_Config.tickValue <= 0)
    {
        Print("–û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ ", symbol);
        g_Config.enabled = false;
    }
}

//--- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–∞–ª–∏–∞—Å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
void InitializeInstrumentConfig(string symbol)
{
    InitializePMConfig(symbol);
}

//--- –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
bool PM_GetInstrumentConfig(string symbol, SInstrumentConfig &config)
{
    //--- –ï—Å–ª–∏ —Å–∏–º–≤–æ–ª —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    if (symbol == g_Config.symbol)
    {
        config = g_Config;
        return true;
    }

    //--- TODO: –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∏–∑ —Ñ–∞–π–ª–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
    return false;
}

//--- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
bool PM_SaveInstrumentConfig(string symbol, SInstrumentConfig &config)
{
    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –µ—Å–ª–∏ —Å–∏–º–≤–æ–ª —Å–æ–≤–ø–∞–¥–∞–µ—Ç
    if (symbol == g_Config.symbol)
    {
        g_Config = config;
        return true;
    }

    return false;
}

//--- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ª–æ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∏—Å–∫–∞
double PM_CalculateLotSize(string symbol, double riskAmount, double slDistancePips)
{
    if (slDistancePips <= 0)
        return 0;

    double tickValue = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_VALUE);
    double tickSize = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_SIZE);
    double point = SymbolInfoDouble(symbol, SYMBOL_POINT);

    if (tickValue <= 0 || tickSize <= 0)
        return 0;

    double minLot = SymbolInfoDouble(symbol, SYMBOL_VOLUME_MIN);
    double maxLot = SymbolInfoDouble(symbol, SYMBOL_VOLUME_MAX);
    double lotStep = SymbolInfoDouble(symbol, SYMBOL_VOLUME_STEP);

    //--- –ë–∏–Ω–∞—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ª–æ—Ç–∞
    double testLot = minLot;
    double bestLot = 0;
    double bestDiff = 999999;

    while (testLot <= maxLot)
    {
        double testLoss = 0;
        double openPrice = SymbolInfoDouble(symbol, SYMBOL_BID);
        double slPrice = openPrice - slDistancePips * point;

        if (OrderCalcProfit(ORDER_TYPE_BUY, symbol, testLot, openPrice, slPrice, testLoss))
        {
            testLoss = MathAbs(testLoss);
            double diff = MathAbs(testLoss - riskAmount);

            if (diff < bestDiff)
            {
                bestDiff = diff;
                bestLot = testLot;
            }

            if (testLoss > riskAmount * 1.1)
                break;
        }

        testLot += lotStep;
    }

    //--- –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ
    if (bestLot > 0)
    {
        bestLot = MathFloor(bestLot / lotStep) * lotStep;
        if (bestLot < minLot)
            bestLot = minLot;
        if (bestLot > maxLot)
            bestLot = maxLot;
    }

    return bestLot;
}

//--- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å SL/TP –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏
bool CalculateSLTPForPosition(string symbol, ENUM_POSITION_TYPE type, double openPrice, double volume,
                              SInstrumentConfig &config, double &slPrice, double &tpPrice)
{
    if (symbol == "" || openPrice <= 0 || volume <= 0)
        return false;

    double point = SymbolInfoDouble(symbol, SYMBOL_POINT);
    if (point <= 0)
        return false;

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è SL
    double slDistance = CalculateSLDistance(symbol, openPrice, type, config);
    if (slDistance <= 0)
        return false;

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º SL —Ü–µ–Ω—É
    if (type == POSITION_TYPE_BUY)
    {
        slPrice = openPrice - slDistance;
    }
    else // POSITION_TYPE_SELL
    {
        slPrice = openPrice + slDistance;
    }

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º TP
    double tpDistance = CalculateTPDistance(symbol, openPrice, type, slDistance, config);
    if (tpDistance <= 0)
        return false;

    if (type == POSITION_TYPE_BUY)
    {
        tpPrice = openPrice + tpDistance;
    }
    else // POSITION_TYPE_SELL
    {
        tpPrice = openPrice - tpDistance;
    }

    return true;
}

//--- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è SL
double CalculateSLDistance(string symbol, double openPrice, ENUM_POSITION_TYPE type, SInstrumentConfig &config)
{
    double distance = 0;
    double point = SymbolInfoDouble(symbol, SYMBOL_POINT);

    switch (config.slMode)
    {
    case SL_MONEY:
    {
        // –†–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—É–Ω–∫—Ç–∞
        double riskAmount = config.slValue; // –°—É–º–º–∞ —Ä–∏—Å–∫–∞ –≤ $
        double tickValue = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_VALUE);
        double tickSize = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_SIZE);

        if (tickValue > 0 && tickSize > 0)
        {
            double ticksPerPoint = tickSize / point;
            double pointValue = (tickValue / ticksPerPoint);
            double pointsNeeded = riskAmount / pointValue;
            distance = pointsNeeded * point;
        }
        break;
    }

    case SL_PIPS:
        distance = config.slValue * point;
        break;

    case SL_PERCENT:
    {
        double balance = AccountInfoDouble(ACCOUNT_BALANCE);
        double riskPercent = config.slValue; // –†–∏—Å–∫ –≤ %
        double riskAmount = balance * riskPercent / 100.0;

        // –ü–æ–≤—Ç–æ—Ä—è–µ–º —Ä–∞—Å—á–µ—Ç –∫–∞–∫ –¥–ª—è SL_MONEY
        double tickValue = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_VALUE);
        double tickSize = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_SIZE);

        if (tickValue > 0 && tickSize > 0)
        {
            double ticksPerPoint = tickSize / point;
            double pointValue = (tickValue / ticksPerPoint);
            double pointsNeeded = riskAmount / pointValue;
            distance = pointsNeeded * point;
        }
        break;
    }

    case SL_ATR:
    {
        double atrValue = iATR(symbol, config.atrTimeframe, config.atrPeriod);
        if (atrValue > 0)
        {
            distance = atrValue * config.atrMultiplierSL;
        }
        break;
    }
    }

    return distance;
}

//--- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è TP
double CalculateTPDistance(string symbol, double openPrice, ENUM_POSITION_TYPE type, double slDistance, SInstrumentConfig &config)
{
    double distance = 0;
    double point = SymbolInfoDouble(symbol, SYMBOL_POINT);

    switch (config.tpMode)
    {
    case TP_MONEY:
    {
        // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ä–∞—Å—á–µ—Ç—É SL_MONEY
        double rewardAmount = config.tpValue;
        double tickValue = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_VALUE);
        double tickSize = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_SIZE);

        if (tickValue > 0 && tickSize > 0)
        {
            double ticksPerPoint = tickSize / point;
            double pointValue = (tickValue / ticksPerPoint);
            double pointsNeeded = rewardAmount / pointValue;
            distance = pointsNeeded * point;
        }
        break;
    }

    case TP_PIPS:
        distance = config.tpValue * point;
        break;

    case TP_PERCENT:
    {
        double balance = AccountInfoDouble(ACCOUNT_BALANCE);
        double rewardPercent = config.tpValue;
        double rewardAmount = balance * rewardPercent / 100.0;

        double tickValue = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_VALUE);
        double tickSize = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_SIZE);

        if (tickValue > 0 && tickSize > 0)
        {
            double ticksPerPoint = tickSize / point;
            double pointValue = (tickValue / ticksPerPoint);
            double pointsNeeded = rewardAmount / pointValue;
            distance = pointsNeeded * point;
        }
        break;
    }

    case TP_ATR:
    {
        double atrValue = iATR(symbol, config.atrTimeframe, config.atrPeriod);
        if (atrValue > 0)
        {
            distance = atrValue * config.atrMultiplierTP;
        }
        break;
    }

    case TP_RR:
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Risk/Reward ratio
        if (slDistance > 0)
            distance = slDistance * config.rrRatio;
        break;
    }

    return distance;
}

//--- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–≤–Ω–∏ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
void PM_InitPartialLevels(SPartialCloseLevel &levels[], int &levelsCount,
                          bool l1Enabled, double l1Trigger, double l1Close,
                          ENUM_BREAKEVEN_MODE l1Mode, double l1Value,
                          bool l2Enabled, double l2Trigger, double l2Close,
                          ENUM_BREAKEVEN_MODE l2Mode, double l2Value,
                          bool l3Enabled, double l3Trigger, double l3Close,
                          ENUM_BREAKEVEN_MODE l3Mode, double l3Value)
{
    levelsCount = 0;

    //--- –£—Ä–æ–≤–µ–Ω—å 1
    if (l1Enabled && l1Trigger > 0 && l1Close > 0)
    {
        levels[levelsCount].enabled = true;
        levels[levelsCount].triggerPercent = l1Trigger;
        levels[levelsCount].closePercent = l1Close;
        levels[levelsCount].breakevenMode = l1Mode;
        levels[levelsCount].breakevenValue = l1Value;
        levels[levelsCount].executed = false;
        levelsCount++;
    }

    //--- –£—Ä–æ–≤–µ–Ω—å 2
    if (l2Enabled && l2Trigger > 0 && l2Close > 0)
    {
        levels[levelsCount].enabled = true;
        levels[levelsCount].triggerPercent = l2Trigger;
        levels[levelsCount].closePercent = l2Close;
        levels[levelsCount].breakevenMode = l2Mode;
        levels[levelsCount].breakevenValue = l2Value;
        levels[levelsCount].executed = false;
        levelsCount++;
    }

    //--- –£—Ä–æ–≤–µ–Ω—å 3
    if (l3Enabled && l3Trigger > 0 && l3Close > 0)
    {
        levels[levelsCount].enabled = true;
        levels[levelsCount].triggerPercent = l3Trigger;
        levels[levelsCount].closePercent = l3Close;
        levels[levelsCount].breakevenMode = l3Mode;
        levels[levelsCount].breakevenValue = l3Value;
        levels[levelsCount].executed = false;
        levelsCount++;
    }
}

//--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ª–æ–≤–∏—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
void PM_CheckPartialClose(string symbol, ulong ticket, SInstrumentConfig &config)
{
    if (!PositionSelectByTicket(ticket))
        return;

    double profit = PositionGetDouble(POSITION_PROFIT);
    double volume = PositionGetDouble(POSITION_VOLUME);
    double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);
    double currentSL = PositionGetDouble(POSITION_SL);
    double currentTP = PositionGetDouble(POSITION_TP);
    ENUM_POSITION_TYPE type = (ENUM_POSITION_TYPE)PositionGetInteger(POSITION_TYPE);
    double currentPrice = SymbolInfoDouble(symbol, (type == POSITION_TYPE_BUY) ? SYMBOL_BID : SYMBOL_ASK);
    double point = SymbolInfoDouble(symbol, SYMBOL_POINT);

    //--- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–ª–µ–≤–æ–π TP –≤ –¥–µ–Ω—å–≥–∞—Ö
    double targetProfit = 0;

    // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –î–û switch, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –≤–∏–¥–Ω—ã –≤–æ –≤—Å–µ—Ö case
    double tickValue = 0;
    double minVolume = 0;
    double balance = 0;
    double atrValue = 0;
    double slDistance = 0;

    switch (config.tpMode)
    {
    case TP_MONEY:
        targetProfit = config.tpValue;
        break;

    case TP_PIPS:
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –≤—ã—à–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        tickValue = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_VALUE);
        minVolume = SymbolInfoDouble(symbol, SYMBOL_VOLUME_MIN);
        if (minVolume > 0)
            targetProfit = config.tpValue * tickValue * (volume / minVolume);
        break;

    case TP_PERCENT:
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –≤—ã—à–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        balance = AccountInfoDouble(ACCOUNT_BALANCE);
        targetProfit = balance * config.tpValue / 100.0;
        break;

    case TP_ATR:
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –≤—ã—à–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        atrValue = iATR(symbol, config.atrTimeframe, config.atrPeriod);
        if (atrValue > 0)
        {
            tickValue = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_VALUE);
            targetProfit = atrValue * config.atrMultiplierTP * tickValue;
        }
        break;

    case TP_RR:
        // –î–ª—è RR —Ä–µ–∂–∏–º–∞ –Ω—É–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∏—Å–∫–∞
        if (config.slMode != SL_NONE)
        {
            slDistance = CalculateSLDistance(symbol, openPrice, type, config);
            if (slDistance > 0)
            {
                tickValue = SymbolInfoDouble(symbol, SYMBOL_TRADE_TICK_VALUE);
                targetProfit = slDistance * config.rrRatio * tickValue;
            }
        }
        break;

    default:
        return;
    }

    if (targetProfit <= 0)
        return;

    //--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å
    for (int i = 0; i < config.partialLevelsCount; i++)
    {
        if (!config.partialLevels[i].enabled || config.partialLevels[i].executed)
            continue;

        double levelProfit = targetProfit * config.partialLevels[i].triggerPercent / 100.0;

        if (profit >= levelProfit)
        {
            //--- –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
            double closeVolume = volume * config.partialLevels[i].closePercent / 100.0;

            if (g_Trade.PositionClosePartial(ticket, closeVolume))
            {
                Print("–£—Ä–æ–≤–µ–Ω—å ", i + 1, ": —á–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ ", symbol,
                      " –æ–±—ä–µ–º ", closeVolume, " –ª–æ—Ç, –ø—Ä–∏–±—ã–ª—å $", profit);

                config.partialLevels[i].executed = true;
                config.partialLevels[i].executionTime = TimeCurrent();

                //--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–µ–∑—É–±—ã—Ç–æ–∫
                PM_CheckBreakevenCondition(symbol, ticket, config, i,
                                           profit, openPrice, currentSL,
                                           currentTP, type, currentPrice, point);
            }
            break;
        }
    }
}

//--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ª–æ–≤–∏–µ –±–µ–∑—É–±—ã—Ç–∫–∞
void PM_CheckBreakevenCondition(string symbol, ulong ticket, SInstrumentConfig &config, int levelIdx,
                                double profit, double openPrice, double currentSL,
                                double currentTP, ENUM_POSITION_TYPE type, double currentPrice, double point)
{
    if (config.partialLevels[levelIdx].breakevenMode == BE_MODE_NONE)
        return;
    if (currentSL == openPrice)
        return;

    bool moveToBreakeven = false;

    switch (config.partialLevels[levelIdx].breakevenMode)
    {
    case BE_MODE_FIXED_MONEY:
    {
        if (profit >= config.partialLevels[levelIdx].breakevenValue)
            moveToBreakeven = true;
        break;
    }

    case BE_MODE_FIXED_PIPS:
    {
        double requiredPips = config.partialLevels[levelIdx].breakevenValue;
        double requiredMove = requiredPips * point;

        if (type == POSITION_TYPE_BUY)
        {
            if (currentPrice >= openPrice + requiredMove)
                moveToBreakeven = true;
        }
        else // SELL
        {
            if (currentPrice <= openPrice - requiredMove)
                moveToBreakeven = true;
        }
        break;
    }

    case BE_MODE_PERCENT_TO_TP:
    {
        if (config.calculatedTPPrice > 0 && config.tpDistancePips > 0)
        {
            double currentMove = MathAbs(currentPrice - openPrice) / point;
            double percentToTP = (currentMove / config.tpDistancePips) * 100.0;

            if (percentToTP >= config.partialLevels[levelIdx].breakevenValue)
                moveToBreakeven = true;
        }
        break;
    }
    }

    //--- –ü—Ä–∏–º–µ–Ω–∏—Ç—å –±–µ–∑—É–±—ã—Ç–æ–∫
    if (moveToBreakeven)
    {
        if (g_Trade.PositionModify(ticket, openPrice, currentTP))
        {
            Print("–£—Ä–æ–≤–µ–Ω—å ", levelIdx + 1, ": SL –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ –±–µ–∑—É–±—ã—Ç–æ–∫ –Ω–∞ —Ü–µ–Ω—É ", openPrice);
            config.currentSL = openPrice;
        }
    }
}

//--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø
void PM_CheckTrailingStop(string symbol, ulong ticket, SInstrumentConfig &config)
{
    if (config.tsMode == TS_NONE)
        return;
    if (!PositionSelectByTicket(ticket))
        return;

    double currentPrice = PositionGetDouble(POSITION_PRICE_CURRENT);
    double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);
    double currentSL = PositionGetDouble(POSITION_SL);
    double currentTP = PositionGetDouble(POSITION_TP);
    ENUM_POSITION_TYPE type = (ENUM_POSITION_TYPE)PositionGetInteger(POSITION_TYPE);
    double profit = PositionGetDouble(POSITION_PROFIT);
    double point = SymbolInfoDouble(symbol, SYMBOL_POINT);

    if (profit < config.tsStartProfit)
        return;

    double newSL = currentSL;

    // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –î–û switch
    double priceMove = 0;
    double trailDistance = 0;
    double atrValue = 0;

    switch (config.tsMode)
    {
    case TS_FIXED:
        if (type == POSITION_TYPE_BUY)
        {
            newSL = currentPrice - config.tsStep * point;
            if (newSL > currentSL)
                newSL = MathMax(newSL, openPrice + config.tsLockProfit * point);
        }
        else // SELL
        {
            newSL = currentPrice + config.tsStep * point;
            if (newSL < currentSL)
                newSL = MathMin(newSL, openPrice - config.tsLockProfit * point);
        }
        break;

    case TS_PERCENT:
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        priceMove = MathAbs(currentPrice - openPrice);
        trailDistance = priceMove * config.tsStep / 100.0;
        if (type == POSITION_TYPE_BUY)
        {
            newSL = currentPrice - trailDistance;
            if (newSL > currentSL)
                newSL = MathMax(newSL, openPrice + priceMove * config.tsLockProfit / 100.0);
        }
        else // SELL
        {
            newSL = currentPrice + trailDistance;
            if (newSL < currentSL)
                newSL = MathMin(newSL, openPrice - priceMove * config.tsLockProfit / 100.0);
        }
        break;

    case TS_ATR:
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        atrValue = iATR(symbol, config.atrTimeframe, config.atrPeriod);
        if (atrValue > 0)
        {
            if (type == POSITION_TYPE_BUY)
            {
                newSL = currentPrice - atrValue * config.tsStep;
                if (newSL > currentSL)
                    newSL = MathMax(newSL, openPrice + atrValue * config.tsLockProfit);
            }
            else // SELL
            {
                newSL = currentPrice + atrValue * config.tsStep;
                if (newSL < currentSL)
                    newSL = MathMin(newSL, openPrice - atrValue * config.tsLockProfit);
            }
        }
        break;
    }

    if (newSL != currentSL && newSL > 0)
    {
        if (g_Trade.PositionModify(ticket, newSL, currentTP))
        {
            Print("–¢—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø: ", symbol, " SL ", currentSL, " -> ", newSL);
        }
    }
}

//+------------------------------------------------------------------+
//|            –§–£–ù–ö–¶–ò–ò TREND FILTER (–ú–æ–¥—É–ª—å 3)                      |
//+------------------------------------------------------------------+

//--- –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
int TF_GetRecommendation(string symbol,
                         ENUM_TIMEFRAMES tf1 = PERIOD_H1,
                         ENUM_TIMEFRAMES tf2 = PERIOD_H4,
                         int maPeriod = 89,
                         ENUM_MA_METHOD maMethod = MODE_SMA)
{
    //--- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    double ma1 = 0, ma2 = 0, price = 0;

    //--- –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∑–∞–∫—Ä—ã—Ç–∏—è
    double closeBuffer[];
    ArraySetAsSeries(closeBuffer, true);
    if (CopyClose(symbol, tf1, 0, 1, closeBuffer) > 0)
    {
        price = closeBuffer[0];
    }
    else
    {
        Print("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã –¥–ª—è ", symbol);
        return 0;
    }

    //--- –ü–æ–ª—É—á–∞–µ–º MA1
    double maBuffer1[];
    ArraySetAsSeries(maBuffer1, true);
    int maHandle1 = iMA(symbol, tf1, maPeriod, 0, maMethod, PRICE_CLOSE);

    if (maHandle1 != INVALID_HANDLE)
    {
        if (CopyBuffer(maHandle1, 0, 0, 1, maBuffer1) > 0)
        {
            ma1 = maBuffer1[0];
        }
        IndicatorRelease(maHandle1);
    }

    //--- –ü–æ–ª—É—á–∞–µ–º MA2
    double maBuffer2[];
    ArraySetAsSeries(maBuffer2, true);
    int maHandle2 = iMA(symbol, tf2, maPeriod, 0, maMethod, PRICE_CLOSE);

    if (maHandle2 != INVALID_HANDLE)
    {
        if (CopyBuffer(maHandle2, 0, 0, 1, maBuffer2) > 0)
        {
            ma2 = maBuffer2[0];
        }
        IndicatorRelease(maHandle2);
    }

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    if (ma1 == 0 || ma2 == 0)
    {
        Print("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è MA –¥–ª—è ", symbol, ": ma1=", ma1, ", ma2=", ma2);
        return 0;
    }

    //--- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç—Ä–µ–Ω–¥
    bool uptrend = (price > ma1) && (price > ma2);
    bool downtrend = (price < ma1) && (price < ma2);

    if (uptrend)
        return 1; // LONG
    if (downtrend)
        return 2; // SHORT

    return 0; // NO TRADE (–±–æ–∫–æ–≤–∏–∫)
}

//+------------------------------------------------------------------+
//|                    –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò                      |
//+------------------------------------------------------------------+

//--- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—É –ø–æ —à–∞–≥—É —Å–∏–º–≤–æ–ª–∞
double NormalizePrice(string symbol, double price)
{
    int digits = (int)SymbolInfoInteger(symbol, SYMBOL_DIGITS);
    return NormalizeDouble(price, digits);
}

//--- –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
string GetDirectionString(int direction)
{
    switch (direction)
    {
    case 1:
        return "LONG";
    case 2:
        return "SHORT";
    default:
        return "NO TRADE";
    }
}

//--- –ü–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
string ErrorDescription(int errorCode)
{
    switch (errorCode)
    {
    case 0:
        return "–ù–µ—Ç –æ—à–∏–±–∫–∏";
    case 1:
        return "–ù–µ—Ç –æ—à–∏–±–∫–∏, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω";
    case 2:
        return "–û–±—â–∞—è –æ—à–∏–±–∫–∞";
    case 3:
        return "–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã";
    case 4:
        return "–¢–æ—Ä–≥–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –∑–∞–Ω—è—Ç";
    case 5:
        return "–°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞";
    case 6:
        return "–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Ç–æ—Ä–≥–æ–≤—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º";
    case 7:
        return "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤";
    case 8:
        return "–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã";
    case 9:
        return "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–∞—Ä—É—à–∞—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞";
    case 64:
        return "–°—á–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω";
    case 65:
        return "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Å—á–µ—Ç–∞";
    case 128:
        return "–ò—Å—Ç–µ–∫ —Å—Ä–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏";
    case 129:
        return "–ù–µ–≤–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞";
    case 130:
        return "–ù–µ–≤–µ—Ä–Ω—ã–µ —Å—Ç–æ–ø—ã";
    case 131:
        return "–ù–µ–≤–µ—Ä–Ω—ã–π –æ–±—ä–µ–º";
    case 132:
        return "–†—ã–Ω–æ–∫ –∑–∞–∫—Ä—ã—Ç";
    case 133:
        return "–¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞";
    case 134:
        return "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏";
    case 135:
        return "–¶–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å";
    case 136:
        return "–ù–µ—Ç —Ü–µ–Ω";
    case 137:
        return "–ë—Ä–æ–∫–µ—Ä –∑–∞–Ω—è—Ç";
    case 138:
        return "–ù–æ–≤—ã–µ —Ü–µ–Ω—ã";
    case 139:
        return "–û—Ä–¥–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è";
    case 140:
        return "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø–æ–∫—É–ø–∫—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
    case 141:
        return "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
    case 145:
        return "–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –æ—Ä–¥–µ—Ä —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ —Ä—ã–Ω–∫—É";
    case 146:
        return "–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ –∑–∞–Ω—è—Ç–∞";
    case 147:
        return "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –±—Ä–æ–∫–µ—Ä–æ–º";
    case 148:
        return "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –¥–æ—Å—Ç–∏–≥–ª–æ –ø—Ä–µ–¥–µ–ª–∞";
    case 4000:
        return "–ù–µ—Ç –æ—à–∏–±–∫–∏";
    case 4001:
        return "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å —Ñ—É–Ω–∫—Ü–∏–∏";
    case 4002:
        return "–ò–Ω–¥–µ–∫—Å –º–∞—Å—Å–∏–≤–∞ - –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞";
    case 4003:
        return "–ù–µ—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è —Å—Ç–µ–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π";
    case 4004:
        return "–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç–µ–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞";
    case 4005:
        return "–ù–∞ —Å—Ç–µ–∫–µ –Ω–µ—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤";
    case 4006:
        return "–ù–µ—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞";
    case 4007:
        return "–ù–µ—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏";
    case 4008:
        return "–ù–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞";
    case 4009:
        return "–ù–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ –º–∞—Å—Å–∏–≤–µ";
    case 4010:
        return "–ù–µ—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –º–∞—Å—Å–∏–≤–∞";
    case 4011:
        return "–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞";
    case 4012:
        return "–û—Å—Ç–∞—Ç–æ–∫ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å";
    case 4013:
        return "–î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å";
    case 4014:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞";
    case 4015:
        return "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥";
    case 4016:
        return "–ù–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤";
    case 4017:
        return "–í—ã–∑–æ–≤—ã DLL –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã";
    case 4018:
        return "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É";
    case 4019:
        return "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é";
    case 4020:
        return "–í—ã–∑–æ–≤—ã –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã";
    case 4021:
        return "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏ –¥–ª—è —Å—Ç—Ä–æ–∫–∏, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω–æ–π –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏";
    case 4022:
        return "–°–∏—Å—Ç–µ–º–∞ –∑–∞–Ω—è—Ç–∞";
    case 4050:
        return "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏";
    case 4051:
        return "–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏";
    case 4052:
        return "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å—Ç—Ä–æ–∫–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏";
    case 4053:
        return "–û—à–∏–±–∫–∞ –º–∞—Å—Å–∏–≤–∞";
    case 4054:
        return "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞-—Ç–∞–π–º—Å–µ—Ä–∏–∏";
    case 4055:
        return "–û—à–∏–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞";
    case 4056:
        return "–ú–∞—Å—Å–∏–≤—ã –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã";
    case 4057:
        return "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö";
    case 4058:
        return "–ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞";
    case 4059:
        return "–§—É–Ω–∫—Ü–∏—è –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏";
    case 4060:
        return "–§—É–Ω–∫—Ü–∏—è –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞";
    case 4061:
        return "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—á—Ç—ã";
    case 4062:
        return "–û–∂–∏–¥–∞–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä —Ç–∏–ø–∞ string";
    case 4063:
        return "–û–∂–∏–¥–∞–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä —Ç–∏–ø–∞ integer";
    case 4064:
        return "–û–∂–∏–¥–∞–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä —Ç–∏–ø–∞ double";
    case 4065:
        return "–í –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –æ–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤";
    case 4066:
        return "–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è";
    case 4099:
        return "–ö–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞";
    case 4100:
        return "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ñ–∞–π–ª–æ–º";
    case 4101:
        return "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞";
    case 4102:
        return "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤";
    case 4103:
        return "–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª";
    case 4104:
        return "–ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É";
    case 4105:
        return "–ù–∏ –æ–¥–∏–Ω –æ—Ä–¥–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω";
    case 4106:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–∏–º–≤–æ–ª";
    case 4107:
        return "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Ü–µ–Ω—ã –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏";
    case 4108:
        return "–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞";
    case 4109:
        return "–¢–æ—Ä–≥–æ–≤–ª—è –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞";
    case 4110:
        return "–î–ª–∏–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã";
    case 4111:
        return "–ö–æ—Ä–æ—Ç–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã";
    case 4200:
        return "–û–±—ä–µ–∫—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç";
    case 4201:
        return "–ó–∞–ø—Ä–æ—à–µ–Ω–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–∞";
    case 4202:
        return "–û–±—ä–µ–∫—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç";
    case 4203:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞";
    case 4204:
        return "–ù–µ—Ç –∏–º–µ–Ω–∏ –æ–±—ä–µ–∫—Ç–∞";
    case 4205:
        return "–û—à–∏–±–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –æ–±—ä–µ–∫—Ç–∞";
    case 4206:
        return "–ù–µ –Ω–∞–π–¥–µ–Ω–æ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –ø–æ–¥–æ–∫–Ω–æ";
    case 4207:
        return "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –æ–±—ä–µ–∫—Ç–æ–º";
    default:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ (" + IntegerToString(errorCode) + ")";
    }
}

//--- –ü–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –¢–û–†–ì–û–í–û–ô –æ—à–∏–±–∫–∏ (OrderSend/PositionModify)
string TradeErrorDescription(int retcode)
{
    switch (retcode)
    {
    //--- –ö–æ–¥—ã —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    case 10009:
        return "Order activated (–æ—Ä–¥–µ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω)";
    case 10010:
        return "Modify (–æ—Ä–¥–µ—Ä –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω)";

    //--- –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –æ—à–∏–±–∫–∏
    case 10004:
        return "Requote (–ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã)";
    case 10006:
        return "Reject (–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ –±—Ä–æ–∫–µ—Ä–æ–º)";
    case 10007:
        return "Cancel (–æ—Ç–º–µ–Ω–µ–Ω–æ)";
    case 10008:
        return "Order placed (–æ—Ä–¥–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω)";
    case 10011:
        return "Order canceled (–æ—Ä–¥–µ—Ä –æ—Ç–º–µ–Ω–µ–Ω)";
    case 10012:
        return "Tick timeout (—Ç–∞–π–º–∞—É—Ç —Ç–∏–∫–∞)";
    case 10013:
        return "Invalid request (–Ω–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å)";
    case 10014:
        return "Invalid volume (–Ω–µ–≤–µ—Ä–Ω—ã–π –æ–±—ä–µ–º)";
    case 10015:
        return "Invalid price (–Ω–µ–≤–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞)";
    case 10016:
        return "Invalid stops (–Ω–µ–≤–µ—Ä–Ω—ã–µ —Å—Ç–æ–ø—ã)";
    case 10017:
        return "Trade timeout (—Ç–∞–π–º–∞—É—Ç —Ç–æ—Ä–≥–æ–≤–ª–∏)";
    case 10018:
        return "Invalid order (–Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ä–¥–µ—Ä)";
    case 10019:
        return "Trade disabled (—Ç–æ—Ä–≥–æ–≤–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∞)";
    case 10020:
        return "Market closed (—Ä—ã–Ω–æ–∫ –∑–∞–∫—Ä—ã—Ç)";
    case 10021:
        return "No money (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤)";
    case 10022:
        return "Price changed (—Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å)";
    case 10023:
        return "Off quotes (–Ω–µ—Ç –∫–æ—Ç–∏—Ä–æ–≤–æ–∫)";
    case 10024:
        return "Broker busy (–±—Ä–æ–∫–µ—Ä –∑–∞–Ω—è—Ç)";
    case 10025:
        return "Requote expired (–ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å –∏—Å—Ç–µ–∫)";
    case 10026:
        return "Order locked (–æ—Ä–¥–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)";
    case 10027:
        return "Long positions only allowed (—Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ª–æ–Ω–≥–∏)";
    case 10028:
        return "Too many requests (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤)";
    case 10029:
        return "Trade modify denied (–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞)";
    case 10030:
        return "Trade context busy (—Ç–æ—Ä–≥–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–Ω—è—Ç)";
    case 10031:
        return "Trade expiration denied (–∏—Å—Ç–µ—á–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ)";
    case 10032:
        return "Trade too many orders (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–æ–≤)";

    //--- –û—à–∏–±–∫–∏ SL/TP
    case 130:
        return "Invalid stops (–Ω–µ–≤–µ—Ä–Ω—ã–µ —Å—Ç–æ–ø-–ª–æ—Å—Å/—Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç)";
    case 131:
        return "Invalid volume (–Ω–µ–≤–µ—Ä–Ω—ã–π –æ–±—ä–µ–º)";
    case 132:
        return "Market closed (—Ä—ã–Ω–æ–∫ –∑–∞–∫—Ä—ã—Ç)";
    case 133:
        return "Trade disabled (—Ç–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞)";
    case 134:
        return "Not enough money (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤)";
    case 135:
        return "Price changed (—Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å)";
    case 136:
        return "Off quotes (–Ω–µ—Ç –∫–æ—Ç–∏—Ä–æ–≤–æ–∫)";
    case 137:
        return "Broker busy (–±—Ä–æ–∫–µ—Ä –∑–∞–Ω—è—Ç)";
    case 138:
        return "Requote (–ø–µ—Ä–µ–∑–∞–ø—Ä–æ—Å)";
    case 139:
        return "Order is locked (–æ—Ä–¥–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)";
    case 140:
        return "Long positions only allowed (—Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ª–æ–Ω–≥–∏)";
    case 145:
        return "Modification denied (–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞)";
    case 146:
        return "Trade context is busy (—Ç–æ—Ä–≥–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–Ω—è—Ç)";
    case 147:
        return "Expirations are denied (–∏—Å—Ç–µ—á–µ–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω—ã)";

    default:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–∞—è –æ—à–∏–±–∫–∞: " + IntegerToString(retcode);
    }
}

//--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–±–æ—á–∏–π –ª–∏ –¥–µ–Ω—å
bool IsTradingDay()
{
    MqlDateTime dt;
    TimeCurrent(dt);

    //--- –ù–µ —Ç–æ—Ä–≥—É–µ–º –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º
    if (dt.day_of_week == 0 || dt.day_of_week == 6)
        return false;

    //--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
    if (dt.mon == 1 && dt.day == 1)
        return false; // New Year's Day
    if (dt.mon == 1 && dt.day == 19)
        return false; // Martin Luther King Jr. Day
    if (dt.mon == 2 && dt.day == 14)
        return false; // Valentine's Day
    if (dt.mon == 2 && dt.day == 16)
        return false; // Washington's Birthday
    if (dt.mon == 3 && dt.day == 17)
        return false; // St. Patrick's Day
    if (dt.mon == 4 && dt.day == 5)
        return false; // Easter Sunday
    if (dt.mon == 4 && dt.day == 15)
        return false; // Tax Day
    if (dt.mon == 4 && dt.day == 22)
        return false; // Administrative Professionals Day
    if (dt.mon == 5 && dt.day == 10)
        return false; // Mother's Day
    if (dt.mon == 5 && dt.day == 25)
        return false; // Memorial Day
    if (dt.mon == 6 && dt.day == 19)
        return false; // Juneteenth
    if (dt.mon == 6 && dt.day == 21)
        return false; // Father's Day
    if (dt.mon == 7 && dt.day == 3)
        return false; // Independence Day
    if (dt.mon == 7 && dt.day == 4)
        return false; // Independence Day
    if (dt.mon == 9 && dt.day == 7)
        return false; // Labor Day
    if (dt.mon == 10 && dt.day == 12)
        return false; // Columbus Day
    if (dt.mon == 10 && dt.day == 31)
        return false; // Halloween
    if (dt.mon == 11 && dt.day == 11)
        return false; // Veterans Day
    if (dt.mon == 11 && dt.day == 26)
        return false; // Thanksgiving Day
    if (dt.mon == 11 && dt.day == 27)
        return false; // Day after Thanksgiving Day
    if (dt.mon == 12 && dt.day == 24)
        return false; // Christmas Eve
    if (dt.mon == 12 && dt.day == 25)
        return false; // Christmas Day
    if (dt.mon == 12 && dt.day == 31)
        return false; // New Year's Eve

    return true;
}

//--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—É—é —Å–µ—Å—Å–∏—é
bool IsTradingSession(string sessionStart = "16:00", string sessionEnd = "23:00")
{
    MqlDateTime dt;
    TimeCurrent(dt);

    int currentMinutes = dt.hour * 60 + dt.min;

    //--- –ü–∞—Ä—Å–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
    string startParts[];
    StringSplit(sessionStart, ':', startParts);
    int startMinutes = (int)StringToInteger(startParts[0]) * 60 +
                       (int)StringToInteger(startParts[1]);

    //--- –ü–∞—Ä—Å–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
    string endParts[];
    StringSplit(sessionEnd, ':', endParts);
    int endMinutes = (int)StringToInteger(endParts[0]) * 60 +
                     (int)StringToInteger(endParts[1]);

    return (currentMinutes >= startMinutes && currentMinutes <= endMinutes);
}

//+------------------------------------------------------------------+
//| –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –¢–û–†–ì–û–í–õ–ò                                  |
//+------------------------------------------------------------------+
#define GLOBAL_LOCK_VAR "SIDEZ_GLOBAL_TRADE_LOCK"

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
struct SLockInfo
{
    datetime lockTime;
    double lockReason; // 1=DailyTP, 2=DailySL, 3=WeeklyTP, 4=WeeklySL, 5=Manual
    string lockMessage;
    double dailyPnL;
    double weeklyPnL;
};

// –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
void SetGlobalTradeLock(int reason = 0, string message = "")
{
    SLockInfo lock;
    lock.lockTime = TimeCurrent();

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    if (reason > 0)
    {
        lock.lockReason = (double)reason;
    }
    else if (g_GlobalState.dailyTPReached)
    {
        lock.lockReason = 1.0;
        if (message == "")
            message = "Daily TP Reached";
    }
    else if (g_GlobalState.dailySLReached)
    {
        lock.lockReason = 2.0;
        if (message == "")
            message = "Daily SL Reached";
    }
    else if (g_GlobalState.weeklyTPReached)
    {
        lock.lockReason = 3.0;
        if (message == "")
            message = "Weekly TP Reached";
    }
    else if (g_GlobalState.weeklySLReached)
    {
        lock.lockReason = 4.0;
        if (message == "")
            message = "Weekly SL Reached";
    }
    else
    {
        lock.lockReason = 5.0; // Manual
        if (message == "")
            message = "Manual Lock";
    }

    // –û–ß–ò–©–ê–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –º—É—Å–æ—Ä–∞
    StringReplace(message, "\t", "");
    StringReplace(message, "\r", "");
    StringReplace(message, "\n", "");
    lock.lockMessage = message;

    lock.dailyPnL = g_GlobalState.dailyPnLTotal;
    lock.weeklyPnL = g_GlobalState.weeklyPnLTotal;

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
    if (!GlobalVariableCheck(GLOBAL_LOCK_VAR))
    {
        GlobalVariableSet(GLOBAL_LOCK_VAR, 0);
    }
    GlobalVariableSet(GLOBAL_LOCK_VAR, 1);

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Ñ–∞–π–ª —Å –ö–û–†–†–ï–ö–¢–ù–û–ô —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
    int handle = FileOpen("SIDEZ/TradeLock.bin", FILE_WRITE | FILE_BIN | FILE_COMMON);
    if (handle != INVALID_HANDLE)
    {
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–¥–µ–ª—å–Ω–æ
        FileWriteLong(handle, lock.lockTime);
        FileWriteDouble(handle, lock.lockReason);
        FileWriteString(handle, lock.lockMessage);
        FileWriteDouble(handle, lock.dailyPnL);
        FileWriteDouble(handle, lock.weeklyPnL);
        FileClose(handle);
    }

    Print("=== –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –£–°–¢–ê–ù–û–í–õ–ï–ù–ê ===");
    Print("–ü—Ä–∏—á–∏–Ω–∞: ", lock.lockMessage);
    Print("–í—Ä–µ–º—è: ", TimeToString(lock.lockTime));
    Print("–î–Ω–µ–≤–Ω–æ–π PnL: $", lock.dailyPnL);
    Print("–ù–µ–¥–µ–ª—å–Ω—ã–π PnL: $", lock.weeklyPnL);
}

// –§—É–Ω–∫—Ü–∏—è —Å–Ω—è—Ç–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
void RemoveGlobalTradeLock()
{
    GlobalVariableDel(GLOBAL_LOCK_VAR);
    FileDelete("SIDEZ/TradeLock.bin", FILE_COMMON);
    Print("–ì–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–Ω—è—Ç–∞");
}

bool IsGlobalTradeLockActive()
{
    // 1. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–±–µ–∑ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∫–∞–∂–¥—ã–π —Ä–∞–∑)
    static double lastCheckValue = -1;
    static datetime lastCheckTime = 0;
    static bool lastResult = false;

    // –ö–µ—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 100 –º—Å –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    if (TimeCurrent() - lastCheckTime < 100 && lastCheckValue != -1)
    {
        return lastResult;
    }

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    bool hasGlobalVar = GlobalVariableCheck(GLOBAL_LOCK_VAR);
    double varValue = hasGlobalVar ? GlobalVariableGet(GLOBAL_LOCK_VAR) : 0;

    // –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∞ —Ä–∞–≤–Ω–∞ 0 - –Ω–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    if (!hasGlobalVar || varValue <= 0)
    {
        lastCheckValue = varValue;
        lastCheckTime = TimeCurrent();
        lastResult = false;
        return false;
    }

    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª)
    static datetime lastFileCheckTime = 0;
    static datetime lastLockTimeFromFile = 0;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
    if (TimeCurrent() - lastFileCheckTime >= 1000)
    {
        if (FileIsExist("SIDEZ/TradeLock.bin", FILE_COMMON))
        {
            int handle = FileOpen("SIDEZ/TradeLock.bin", FILE_READ | FILE_BIN | FILE_COMMON);
            if (handle != INVALID_HANDLE)
            {
                // –ß–∏—Ç–∞–µ–º –ö–û–†–†–ï–ö–¢–ù–û –≤—Å–µ –ø–æ–ª—è
                lastLockTimeFromFile = (datetime)FileReadLong(handle);

                // –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä –¥–ª—è —á—Ç–µ–Ω–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
                double dummyReason = FileReadDouble(handle);
                string dummyMessage = FileReadString(handle);
                double dummyDailyPnL = FileReadDouble(handle);
                double dummyWeeklyPnL = FileReadDouble(handle);

                FileClose(handle);

                lastFileCheckTime = TimeCurrent();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∞ –ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (—Å—Ç–∞—Ä—à–µ –Ω–∞—á–∞–ª–∞ –¥–Ω—è)
                datetime startOfToday = iTime(_Symbol, PERIOD_D1, 0);
                if (lastLockTimeFromFile < startOfToday)
                {
                    // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –°–ù–Ø–¢–ò–ï –£–°–¢–ê–†–ï–í–®–ï–ô –ë–õ–û–ö–ò–†–û–í–ö–ò
                    Print("‚ö† –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–Ω—è—Ç–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Ç ",
                          TimeToString(lastLockTimeFromFile));

                    RemoveGlobalTradeLock();

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                    g_GlobalState.dailyTPReached = false;
                    g_GlobalState.dailySLReached = false;
                    g_GlobalState.weeklyTPReached = false;
                    g_GlobalState.weeklySLReached = false;
                    g_GlobalState.allowNewTrades = true;
                    g_GlobalState.blockManualTrading = false;

                    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                    Core_SaveGlobalState();

                    lastCheckValue = 0;
                    lastCheckTime = TimeCurrent();
                    lastResult = false;
                    return false;
                }
            }
        }
        lastFileCheckTime = TimeCurrent();
    }

    lastCheckValue = varValue;
    lastCheckTime = TimeCurrent();
    lastResult = true;
    return true;
}

// –§—É–Ω–∫—Ü–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –í–°–ï–• –ø–æ–∑–∏—Ü–∏–π (–£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
void ForceCloseAllPositionsInstantly()
{
    int totalPositions = PositionsTotal();
    if (totalPositions == 0)
        return;

    Print("=== –ú–ì–ù–û–í–ï–ù–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï: ", totalPositions, " –ø–æ–∑–∏—Ü–∏–π ===");
    Print("=== –î–ï–¢–ê–õ–¨–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ó–ê–ö–†–´–¢–ò–Ø ===");
    Print("–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: ", TimeToString(TimeCurrent(), TIME_SECONDS));
    Print("–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π: ", totalPositions);

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ —Ü–∏–∫–ª
    for (int attempt = 0; attempt < 5 && PositionsTotal() > 0; attempt++) // –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫
    {
        Print("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è #", attempt + 1);

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ü–∏–∫–ª–µ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è
        for (int i = PositionsTotal() - 1; i >= 0; i--)
        {
            ulong ticket = PositionGetTicket(i);
            if (ticket > 0 && PositionSelectByTicket(ticket))
            {
                string symbol = PositionGetString(POSITION_SYMBOL);
                double volume = PositionGetDouble(POSITION_VOLUME);

                Print("–ó–∞–∫—Ä—ã—Ç–∏–µ #", ticket, " ", symbol, " ", volume, " –ª–æ—Ç");

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ–º –∏ –ë–ï–ó –û–ñ–ò–î–ê–ù–ò–Ø
                CTrade trade;
                trade.SetDeviationInPoints(100); // –ë–æ–ª—å—à–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
                trade.SetAsyncMode(true);        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º

                if (!trade.PositionClose(ticket))
                {
                    Print("–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è #", ticket, " –ö–æ–¥: ", trade.ResultRetcode());
                }

                // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                Sleep(20);
            }
        }

        // –ö—Ä–∞—Ç–∫–∞—è –ø–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
        if (PositionsTotal() > 0)
            Sleep(50);
    }

    int remaining = PositionsTotal();
    if (remaining > 0)
    {
        Print("‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –æ—Å—Ç–∞–ª–æ—Å—å ", remaining, " –ø–æ–∑–∏—Ü–∏–π –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è");
        Alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä—ã—Ç—å ", remaining, " –ø–æ–∑–∏—Ü–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!");
    }
    else
    {
        Print("‚úÖ –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç—ã");
    }
}

// –§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –í–°–ï–• –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
void BlockAllPendingOrders()
{
    int totalOrders = OrdersTotal();
    if (totalOrders == 0)
        return;

    for (int i = OrdersTotal() - 1; i >= 0; i--)
    {
        ulong ticket = OrderGetTicket(i);
        if (OrderSelect(ticket))
        {
            string symbol = OrderGetString(ORDER_SYMBOL);
            Print("–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ #", ticket, " ", symbol);
            g_Trade.OrderDelete(ticket);
        }
    }
}

//+------------------------------------------------------------------+
//| –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò –¢–û–†–ì–û–í–õ–ò                         |
//+------------------------------------------------------------------+
bool IsTradeBlocked(string symbol = "")
{
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    if (GlobalVariableCheck(GLOBAL_LOCK_VAR))
    {
        double lockValue = GlobalVariableGet(GLOBAL_LOCK_VAR);
        if (lockValue > 0)
        {
            Print("üî¥ –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞: –≥–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞");
            return true;
        }
    }

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–ù–û–í–û–ï!)
    if (g_GlobalState.useWhiteList && symbol != "")
    {
        if (!IsInstrumentAllowed(symbol))
        {
            Print("üî¥ –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞: –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ", symbol, " –Ω–µ –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ");
            return true;
        }
    }

    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º)
    if (FileIsExist("SIDEZ/TradeLock.bin", FILE_COMMON))
    {
        Print("üî¥ –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞: —Ñ–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞–π–¥–µ–Ω");
        return true;
    }

    // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ RiskManager
    if (g_GlobalState.dailyTPReached || g_GlobalState.dailySLReached ||
        g_GlobalState.weeklyTPReached || g_GlobalState.weeklySLReached ||
        g_GlobalState.emergencyStop || !g_GlobalState.allowNewTrades)
    {
        Print("üî¥ –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞: –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç PnL");
        return true;
    }

    // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤)
    if (!g_GlobalState.dailyTPReached && !g_GlobalState.dailySLReached &&
        !g_GlobalState.weeklyTPReached && !g_GlobalState.weeklySLReached)
    {
        if (GlobalVariableCheck(GLOBAL_LOCK_VAR))
        {
            datetime lockTime = 0;
            string lockFile = "SIDEZ/TradeLock.bin";

            // –ß–∏—Ç–∞–µ–º –≤—Ä–µ–º—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            int handle = FileOpen(lockFile, FILE_READ | FILE_BIN | FILE_COMMON);
            if (handle != INVALID_HANDLE)
            {
                lockTime = (datetime)FileReadLong(handle);
                FileClose(handle);

                // –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–æ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è - —Å–Ω–∏–º–∞–µ–º
                if (lockTime < iTime(_Symbol, PERIOD_D1, 0))
                {
                    Print("–°–Ω–∏–º–∞–µ–º —É—Å—Ç–∞—Ä–µ–≤—à—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –æ—Ç ", TimeToString(lockTime));
                    RemoveGlobalTradeLock();
                    return false;
                }
            }
        }
    }

    return false;
}

//+------------------------------------------------------------------+
//| –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï –ü–û–ó–ò–¶–ò–ò                                   |
//+------------------------------------------------------------------+
void ClosePositionImmediately(ulong ticket, string reason)
{
    if (!PositionSelectByTicket(ticket))
        return;

    string symbol = PositionGetString(POSITION_SYMBOL);
    double volume = PositionGetDouble(POSITION_VOLUME);

    Print("üö® –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏ #", ticket, " ", symbol,
          " ", volume, " –ª–æ—Ç. –ü—Ä–∏—á–∏–Ω–∞: ", reason);

    CTrade trade;
    trade.SetDeviationInPoints(100); // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
    trade.SetAsyncMode(false);

    if (!trade.PositionClose(ticket))
    {
        Print("–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ #", ticket,
              " –ö–æ–¥: ", trade.ResultRetcode());
    }
    else
    {
        Print("‚úÖ –ü–æ–∑–∏—Ü–∏—è #", ticket, " –∑–∞–∫—Ä—ã—Ç–∞ —É—Å–ø–µ—à–Ω–æ");
    }
}

//+------------------------------------------------------------------+
//|                    –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–û–†–ì–û–í–û–ì–û –®–õ–Æ–ó–ê                  |
//+------------------------------------------------------------------+

//--- –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Å–∏–º–≤–æ–ª—É
void CloseAllSymbolPositions(string symbol, string reason = "")
{
    int count = 0;
    for (int i = PositionsTotal() - 1; i >= 0; i--)
    {
        ulong ticket = PositionGetTicket(i);
        if (PositionSelectByTicket(ticket))
        {
            if (PositionGetString(POSITION_SYMBOL) == symbol)
            {
                if (g_Trade.PositionClose(ticket))
                    count++;
                else
                    Print("–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è #", ticket, ": ", GetLastError());
            }
        }
    }
    if (count > 0)
        Print("–ó–∞–∫—Ä—ã—Ç–æ ", count, " –ø–æ–∑–∏—Ü–∏–π –ø–æ ", symbol, ". –ü—Ä–∏—á–∏–Ω–∞: ", reason);
}

//--- –ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –º–∞–≥–∏–∫–æ–≤ (–¥–ª—è RiskManager)
void ParseAllowedMagics(string magicString, string &magicArray[], int &count)
{
    string magics[];
    count = StringSplit(magicString, ',', magics);
    ArrayResize(magicArray, count);
    for (int i = 0; i < count; i++)
        magicArray[i] = StringTrim(magics[i]);
}

//--- –í–µ—Ä—Å–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–¥–ª—è RiskManager)
void ParseAllowedMagics()
{
    string magics[];
    g_AllowedMagicsCount = StringSplit(GatewayAllowedMagics, ',', magics);
    ArrayResize(g_AllowedMagicsArray, g_AllowedMagicsCount);
    for (int i = 0; i < g_AllowedMagicsCount; i++)
        g_AllowedMagicsArray[i] = StringTrim(magics[i]);

    Print("ParseAllowedMagics: –Ω–∞–π–¥–µ–Ω–æ ", g_AllowedMagicsCount, " –º–∞–≥–∏–∫–æ–≤: ", GatewayAllowedMagics);
}

//--- –¢—Ä–∏–º —Å—Ç—Ä–æ–∫–∏
string StringTrim(string str)
{
    if (str == "")
        return "";

    // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
    while (StringGetCharacter(str, 0) == ' ' || StringGetCharacter(str, 0) == '¬†')
        str = StringSubstr(str, 1);

    int len = StringLen(str);
    while (len > 0 && (StringGetCharacter(str, len - 1) == ' ' ||
                       StringGetCharacter(str, len - 1) == '¬†'))
    {
        str = StringSubstr(str, 0, len - 1);
        len = StringLen(str);
    }

    return str;
}

//+------------------------------------------------------------------+
//| –¢–û–†–ì–û–í–´–ô –®–õ–Æ–ó - –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò                                |
//+------------------------------------------------------------------+

//--- –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ –Ω–æ–º–µ—Ä–∞
bool IsMagicAllowed(long magic)
{
    string magicStr = IntegerToString(magic);
    for (int i = 0; i < g_AllowedMagicsCount; i++)
    {
        if (g_AllowedMagicsArray[i] == magicStr)
            return true;
    }
    return false;
}

//--- –û–¢–ö–†–´–¢–ò–ï POSITION (—Ä—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä)
bool Gateway_Buy(double volume, string symbol = NULL,
                 double price = 0, double sl = 0, double tp = 0,
                 string comment = "RiskManager Gateway")
{
    if (!EnableTradeGateway)
        return g_Trade.Buy(volume, symbol, price, sl, tp, comment);

    // 1. –ü–†–û–í–ï–†–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò
    if (IsTradeBlocked(symbol))
    {
        Print("Gateway: –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è ", symbol);
        Alert("–¢–û–†–ì–û–í–õ–Ø –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê! ", symbol);
        return false;
    }

    // 2. –ü–†–û–í–ï–†–ö–ê RISKMANAGER
    if (!RiskManager_IsTradeAllowed(symbol))
    {
        Print("Gateway: RiskManager –∑–∞–ø—Ä–µ—Ç–∏–ª —Ç–æ—Ä–≥–æ–≤–ª—é");
        return false;
    }

    // 3. –û–¢–ö–†–´–¢–ò–ï –ü–û–ó–ò–¶–ò–ò
    bool result;
    if (price > 0)
        result = g_TradeGateway.BuyLimit(volume, price, symbol, sl, tp, 0, 0, comment);
    else
        result = g_TradeGateway.Buy(volume, symbol, price, sl, tp, comment);

    if (result)
    {
        Print("Gateway: BUY –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ —É—Å–ø–µ—à–Ω–æ");
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —Å—Ä–∞–∑—É
    }

    return result;
}

bool Gateway_Sell(double volume, string symbol = NULL,
                  double price = 0, double sl = 0, double tp = 0,
                  string comment = "RiskManager Gateway")
{
    if (!EnableTradeGateway)
        return g_Trade.Sell(volume, symbol, price, sl, tp, comment);

    // 1. –ü–†–û–í–ï–†–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò
    if (IsTradeBlocked(symbol))
    {
        Print("Gateway: –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è ", symbol);
        Alert("–¢–û–†–ì–û–í–õ–Ø –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê! ", symbol);
        return false;
    }

    // 2. –ü–†–û–í–ï–†–ö–ê RISKMANAGER
    if (!RiskManager_IsTradeAllowed(symbol))
    {
        Print("Gateway: RiskManager –∑–∞–ø—Ä–µ—Ç–∏–ª —Ç–æ—Ä–≥–æ–≤–ª—é");
        return false;
    }

    // 3. –û–¢–ö–†–´–¢–ò–ï –ü–û–ó–ò–¶–ò–ò
    bool result;
    if (price > 0)
        result = g_TradeGateway.SellLimit(volume, price, symbol, sl, tp, 0, 0, comment);
    else
        result = g_TradeGateway.Sell(volume, symbol, price, sl, tp, comment);

    if (result)
    {
        Print("Gateway: SELL –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ —É—Å–ø–µ—à–Ω–æ");
    }

    return result;
}

//--- –û–¢–õ–û–ñ–ï–ù–ù–´–ï –û–†–î–ï–†–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
bool Gateway_OrderPending(ENUM_ORDER_TYPE type, double volume, double price,
                          string symbol = NULL, double sl = 0, double tp = 0,
                          datetime expiration = 0, string comment = "RiskManager Gateway")
{
    if (symbol == NULL)
        symbol = Symbol();

    // –ü–†–û–í–ï–†–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò
    if (IsTradeBlocked(symbol))
    {
        Print("Gateway: –¢–æ—Ä–≥–æ–≤–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞");
        return false;
    }

    // –î–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º OrderOpen —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    MqlTradeRequest request = {};
    MqlTradeResult result = {};

    request.action = TRADE_ACTION_PENDING;
    request.symbol = symbol;
    request.volume = volume;
    request.price = NormalizePrice(symbol, price);
    request.sl = (sl > 0) ? NormalizePrice(symbol, sl) : 0;
    request.tp = (tp > 0) ? NormalizePrice(symbol, tp) : 0;
    request.type = type;
    request.type_filling = ORDER_FILLING_FOK;
    request.type_time = ORDER_TIME_DAY;
    request.expiration = expiration;
    request.comment = comment;
    request.magic = MAGIC_RISK_MANAGER;

    return OrderSend(request, result);
}

//+------------------------------------------------------------------+
//| –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ù–ï–®–ù–ò–• –°–ò–ì–ù–ê–õ–û–í (–∑–∞–≥–æ—Ç–æ–≤–∫–∏)                        |
//+------------------------------------------------------------------+

//--- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
bool ProcessExternalCommand(string command)
{
    Print("–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–Ω–µ—à–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã: ", command);
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥
    return false;
}

//+------------------------------------------------------------------+
//| –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –ë–õ–û–ö–ò–†–û–í–ö–ò                                   |
//+------------------------------------------------------------------+
void CheckAndUpdateBlockStatus()
{
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã PnL —á–µ—Ä–µ–∑ RiskManager_IsTradeAllowed
    if (!RiskManager_IsTradeAllowed(""))
    {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        int reason = 0;
        if (g_GlobalState.dailyTPReached)
            reason = 1;
        else if (g_GlobalState.dailySLReached)
            reason = 2;
        else if (g_GlobalState.weeklyTPReached)
            reason = 3;
        else if (g_GlobalState.weeklySLReached)
            reason = 4;

        if (reason > 0 && !IsGlobalTradeLockActive())
        {
            SetGlobalTradeLock(reason);
            ForceCloseAllPositionsInstantly();
            Print("=== –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–ê ===");
        }
    }
}

//+------------------------------------------------------------------+
//| –ü–†–û–í–ï–†–ò–¢–¨ –õ–ò–ú–ò–¢–´ –î–õ–Ø –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê                    |
//+------------------------------------------------------------------+
bool CheckInstrumentLimits(string symbol, double volume, double riskAmount)
{
    if (!g_GlobalState.useWhiteList)
        return true;

    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ
    int instrumentIndex = -1;
    for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
    {
        if (StringCompare(g_GlobalState.allowedInstruments[i].symbol, symbol, true) == 0)
        {
            instrumentIndex = i;
            break;
        }
    }

    if (instrumentIndex == -1 || !g_GlobalState.allowedInstruments[instrumentIndex].enabled)
        return false;

    bool allChecksPassed = true;

    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–º–∞ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω)
    if (g_GlobalState.allowedInstruments[instrumentIndex].maxVolume > 0 &&
        volume > g_GlobalState.allowedInstruments[instrumentIndex].maxVolume)
    {
        Print("‚ö† –ü—Ä–µ–≤—ã—à–µ–Ω –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º –¥–ª—è ", symbol,
              ": ", volume, " > ", g_GlobalState.allowedInstruments[instrumentIndex].maxVolume);
        allChecksPassed = false;
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∏—Å–∫–∞ % (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω)
    if (g_GlobalState.allowedInstruments[instrumentIndex].maxRiskPercent > 0)
    {
        double balance = AccountInfoDouble(ACCOUNT_BALANCE);
        double maxRiskAmount = balance * g_GlobalState.allowedInstruments[instrumentIndex].maxRiskPercent / 100.0;

        if (riskAmount > maxRiskAmount)
        {
            Print("‚ö† –ü—Ä–µ–≤—ã—à–µ–Ω –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ –¥–ª—è ", symbol,
                  ": $", riskAmount, " > $", maxRiskAmount, " (",
                  g_GlobalState.allowedInstruments[instrumentIndex].maxRiskPercent, "%)");
            allChecksPassed = false;
        }
    }

    return allChecksPassed;
}

//+------------------------------------------------------------------+
//| –†–ê–°–ß–ï–¢ –°–¢–û–ò–ú–û–°–¢–ò –ü–û–ó–ò–¶–ò–ò                                       |
//+------------------------------------------------------------------+
double CalculatePositionValue(string symbol, double volume)
{
    double price = SymbolInfoDouble(symbol, SYMBOL_BID);
    double contractSize = SymbolInfoDouble(symbol, SYMBOL_TRADE_CONTRACT_SIZE);

    return volume * contractSize * price;
}

//+------------------------------------------------------------------+
//| –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –†–£–ß–ù–ê–Ø –¢–û–†–ì–û–í–õ–Ø (–ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∏ –ª–∏–º–∏—Ç–æ–≤)   |
//+------------------------------------------------------------------+
bool SafeManualTrade(string symbol, double volume, ENUM_ORDER_TYPE type,
                     double price = 0, double sl = 0, double tp = 0,
                     string comment = "Manual Trade")
{
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
    if (g_GlobalState.useWhiteList && !IsInstrumentAllowed(symbol))
    {
        Alert("‚ùå –û–®–ò–ë–ö–ê: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç " + symbol + " –Ω–µ –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ!");
        Print("–†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞ –¥–ª—è ", symbol);
        return false;
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä—É—á–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ (–ø—Ä–∏ –ª–∏–º–∏—Ç–∞—Ö)
    if (g_GlobalState.blockManualTrading)
    {
        Alert("‚ùå –û–®–ò–ë–ö–ê: –†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!");
        Print("–†—É—á–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ (–¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã –ª–∏–º–∏—Ç—ã PnL)");
        return false;
    }

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ RiskManager
    if (!RiskManager_IsTradeAllowed(symbol))
    {
        Alert("‚ùå –û–®–ò–ë–ö–ê: RiskManager –∑–∞–ø—Ä–µ—Ç–∏–ª —Ç–æ—Ä–≥–æ–≤–ª—é!");
        Print("RiskManager –∑–∞–ø—Ä–µ—Ç–∏–ª —Ç–æ—Ä–≥–æ–≤–ª—é –¥–ª—è ", symbol);
        return false;
    }

    // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã)
    double riskAmount = 0;
    if (sl != 0)
    {
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∏—Å–∫
        ENUM_POSITION_TYPE posType = (type == ORDER_TYPE_BUY) ? POSITION_TYPE_BUY : POSITION_TYPE_SELL;
        riskAmount = CalculateLossAtSL(symbol, posType, price, sl, volume);
    }

    if (!CheckInstrumentLimits(symbol, volume, riskAmount))
    {
        Alert("‚ùå –û–®–ò–ë–ö–ê: –ü—Ä–µ–≤—ã—à–µ–Ω—ã –ª–∏–º–∏—Ç—ã –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ " + symbol);
        return false;
    }

    // 5. –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ RiskManager Gateway (–¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è)
    if (EnableTradeGateway)
    {
        if (type == ORDER_TYPE_BUY)
            return Gateway_Buy(volume, symbol, price, sl, tp, comment);
        else if (type == ORDER_TYPE_SELL)
            return Gateway_Sell(volume, symbol, price, sl, tp, comment);
    }

    // 6. –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é (–µ—Å–ª–∏ —à–ª—é–∑ –≤—ã–∫–ª—é—á–µ–Ω)
    CTrade trade;
    trade.SetDeviationInPoints(10);

    if (type == ORDER_TYPE_BUY)
        return trade.Buy(volume, symbol, price, sl, tp, comment);
    else if (type == ORDER_TYPE_SELL)
        return trade.Sell(volume, symbol, price, sl, tp, comment);

    return false;
}

//+------------------------------------------------------------------+

//+------------------------------------------------------------------+
//|                                               SIDEZ_PositionManager.mq5 |
//|                              Copyright ¬© 2025, SIDEZ LLC          |
//|                                             https://www.sidez.ru  |
//+------------------------------------------------------------------+
#property copyright "Copyright ¬© 2025, SIDEZ LLC"
#property link "https://www.sidez.ru"
#property version "1.0"
#property description "–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–∑–∏—Ü–∏–π —Å —Ç—Ä–µ–Ω–¥–æ–≤—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º"
#property strict

//--- –í–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
#include "..\Include\SIDEZ_CoreLib.mqh" // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–≥–ª–æ–≤—ã–µ —Å–∫–æ–±–∫–∏

//+------------------------------------------------------------------+
//|                         –í–•–û–î–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´                        |
//+------------------------------------------------------------------+

input group "=== –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Position Manager ===" input string PM_Name = "SIDEZ Position Manager"; // –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–≤–µ—Ç–Ω–∏–∫–∞
input bool TradeCurrentSymbolOnly = true;                                                                  // –¢–æ—Ä–≥–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —Å–∏–º–≤–æ–ª
input bool AutoApplyToNewPositions = true;                                                                 // –ê–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π
input bool ApplySLTPToPendingOrders = true;                                                                // –ü—Ä–∏–º–µ–Ω—è—Ç—å SL/TP –∫ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º –æ—Ä–¥–µ—Ä–∞–º
input bool AllowSLAdjustmentByRiskManager = true;                                                          // –†–∞–∑—Ä–µ—à–∏—Ç—å RiskManager –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å SL
input int CheckInterval = 30;                                                                              // –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ç–∏–∫–∏)

input group "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Stop Loss ===" input ENUM_SL_MODE SL_Mode = SL_PIPS; // –†–µ–∂–∏–º —Ä–∞—Å—á–µ—Ç–∞ SL
input double SL_Value = 50.0;                                                   // –ó–Ω–∞—á–µ–Ω–∏–µ SL
input double SL_ATR_Multiplier = 2.0;                                           // –ú–Ω–æ–∂–∏—Ç–µ–ª—å ATR –¥–ª—è SL
input int SL_ATR_Period = 14;                                                   // –ü–µ—Ä–∏–æ–¥ ATR
input ENUM_TIMEFRAMES SL_ATR_Timeframe = PERIOD_H1;                             // –¢–∞–π–º—Ñ—Ä–µ–π–º ATR

input group "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Take Profit ===" input ENUM_TP_MODE TP_Mode = TP_RR; // –†–µ–∂–∏–º —Ä–∞—Å—á–µ—Ç–∞ TP
input double TP_Value = 100.0;                                                  // –ó–Ω–∞—á–µ–Ω–∏–µ TP
input double TP_ATR_Multiplier = 1.4;                                           // –ú–Ω–æ–∂–∏—Ç–µ–ª—å ATR –¥–ª—è TP
input double RR_Ratio = 2.0;                                                    // Risk/Reward ratio
input int TP_ATR_Period = 14;                                                   // –ü–µ—Ä–∏–æ–¥ ATR
input ENUM_TIMEFRAMES TP_ATR_Timeframe = PERIOD_D1;                             // –¢–∞–π–º—Ñ—Ä–µ–π–º ATR

input group "=== –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–£—Ä–æ–≤–µ–Ω—å 1) ===" input bool PC_Level1_Enabled = true; // –í–∫–ª—é—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å 1
input double PC_Level1_Trigger = 30.0;                                                    // % –æ—Ç TP –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
input double PC_Level1_ClosePercent = 30.0;                                               // % –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
input ENUM_BREAKEVEN_MODE PC_Level1_BEMode = BE_MODE_FIXED_MONEY;                         // –†–µ–∂–∏–º –±–µ–∑—É–±—ã—Ç–∫–∞
input double PC_Level1_BEValue = 100.0;                                                   // –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –±–µ–∑—É–±—ã—Ç–∫–∞

input group "=== –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–£—Ä–æ–≤–µ–Ω—å 2) ===" input bool PC_Level2_Enabled = true; // –í–∫–ª—é—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å 2
input double PC_Level2_Trigger = 60.0;                                                    // % –æ—Ç TP –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
input double PC_Level2_ClosePercent = 30.0;                                               // % –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
input ENUM_BREAKEVEN_MODE PC_Level2_BEMode = BE_MODE_PERCENT_TO_TP;                       // –†–µ–∂–∏–º –±–µ–∑—É–±—ã—Ç–∫–∞
input double PC_Level2_BEValue = 80.0;                                                    // –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –±–µ–∑—É–±—ã—Ç–∫–∞

input group "=== –ß–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–£—Ä–æ–≤–µ–Ω—å 3) ===" input bool PC_Level3_Enabled = true; // –í–∫–ª—é—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å 3
input double PC_Level3_Trigger = 100.0;                                                   // % –æ—Ç TP –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
input double PC_Level3_ClosePercent = 40.0;                                               // % –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
input ENUM_BREAKEVEN_MODE PC_Level3_BEMode = BE_MODE_FIXED_PIPS;                          // –†–µ–∂–∏–º –±–µ–∑—É–±—ã—Ç–∫–∞
input double PC_Level3_BEValue = 50.0;                                                    // –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –±–µ–∑—É–±—ã—Ç–∫–∞

input group "=== –¢—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø ===" input ENUM_TS_MODE TS_Mode = TS_FIXED; // –†–µ–∂–∏–º —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞
input double TS_StartProfit = 50.0;                                        // –ü—Ä–∏–±—ã–ª—å –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞ ($)
input double TS_Step = 20.0;                                               // –®–∞–≥ —Ç—Ä–µ–π–ª–∏–Ω–≥–∞ (–ø—É–Ω–∫—Ç—ã/$/%)
input double TS_LockProfit = 10.0;                                         // –§–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–±—ã–ª—å (–ø—É–Ω–∫—Ç—ã/$)

input group "=== –¢—Ä–µ–Ω–¥–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä (–ú–æ–¥—É–ª—å 3) ===" input bool EnableTrendFilter = true; // –í–∫–ª—é—á–∏—Ç—å —Ç—Ä–µ–Ω–¥–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
input ENUM_TIMEFRAMES Trend_TF1 = PERIOD_H1;                                           // –¢–∞–π–º—Ñ—Ä–µ–π–º 1 –¥–ª—è —Ç—Ä–µ–Ω–¥–∞
input ENUM_TIMEFRAMES Trend_TF2 = PERIOD_H4;                                           // –¢–∞–π–º—Ñ—Ä–µ–π–º 2 –¥–ª—è —Ç—Ä–µ–Ω–¥–∞
input int Trend_MA_Period = 89;                                                        // –ü–µ—Ä–∏–æ–¥ MA
input ENUM_MA_METHOD Trend_MA_Method = MODE_SMA;                                       // –ú–µ—Ç–æ–¥ MA
input bool ShowRecommendationPanel = true;                                             // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–∞–Ω–µ–ª—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

//+------------------------------------------------------------------+
//|                    –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï                        |
//+------------------------------------------------------------------+
int g_TickCounter = 0;
bool g_IsInitialized = false;
string g_CurrentSymbol = "";
SInstrumentConfig g_PMConfig; // –õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PM
int g_LastRecommendation = 0;
datetime g_LastRecommendationTime = 0;

color g_PanelBgColor = clrBlack;
color g_PanelTextColor = clrWhite;
int g_PanelX = 20;
int g_PanelY = 20;

int OnInit()
{
    Print("========================================");
    Print(PM_Name, " v", CORE_VERSION, " –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");

    //--- –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –û–î–ò–ù –†–ê–ó!
    g_CurrentSymbol = Symbol();
    ZeroMemory(g_PMConfig);
    g_PMConfig.symbol = g_CurrentSymbol;
    g_PMConfig.contractSize = SymbolInfoDouble(g_CurrentSymbol, SYMBOL_TRADE_CONTRACT_SIZE);
    g_PMConfig.tickValue = SymbolInfoDouble(g_CurrentSymbol, SYMBOL_TRADE_TICK_VALUE);
    g_PMConfig.tickSize = SymbolInfoDouble(g_CurrentSymbol, SYMBOL_TRADE_TICK_SIZE);
    g_PMConfig.point = SymbolInfoDouble(g_CurrentSymbol, SYMBOL_POINT);
    g_PMConfig.minLot = SymbolInfoDouble(g_CurrentSymbol, SYMBOL_VOLUME_MIN);
    g_PMConfig.lotStep = SymbolInfoDouble(g_CurrentSymbol, SYMBOL_VOLUME_STEP);
    g_PMConfig.maxPositionVolume = SymbolInfoDouble(g_CurrentSymbol, SYMBOL_VOLUME_MAX);
    g_PMConfig.enabled = true; // –í–°–Å! –ë–æ–ª—å—à–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º!

    //--- –ü–†–û–í–ï–†–ö–ê –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–ò (–∏—Å–ø–æ–ª—å–∑—É–µ–º g_PMConfig –ø–æ—Å–ª–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è)
    Print("=== –ü–†–û–í–ï–†–ö–ê –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–ò ", g_CurrentSymbol, " ===");
    Print("–ö–æ–Ω—Ç—Ä–∞–∫—Ç: ", g_PMConfig.contractSize); // ‚Üê g_PMConfig, –∞ –Ω–µ g_Config!
    Print("–¢–∏–∫: $", g_PMConfig.tickValue, " / —Ä–∞–∑–º–µ—Ä: ", g_PMConfig.tickSize);
    Print("–ü—É–Ω–∫—Ç: ", g_PMConfig.point);
    Print("–ú–∏–Ω. –ª–æ—Ç: ", g_PMConfig.minLot);
    Print("–®–∞–≥ –ª–æ—Ç–∞: ", g_PMConfig.lotStep);
    Print("–ú–∞–∫—Å. –æ–±—ä–µ–º: ", g_PMConfig.maxPositionVolume);
    Print("–í–∫–ª—é—á–µ–Ω: ", g_PMConfig.enabled ? "–î–ê" : "–ù–ï–¢");

    if (g_PMConfig.contractSize <= 0 || g_PMConfig.tickValue <= 0)
    {
        Alert("‚ùå –û–®–ò–ë–ö–ê: –ù–µ–≤–µ—Ä–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è ", g_CurrentSymbol);
        return (INIT_FAILED);
    }

    Print("‚úÖ –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
    Print("========================================");

    bool LoadWhiteListForPositionManager()
    {
        // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        if (LoadWhiteListFromSync())
        {
            Print("PositionManager: –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏");
            return true;
        }

        // –ï—Å–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        Print("PositionManager: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞");

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∏–º–≤–æ–ª—ã —á–∏—Å—Ç—ã–µ
        for (int i = 0; i < g_GlobalState.allowedInstrumentsCount; i++)
        {
            string symbol = g_GlobalState.allowedInstruments[i].symbol;
            StringReplace(symbol, " ", "");
            StringReplace(symbol, " ", "");
            StringToUpper(symbol);
            g_GlobalState.allowedInstruments[i].symbol = symbol;
        }

        return g_GlobalState.allowedInstrumentsCount > 0;
    }

    //--- –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (!Core_LoadGlobalState())
    {
        Print("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è");
        return (INIT_FAILED);
    }

    //--- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã —Ç–æ—Ä–≥–æ–≤–ª–∏
    g_Trade.SetExpertMagicNumber(MAGIC_POSITION_MANAGER);
    g_Trade.SetDeviationInPoints(10);

    //--- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Ä–æ–≤–Ω–∏ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è (–≤ g_PMConfig)
    PM_InitPartialLevels(g_PMConfig.partialLevels, g_PMConfig.partialLevelsCount,
                         PC_Level1_Enabled, PC_Level1_Trigger, PC_Level1_ClosePercent,
                         PC_Level1_BEMode, PC_Level1_BEValue,
                         PC_Level2_Enabled, PC_Level2_Trigger, PC_Level2_ClosePercent,
                         PC_Level2_BEMode, PC_Level2_BEValue,
                         PC_Level3_Enabled, PC_Level3_Trigger, PC_Level3_ClosePercent,
                         PC_Level3_BEMode, PC_Level3_BEValue);

    //--- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SL/TP (–≤ g_PMConfig)
    g_PMConfig.slMode = SL_Mode;
    g_PMConfig.tpMode = TP_Mode;
    g_PMConfig.slValue = SL_Value;
    g_PMConfig.tpValue = TP_Value;
    g_PMConfig.atrMultiplierSL = SL_ATR_Multiplier;
    g_PMConfig.atrMultiplierTP = TP_ATR_Multiplier;
    g_PMConfig.atrPeriod = SL_ATR_Period;
    g_PMConfig.atrTimeframe = SL_ATR_Timeframe;
    g_PMConfig.rrRatio = RR_Ratio;

    //--- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞ (–≤ g_PMConfig)
    g_PMConfig.tsMode = TS_Mode;
    g_PMConfig.tsStartProfit = TS_StartProfit;
    g_PMConfig.tsStep = TS_Step;
    g_PMConfig.tsLockProfit = TS_LockProfit;

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ç–æ—Ä–≥–æ–≤–ª—é –æ—Ç RiskManager
    if (!RiskManager_IsTradeAllowed(g_CurrentSymbol))
    {
        Print("–í–ù–ò–ú–ê–ù–ò–ï: RiskManager –∑–∞–ø—Ä–µ—Ç–∏–ª —Ç–æ—Ä–≥–æ–≤–ª—é –¥–ª—è ", g_CurrentSymbol);
    }

    //--- –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    if (ShowRecommendationPanel)
    {
        CreateRecommendationPanel();
    }

    Print("–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ", g_CurrentSymbol);
    Print("–ö–æ–Ω—Ç—Ä–∞–∫—Ç: ", DoubleToString(g_PMConfig.contractSize, 0));
    Print("–¢–∏–∫: $", DoubleToString(g_PMConfig.tickValue, 2), " / ", DoubleToString(g_PMConfig.tickSize, 5));
    Print("Min –ª–æ—Ç: ", DoubleToString(g_PMConfig.minLot, 2));
    Print("–†–∞–∑—Ä–µ—à–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è SL RiskManager: ", AllowSLAdjustmentByRiskManager ? "–î–∞" : "–ù–µ—Ç");
    Print("========================================");

    g_IsInitialized = true;
    return (INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (PositionManager)               |
//+------------------------------------------------------------------+
bool CheckGlobalTradeLock()
{
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ú–ì–ù–û–í–ï–ù–ù–û –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫
    if (GlobalVariableCheck(GLOBAL_LOCK_VAR))
    {
        double lockValue = GlobalVariableGet(GLOBAL_LOCK_VAR);
        if (lockValue > 0)
        {
            // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            if (FileIsExist("SIDEZ/TradeLock.bin", FILE_COMMON))
            {
                Print("üî¥ PositionManager: –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –ê–ö–¢–ò–í–ù–ê - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ!");

                // –ù–ï–ú–ï–î–õ–ï–ù–ù–û –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏
                CloseAllSymbolPositions(g_CurrentSymbol, "Global Lock Detected");
                DeleteAllPendingOrders(g_CurrentSymbol, "Global Lock Detected");

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º
                Sleep(100);

                return true;
            }
        }
    }

    return false;
}

//+------------------------------------------------------------------+
//| –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º)       |
//+------------------------------------------------------------------+

int GetPositionsCount(string symbol)
{
    int count = 0;
    for (int i = 0; i < PositionsTotal(); i++)
    {
        ulong ticket = PositionGetTicket(i);
        if (PositionSelectByTicket(ticket) && PositionGetString(POSITION_SYMBOL) == symbol)
            count++;
    }
    return count;
}

int GetPendingOrdersCount(string symbol)
{
    int count = 0;
    for (int i = 0; i < OrdersTotal(); i++)
    {
        ulong ticket = OrderGetTicket(i);
        if (OrderSelect(ticket) && OrderGetString(ORDER_SYMBOL) == symbol)
        {
            ENUM_ORDER_TYPE type = (ENUM_ORDER_TYPE)OrderGetInteger(ORDER_TYPE);
            if (type == ORDER_TYPE_BUY_LIMIT || type == ORDER_TYPE_SELL_LIMIT ||
                type == ORDER_TYPE_BUY_STOP || type == ORDER_TYPE_SELL_STOP)
                count++;
        }
    }
    return count;
}

//+------------------------------------------------------------------+
//| Expert tick function (PositionManager)                          |
//+------------------------------------------------------------------+
void OnTick()
{
    if (!g_IsInitialized || !g_PMConfig.enabled)
        return;

    // --- –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ë–õ–û–ö–ò–†–û–í–ö–ò (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è) ---
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ç–∏–∫–µ –≤ —Ü–∏–∫–ª–µ –∏–ª–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
    static bool lastBlockStatus = false;
    bool currentBlockStatus = IsGlobalTradeLockActive();

    if (currentBlockStatus)
    {
        // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if (currentBlockStatus != lastBlockStatus || lastBlockStatus == false)
        {
            Print("üî¥ PositionManager: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞");
            lastBlockStatus = currentBlockStatus;
        }

        // –ù–ï–ú–ï–î–õ–ï–ù–ù–û –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        if (GetPositionsCount(g_CurrentSymbol) > 0)
        {
            CloseAllSymbolPositions(g_CurrentSymbol, "Global Trade Lock Active");
            // –ù–µ –≤—ã—Ö–æ–¥–∏–º —Å—Ä–∞–∑—É - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏
        }

        // –£–¥–∞–ª—è–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞
        if (GetPendingOrdersCount(g_CurrentSymbol) > 0)
        {
            // –£–¥–∞–ª—è–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –≤—Ä—É—á–Ω—É—é
            for (int i = OrdersTotal() - 1; i >= 0; i--)
            {
                ulong ticket = OrderGetTicket(i);
                if (OrderSelect(ticket) && OrderGetString(ORDER_SYMBOL) == g_CurrentSymbol)
                {
                    ENUM_ORDER_TYPE type = (ENUM_ORDER_TYPE)OrderGetInteger(ORDER_TYPE);
                    if (type == ORDER_TYPE_BUY_LIMIT || type == ORDER_TYPE_SELL_LIMIT ||
                        type == ORDER_TYPE_BUY_STOP || type == ORDER_TYPE_SELL_STOP)
                    {
                        g_Trade.OrderDelete(ticket);
                    }
                }
            }
        }

        // –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è - –≤—ã—Ö–æ–¥–∏–º –∏–∑ OnTick
        if (GetPositionsCount(g_CurrentSymbol) == 0)
            return;
    }
    else
    {
        lastBlockStatus = false;
    }

    // --- –í–¢–û–†–ê–Ø –ü–†–û–í–ï–†–ö–ê: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç RiskManager ---
    if (!RiskManager_IsTradeAllowed(g_CurrentSymbol))
    {
        if (GetPositionsCount(g_CurrentSymbol) > 0)
        {
            CloseAllSymbolPositions(g_CurrentSymbol, "RiskManager Block");
            // –£–¥–∞–ª—è–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –≤—Ä—É—á–Ω—É—é
            for (int i = OrdersTotal() - 1; i >= 0; i--)
            {
                ulong ticket = OrderGetTicket(i);
                if (OrderSelect(ticket) && OrderGetString(ORDER_SYMBOL) == g_CurrentSymbol)
                {
                    ENUM_ORDER_TYPE type = (ENUM_ORDER_TYPE)OrderGetInteger(ORDER_TYPE);
                    if (type == ORDER_TYPE_BUY_LIMIT || type == ORDER_TYPE_SELL_LIMIT ||
                        type == ORDER_TYPE_BUY_STOP || type == ORDER_TYPE_SELL_STOP)
                    {
                        g_Trade.OrderDelete(ticket);
                    }
                }
            }
        }
        return;
    }

    g_TickCounter++;

    //--- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –Ω–∞ –∫–∞–∂–¥–æ–º —Ç–∏–∫–µ
    if (g_TickCounter % CheckInterval != 0)
        return;

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ç–æ—Ä–≥–æ–≤–ª—é
    if (!RiskManager_IsTradeAllowed(g_CurrentSymbol))
    {
        // –ï—Å–ª–∏ —Ç–æ—Ä–≥–æ–≤–ª—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞, –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
        CloseAllSymbolPositions(g_CurrentSymbol, "Trade not allowed by RiskManager");
        // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º –≤—Å–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞
        DeleteAllPendingOrders(g_CurrentSymbol, "Trade not allowed by RiskManager");
        return;
    }

    //--- –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–õ–û–ñ–ï–ù–ù–´–• –û–†–î–ï–†–û–í (–í–°–ï–ì–î–ê!)
    ProcessPendingOrders();

    //--- –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
    int positionsCount = GetPositionsCount(g_CurrentSymbol);

    if (positionsCount > 0)
    {
        //--- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é
        for (int i = PositionsTotal() - 1; i >= 0; i--)
        {
            ulong ticket = PositionGetTicket(i);
            if (PositionSelectByTicket(ticket))
            {
                string posSymbol = PositionGetString(POSITION_SYMBOL);

                if (posSymbol == g_CurrentSymbol || !TradeCurrentSymbolOnly)
                {
                    //--- –í–°–ï–ì–î–ê –ø—Ä–∏–º–µ–Ω—è–µ–º/–ø—Ä–æ–≤–µ—Ä—è–µ–º SL/TP –∫ –ø–æ–∑–∏—Ü–∏—è–º
                    PM_ApplySLTPWithRiskManagerCheck(ticket);

                    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–∏—á–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
                    PM_CheckPartialClose(posSymbol, ticket, g_PMConfig);

                    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø
                    PM_CheckTrailingStop(posSymbol, ticket, g_PMConfig);

                    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                    CheckAutoCloseByTime(posSymbol, ticket);

                    //--- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ SL
                    if (g_TickCounter % 100 == 0)
                    {
                        ValidateSLWithRiskManagerLimits(ticket);
                    }
                }
            }
        }
    }

    //--- –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    if (ShowRecommendationPanel)
    {
        UpdateRecommendationPanel();
    }

    //--- –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 200 —Ç–∏–∫–æ–≤
    if (g_TickCounter % 200 == 0)
    {
        Print("PM Status: ", g_CurrentSymbol,
              " | Positions: ", positionsCount,
              " | Recommendation: ", GetDirectionString(g_LastRecommendation),
              " | SL Mode: ", EnumToString(g_PMConfig.slMode),
              " | TP Mode: ", EnumToString(g_PMConfig.tpMode));
    }
}

//+------------------------------------------------------------------+
//| –ü—Ä–∏–º–µ–Ω–∏—Ç—å SL/TP –∫ –ø–æ–∑–∏—Ü–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π RiskManager                   |
//+------------------------------------------------------------------+
bool PM_ApplySLTPWithRiskManagerCheck(ulong ticket)
{
    if (!PositionSelectByTicket(ticket))
    {
        Print("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é #", ticket);
        return false;
    }

    string symbol = PositionGetString(POSITION_SYMBOL);
    ENUM_POSITION_TYPE type = (ENUM_POSITION_TYPE)PositionGetInteger(POSITION_TYPE);
    double price = PositionGetDouble(POSITION_PRICE_OPEN);
    double volume = PositionGetDouble(POSITION_VOLUME);
    double currentSL = PositionGetDouble(POSITION_SL);
    double currentTP = PositionGetDouble(POSITION_TP);

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º SL/TP –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º PM
    double slPrice = 0, tpPrice = 0;
    if (!CalculateSLTPForPosition(symbol, type, price, volume, g_PMConfig, slPrice, tpPrice))
    {
        Print("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ SL/TP –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ #", ticket);
        return false;
    }

    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –î–û –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ RiskManager
    double originalSLBeforeRiskManager = slPrice;
    double originalTPBeforeRiskManager = tpPrice;

    //--- –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º SL –ø–æ–¥ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã RiskManager (–í–°–ï–ì–î–ê!)
    if (!RiskManager_AdjustSLForLimits(symbol, type, price, volume, slPrice, tpPrice))
    {
        Print("RiskManager: —Ä–∏—Å–∫ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç—ã. –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é #", ticket);
        g_Trade.PositionClose(ticket);
        return false;
    }

    //--- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ü–µ–Ω—ã
    slPrice = NormalizePrice(symbol, slPrice);
    tpPrice = NormalizePrice(symbol, tpPrice);

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–æ–æ–±—â–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å
    bool needModify = false;

    // –ï—Å–ª–∏ SL/TP –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
    if (currentSL == 0 && currentTP == 0)
    {
        needModify = true;
    }
    // –ï—Å–ª–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∏–ª—å–Ω–æ –ª–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è
    else
    {
        double slDiffPips = MathAbs(currentSL - slPrice) / SymbolInfoDouble(symbol, SYMBOL_POINT);
        double tpDiffPips = MathAbs(currentTP - tpPrice) / SymbolInfoDouble(symbol, SYMBOL_POINT);

        // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –±–æ–ª—å—à–µ 5 –ø—É–Ω–∫—Ç–æ–≤ –∏–ª–∏ RiskManager —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª
        if (slDiffPips > 5 || tpDiffPips > 5 || originalSLBeforeRiskManager != slPrice)
        {
            needModify = true;
        }
    }

    if (!needModify)
    {
        // SL/TP —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ –±–ª–∏–∑–∫–∏ –∫ —Ä–∞—Å—á–µ—Ç–Ω—ã–º
        return true;
    }

    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    g_PMConfig.calculatedTPPrice = tpPrice;
    if (type == POSITION_TYPE_BUY)
        g_PMConfig.tpDistancePips = (tpPrice - price) / SymbolInfoDouble(symbol, SYMBOL_POINT);
    else
        g_PMConfig.tpDistancePips = (price - tpPrice) / SymbolInfoDouble(symbol, SYMBOL_POINT);

    //--- –ü—Ä–∏–º–µ–Ω—è–µ–º SL/TP
    if (g_Trade.PositionModify(ticket, slPrice, tpPrice))
    {
        Print("–ü—Ä–∏–º–µ–Ω–µ–Ω—ã SL/TP –∫ –ø–æ–∑–∏—Ü–∏–∏ #", ticket,
              " –û–±—ä–µ–º: ", volume,
              " SL: ", DoubleToString(slPrice, 5),
              " TP: ", DoubleToString(tpPrice, 5));

        if (AllowSLAdjustmentByRiskManager && originalSLBeforeRiskManager != slPrice)
        {
            Print("SL —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω RiskManager: –±—ã–ª–æ ", DoubleToString(originalSLBeforeRiskManager, 5),
                  ", —Å—Ç–∞–ª–æ ", DoubleToString(slPrice, 5));
        }

        //--- –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        g_PMConfig.currentSL = slPrice;
        g_PMConfig.currentTP = tpPrice;
        g_PMConfig.originalSL = originalSLBeforeRiskManager; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
        g_PMConfig.originalTP = originalTPBeforeRiskManager;
        g_PMConfig.positionActive = true;
        g_PMConfig.positionOpenTime = TimeCurrent();

        return true;
    }
    else
    {
        int errorCode = GetLastError();
        Print("–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SL/TP –∫ –ø–æ–∑–∏—Ü–∏–∏ #", ticket,
              " –ö–æ–¥ –æ—à–∏–±–∫–∏: ", errorCode,
              " –û–ø–∏—Å–∞–Ω–∏–µ: ", TradeErrorDescription(errorCode));
        return false;
    }
}

//+------------------------------------------------------------------+
//| –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å SL —Å —É—á–µ—Ç–æ–º –ª–∏–º–∏—Ç–æ–≤ RiskManager             |
//+------------------------------------------------------------------+
void ValidateSLWithRiskManagerLimits(ulong ticket)
{
    if (!PositionSelectByTicket(ticket))
        return;

    string symbol = PositionGetString(POSITION_SYMBOL);
    ENUM_POSITION_TYPE type = (ENUM_POSITION_TYPE)PositionGetInteger(POSITION_TYPE);
    double price = PositionGetDouble(POSITION_PRICE_OPEN);
    double volume = PositionGetDouble(POSITION_VOLUME);
    double currentSL = PositionGetDouble(POSITION_SL);
    double currentTP = PositionGetDouble(POSITION_TP);

    if (currentSL == 0)
        return; // –ù–µ—Ç SL - –Ω–µ—á–µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∏—Å–∫
    double currentRisk = CalculateLossAtSL(symbol, type, price, currentSL, volume);

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ä–∏—Å–∫
    double maxAllowedRisk = RiskManager_CalculateMaxAllowedRisk(symbol, type, price, volume);

    if (currentRisk > maxAllowedRisk * 1.1) // +10% –¥–æ–ø—É—Å–∫
    {
        Print("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ç–µ–∫—É—â–∏–π —Ä–∏—Å–∫ $", currentRisk,
              " –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º—ã–π $", maxAllowedRisk);

        // –ü—ã—Ç–∞–µ–º—Å—è —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        double newSL = currentSL;
        double newTP = currentTP;

        if (RiskManager_AdjustSLForLimits(symbol, type, price, volume, newSL, newTP))
        {
            if (g_Trade.PositionModify(ticket, newSL, newTP))
            {
                Print("SL —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω RiskManager: ", currentSL, " -> ", newSL);
            }
        }
        else
        {
            Print("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å SL. –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é.");
            g_Trade.PositionClose(ticket);
        }
    }
}

//+------------------------------------------------------------------+
//| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤                                     |
//+------------------------------------------------------------------+
void ProcessPendingOrders()
{
    int ordersTotal = OrdersTotal();

    for (int i = ordersTotal - 1; i >= 0; i--)
    {
        ulong ticket = OrderGetTicket(i);
        if (ticket > 0)
        {
            if (OrderSelect(ticket))
            {
                string orderSymbol = OrderGetString(ORDER_SYMBOL);
                ENUM_ORDER_TYPE orderType = (ENUM_ORDER_TYPE)OrderGetInteger(ORDER_TYPE);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–∞—à —Å–∏–º–≤–æ–ª –∏ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –æ—Ä–¥–µ—Ä
                if ((orderSymbol == g_CurrentSymbol || !TradeCurrentSymbolOnly) &&
                    (orderType == ORDER_TYPE_BUY_LIMIT || orderType == ORDER_TYPE_SELL_LIMIT ||
                     orderType == ORDER_TYPE_BUY_STOP || orderType == ORDER_TYPE_SELL_STOP))
                {
                    //--- –í–°–ï–ì–î–ê –ø—Ä–∏–º–µ–Ω—è–µ–º SL/TP –∫ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º –æ—Ä–¥–µ—Ä–∞–º!
                    PM_ApplySLTPToPendingOrderWithRiskManagerCheck(ticket);
                }
            }
        }
    }
}

//+------------------------------------------------------------------+
//| –ü—Ä–∏–º–µ–Ω–∏—Ç—å SL/TP –∫ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–º—É –æ—Ä–¥–µ—Ä—É —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π RiskManager       |
//+------------------------------------------------------------------+
bool PM_ApplySLTPToPendingOrderWithRiskManagerCheck(ulong orderTicket)
{
    if (!g_OrderInfo.Select(orderTicket))
    {
        Print("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –æ—Ä–¥–µ—Ä #", orderTicket);
        return false;
    }

    ENUM_ORDER_TYPE orderType = (ENUM_ORDER_TYPE)g_OrderInfo.OrderType();

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ä–¥–µ—Ä –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º
    if (orderType != ORDER_TYPE_BUY_LIMIT &&
        orderType != ORDER_TYPE_SELL_LIMIT &&
        orderType != ORDER_TYPE_BUY_STOP &&
        orderType != ORDER_TYPE_SELL_STOP)
    {
        return false; // –ù–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –æ—Ä–¥–µ—Ä
    }

    string symbol = g_OrderInfo.Symbol();
    double orderPrice = g_OrderInfo.PriceOpen();
    double volume = g_OrderInfo.VolumeInitial();

    //--- –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    SInstrumentConfig config;
    if (!PM_GetInstrumentConfig(symbol, config))
    {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        InitializeInstrumentConfig(symbol); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        config = g_Config;
    }

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º SL/TP
    double slPrice = 0;
    double tpPrice = 0;

    //--- –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
    bool isBuyOrder = (orderType == ORDER_TYPE_BUY_LIMIT || orderType == ORDER_TYPE_BUY_STOP);
    ENUM_POSITION_TYPE positionType = isBuyOrder ? POSITION_TYPE_BUY : POSITION_TYPE_SELL;

    //--- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º SL/TP –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º PM
    if (!CalculateSLTPForPosition(symbol, positionType, orderPrice, volume, config, slPrice, tpPrice))
    {
        Print("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ SL/TP –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ #", orderTicket);
        return false;
    }

    //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
    double originalSLBeforeRiskManager = slPrice;
    double originalTPBeforeRiskManager = tpPrice;

    //--- –ö–û–†–†–ï–ö–¢–ò–†–£–ï–ú SL –ü–û–î –õ–ò–ú–ò–¢–´ RiskManager (–í–°–ï–ì–î–ê!)
    if (!RiskManager_AdjustSLForLimits(symbol, positionType, orderPrice, volume, slPrice, tpPrice))
    {
        Print("RiskManager –∑–∞–ø—Ä–µ—Ç–∏–ª –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –æ—Ä–¥–µ—Ä. –£–¥–∞–ª—è–µ–º #", orderTicket);
        g_Trade.OrderDelete(orderTicket);
        return false;
    }

    //--- –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ü–µ–Ω—ã
    slPrice = NormalizePrice(symbol, slPrice);
    tpPrice = NormalizePrice(symbol, tpPrice);

    //--- –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è SL/TP –æ—Ä–¥–µ—Ä–∞
    double currentSL = g_OrderInfo.StopLoss();
    double currentTP = g_OrderInfo.TakeProfit();

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞
    double minStopDistance = SymbolInfoInteger(symbol, SYMBOL_TRADE_STOPS_LEVEL) * SymbolInfoDouble(symbol, SYMBOL_POINT);
    double currentStopDistance = MathAbs(orderPrice - slPrice);

    if (currentStopDistance < minStopDistance)
    {
        Print("–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ SL —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ (", DoubleToString(currentStopDistance, 5),
              "), —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º ", DoubleToString(minStopDistance, 5));

        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º SL
        if (isBuyOrder)
        {
            slPrice = orderPrice - minStopDistance * 1.5;
        }
        else
        {
            slPrice = orderPrice + minStopDistance * 1.5;
        }
        slPrice = NormalizePrice(symbol, slPrice);
    }

    //--- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ—Ä–¥–µ—Ä
    bool needModify = false;

    if (currentSL == 0 && currentTP == 0)
    {
        needModify = true; // SL/TP –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
    }
    else
    {
        double slDiffPips = MathAbs(currentSL - slPrice) / SymbolInfoDouble(symbol, SYMBOL_POINT);
        double tpDiffPips = MathAbs(currentTP - tpPrice) / SymbolInfoDouble(symbol, SYMBOL_POINT);

        // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –±–æ–ª—å—à–µ 5 –ø—É–Ω–∫—Ç–æ–≤ –∏–ª–∏ RiskManager —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª
        if (slDiffPips > 5 || tpDiffPips > 5 || originalSLBeforeRiskManager != slPrice)
        {
            needModify = true;
        }
    }

    if (!needModify)
    {
        // SL/TP —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
        return true;
    }

    //--- –ü—Ä–∏–º–µ–Ω—è–µ–º SL/TP –∫ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–º—É –æ—Ä–¥–µ—Ä—É
    MqlTradeRequest request = {};
    MqlTradeResult result = {};

    request.action = TRADE_ACTION_MODIFY;
    request.order = orderTicket;
    request.symbol = symbol;
    request.volume = volume;
    request.price = orderPrice;
    request.sl = slPrice;
    request.tp = tpPrice;
    request.magic = MAGIC_POSITION_MANAGER;
    request.comment = "SL/TP by PositionManager (RiskManager adjusted)";

    //--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    if (OrderSend(request, result))
    {
        Print("–ü—Ä–∏–º–µ–Ω–µ–Ω—ã SL/TP –∫ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–º—É –æ—Ä–¥–µ—Ä—É #", orderTicket,
              " –¢–∏–ø: ", EnumToString(orderType),
              " –¶–µ–Ω–∞: ", DoubleToString(orderPrice, 5),
              " SL: ", DoubleToString(slPrice, 5),
              " TP: ", DoubleToString(tpPrice, 5));

        if (AllowSLAdjustmentByRiskManager && originalSLBeforeRiskManager != slPrice)
        {
            Print("SL —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω RiskManager: –±—ã–ª–æ ", DoubleToString(originalSLBeforeRiskManager, 5),
                  ", —Å—Ç–∞–ª–æ ", DoubleToString(slPrice, 5));
        }

        //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        if (isBuyOrder)
        {
            config.calculatedTPPrice = tpPrice;
            config.tpDistancePips = (tpPrice - orderPrice) / SymbolInfoDouble(symbol, SYMBOL_POINT);
        }
        else
        {
            config.calculatedTPPrice = tpPrice;
            config.tpDistancePips = (orderPrice - tpPrice) / SymbolInfoDouble(symbol, SYMBOL_POINT);
        }

        //--- –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        config.originalSL = originalSLBeforeRiskManager;
        config.originalTP = originalTPBeforeRiskManager;

        //--- –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        PM_SaveInstrumentConfig(symbol, config);

        return true;
    }
    else
    {
        Print("–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SL/TP –∫ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–º—É –æ—Ä–¥–µ—Ä—É #", orderTicket,
              " –ö–æ–¥: ", result.retcode,
              " –û–ø–∏—Å–∞–Ω–∏–µ: ", TradeErrorDescription(result.retcode));
        return false;
    }
}

//+------------------------------------------------------------------+
//| –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏                     |
//+------------------------------------------------------------------+
void CheckAutoCloseByTime(string symbol, ulong ticket)
{
    if (!PositionSelectByTicket(ticket))
        return;

    datetime openTime = (datetime)PositionGetInteger(POSITION_TIME);
    long secondsOpen = TimeCurrent() - openTime;

    //--- –ü—Ä–∏–º–µ—Ä: –∑–∞–∫—Ä—ã–≤–∞—Ç—å —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
    if (secondsOpen >= 86400) // 24 —á–∞—Å–∞
    {
        Print("–ü–æ–∑–∏—Ü–∏—è #", ticket, " –æ—Ç–∫—Ä—ã—Ç–∞ –±–æ–ª–µ–µ 24 —á–∞—Å–æ–≤, –∑–∞–∫—Ä—ã–≤–∞–µ–º...");

        if (g_Trade.PositionClose(ticket))
        {
            Print("–ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏");
        }
    }
}

//+------------------------------------------------------------------+
//| –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞ –ø–æ —Å–∏–º–≤–æ–ª—É                         |
//+------------------------------------------------------------------+
void DeleteAllPendingOrders(string symbol, string reason)
{
    int deletedCount = 0;

    for (int i = OrdersTotal() - 1; i >= 0; i--)
    {
        ulong ticket = OrderGetTicket(i);
        if (ticket > 0 && OrderSelect(ticket))
        {
            string orderSymbol = OrderGetString(ORDER_SYMBOL);
            ENUM_ORDER_TYPE orderType = (ENUM_ORDER_TYPE)OrderGetInteger(ORDER_TYPE);

            if (orderSymbol == symbol &&
                (orderType == ORDER_TYPE_BUY_LIMIT || orderType == ORDER_TYPE_SELL_LIMIT ||
                 orderType == ORDER_TYPE_BUY_STOP || orderType == ORDER_TYPE_SELL_STOP))
            {
                Print("–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ #", ticket, " –ø–æ –ø—Ä–∏—á–∏–Ω–µ: ", reason);

                if (g_Trade.OrderDelete(ticket))
                {
                    deletedCount++;
                }
            }
        }
    }

    if (deletedCount > 0)
    {
        Print("–£–¥–∞–ª–µ–Ω–æ ", deletedCount, " –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É ", symbol);
    }
}

//+------------------------------------------------------------------+
//| –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π                                     |
//+------------------------------------------------------------------+
void CreateRecommendationPanel()
{
    //--- –§–æ–Ω –ø–∞–Ω–µ–ª–∏
    ObjectCreate(0, "PM_Panel_BG", OBJ_RECTANGLE_LABEL, 0, 0, 0);
    ObjectSetInteger(0, "PM_Panel_BG", OBJPROP_XDISTANCE, g_PanelX);
    ObjectSetInteger(0, "PM_Panel_BG", OBJPROP_YDISTANCE, g_PanelY);
    ObjectSetInteger(0, "PM_Panel_BG", OBJPROP_XSIZE, 250);
    ObjectSetInteger(0, "PM_Panel_BG", OBJPROP_YSIZE, 150);
    ObjectSetInteger(0, "PM_Panel_BG", OBJPROP_BGCOLOR, g_PanelBgColor);
    ObjectSetInteger(0, "PM_Panel_BG", OBJPROP_BORDER_TYPE, BORDER_FLAT);
    ObjectSetInteger(0, "PM_Panel_BG", OBJPROP_BORDER_COLOR, clrGray);

    //--- –ó–∞–≥–æ–ª–æ–≤–æ–∫
    ObjectCreate(0, "PM_Panel_Title", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "PM_Panel_Title", OBJPROP_TEXT, "SIDEZ Position Manager");
    ObjectSetInteger(0, "PM_Panel_Title", OBJPROP_XDISTANCE, g_PanelX + 10);
    ObjectSetInteger(0, "PM_Panel_Title", OBJPROP_YDISTANCE, g_PanelY + 10);
    ObjectSetInteger(0, "PM_Panel_Title", OBJPROP_COLOR, clrYellow);
    ObjectSetInteger(0, "PM_Panel_Title", OBJPROP_FONTSIZE, 10);

    //--- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è
    ObjectCreate(0, "PM_Panel_Rec", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "PM_Panel_Rec", OBJPROP_TEXT, "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ---");
    ObjectSetInteger(0, "PM_Panel_Rec", OBJPROP_XDISTANCE, g_PanelX + 10);
    ObjectSetInteger(0, "PM_Panel_Rec", OBJPROP_YDISTANCE, g_PanelY + 35);
    ObjectSetInteger(0, "PM_Panel_Rec", OBJPROP_COLOR, g_PanelTextColor);

    //--- –ü—Ä–∏—á–∏–Ω–∞
    ObjectCreate(0, "PM_Panel_Reason", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "PM_Panel_Reason", OBJPROP_TEXT, "–ü—Ä–∏—á–∏–Ω–∞: ---");
    ObjectSetInteger(0, "PM_Panel_Reason", OBJPROP_XDISTANCE, g_PanelX + 10);
    ObjectSetInteger(0, "PM_Panel_Reason", OBJPROP_YDISTANCE, g_PanelY + 55);
    ObjectSetInteger(0, "PM_Panel_Reason", OBJPROP_COLOR, g_PanelTextColor);

    //--- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
    ObjectCreate(0, "PM_Panel_Symbol", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "PM_Panel_Symbol", OBJPROP_TEXT, "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: " + g_CurrentSymbol);
    ObjectSetInteger(0, "PM_Panel_Symbol", OBJPROP_XDISTANCE, g_PanelX + 10);
    ObjectSetInteger(0, "PM_Panel_Symbol", OBJPROP_YDISTANCE, g_PanelY + 75);
    ObjectSetInteger(0, "PM_Panel_Symbol", OBJPROP_COLOR, g_PanelTextColor);

    //--- –°—Ç–∞—Ç—É—Å —Ç–æ—Ä–≥–æ–≤–ª–∏
    ObjectCreate(0, "PM_Panel_TradeStatus", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "PM_Panel_TradeStatus", OBJPROP_TEXT, "–¢–æ—Ä–≥–æ–≤–ª—è: ---");
    ObjectSetInteger(0, "PM_Panel_TradeStatus", OBJPROP_XDISTANCE, g_PanelX + 10);
    ObjectSetInteger(0, "PM_Panel_TradeStatus", OBJPROP_YDISTANCE, g_PanelY + 95);
    ObjectSetInteger(0, "PM_Panel_TradeStatus", OBJPROP_COLOR, g_PanelTextColor);

    //--- –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    ObjectCreate(0, "PM_Panel_Time", OBJ_LABEL, 0, 0, 0);
    ObjectSetString(0, "PM_Panel_Time", OBJPROP_TEXT, "–û–±–Ω–æ–≤–ª–µ–Ω–æ: ---");
    ObjectSetInteger(0, "PM_Panel_Time", OBJPROP_XDISTANCE, g_PanelX + 10);
    ObjectSetInteger(0, "PM_Panel_Time", OBJPROP_YDISTANCE, g_PanelY + 115);
    ObjectSetInteger(0, "PM_Panel_Time", OBJPROP_COLOR, clrSilver);
    ObjectSetInteger(0, "PM_Panel_Time", OBJPROP_FONTSIZE, 8);
}

//+------------------------------------------------------------------+
//| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π                                   |
//+------------------------------------------------------------------+
void UpdateRecommendationPanel()
{
    if (!ShowRecommendationPanel)
        return;

    //--- –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
    string recText = "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: ";
    color recColor = g_PanelTextColor;

    switch (g_LastRecommendation)
    {
    case 1:
        recText += "–¢–û–†–ì–û–í–ê–¢–¨ LONG";
        recColor = clrLime;
        break;
    case 2:
        recText += "–¢–û–†–ì–û–í–ê–¢–¨ SHORT";
        recColor = clrRed;
        break;
    default:
        recText += "–ù–ï –¢–û–†–ì–û–í–ê–¢–¨";
        recColor = clrOrange;
        break;
    }

    ObjectSetString(0, "PM_Panel_Rec", OBJPROP_TEXT, recText);
    ObjectSetInteger(0, "PM_Panel_Rec", OBJPROP_COLOR, recColor);

    //--- –ü—Ä–∏—á–∏–Ω–∞
    string reasonText = "–ü—Ä–∏—á–∏–Ω–∞: ";
    // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ SGlobalState –≤ CoreLib.mqh
    /*
    if(g_TempRecommendationCount > 0)
    {
       int lastIdx = g_TempRecommendationCount - 1;
       reasonText += g_TempRecommendations[lastIdx].reason;
    }
    else
    {
       reasonText += "–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞...";
    }
    */
    reasonText += "–¢—Ä–µ–Ω–¥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–µ–Ω";

    ObjectSetString(0, "PM_Panel_Reason", OBJPROP_TEXT, reasonText);

    //--- –°—Ç–∞—Ç—É—Å —Ç–æ—Ä–≥–æ–≤–ª–∏ –æ—Ç RiskManager
    string tradeStatus = "–¢–æ—Ä–≥–æ–≤–ª—è: ";
    if (RiskManager_IsTradeAllowed(g_CurrentSymbol))
        tradeStatus += "–†–ê–ó–†–ï–®–ï–ù–ê";
    else
        tradeStatus += "–ó–ê–ü–†–ï–©–ï–ù–ê";

    ObjectSetString(0, "PM_Panel_TradeStatus", OBJPROP_TEXT, tradeStatus);

    //--- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —Å—Ç–∞—Ç—É—Å –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ SL
    string statusText = "";
    if (AllowSLAdjustmentByRiskManager)
    {
        statusText = "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è SL: –í–ö–õ | ";
    }
    else
    {
        statusText = "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è SL: –í–´–ö–õ | ";
    }

    //--- –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏—è—Ö
    int posCount = GetPositionsCount(g_CurrentSymbol);
    statusText += "–ü–æ–∑–∏—Ü–∏–π: " + IntegerToString(posCount) + " | ";
    statusText += TimeToString(TimeCurrent(), TIME_SECONDS);

    ObjectSetString(0, "PM_Panel_Time", OBJPROP_TEXT, statusText);
}

//+------------------------------------------------------------------+
//| Expert deinitialization function                                 |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
{
    Print("RiskManager –¥–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è. –ü—Ä–∏—á–∏–Ω–∞: ", reason);

    // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ - –û–°–¢–ê–í–õ–Ø–ï–ú –ï–Å!
    if (g_GlobalState.dailyTPReached || g_GlobalState.dailySLReached ||
        g_GlobalState.weeklyTPReached || g_GlobalState.weeklySLReached)
    {
        Print("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ...");
        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ GlobalVariable –∏ —Ñ–∞–π–ª
        // –û–Ω–∞ –ø–µ—Ä–µ–∂–∏–≤–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
    }

    //--- –£–¥–∞–ª—è–µ–º –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã
    if (ShowRecommendationPanel)
    {
        ObjectDelete(0, "PM_Panel_BG");
        ObjectDelete(0, "PM_Panel_Title");
        ObjectDelete(0, "PM_Panel_Rec");
        ObjectDelete(0, "PM_Panel_Reason");
        ObjectDelete(0, "PM_Panel_Symbol");
        ObjectDelete(0, "PM_Panel_TradeStatus");
        ObjectDelete(0, "PM_Panel_Time");
    }

    Comment("");
}

//+------------------------------------------------------------------+
//| –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π                                               |
//+------------------------------------------------------------------+
void OnChartEvent(const int id, const long &lparam, const double &dparam, const string &sparam)
{
    //--- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –ø–∞–Ω–µ–ª–∏
    if (id == CHARTEVENT_OBJECT_CLICK && sparam != "")
    {
        Print("–ö–ª–∏–∫ –ø–æ –æ–±—ä–µ–∫—Ç—É: ", sparam);

        //--- –ü—Ä–∏–º–µ—Ä: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
        if (sparam == "PM_Panel_TradeStatus")
        {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä—É—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏
        }
    }
}

//+------------------------------------------------------------------+
//| –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –æ—Ä–¥–µ—Ä–∞–º–∏ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ)      |
//+------------------------------------------------------------------+

//--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞
void CheckAndRemoveExpiredPendingOrders(string symbol, int maxHours = 24)
{
    datetime currentTime = TimeCurrent();

    for (int i = OrdersTotal() - 1; i >= 0; i--)
    {
        ulong ticket = OrderGetTicket(i);
        if (ticket > 0 && OrderSelect(ticket))
        {
            string orderSymbol = OrderGetString(ORDER_SYMBOL);
            ENUM_ORDER_TYPE orderType = (ENUM_ORDER_TYPE)OrderGetInteger(ORDER_TYPE);
            datetime orderTime = (datetime)OrderGetInteger(ORDER_TIME_SETUP);

            if (orderSymbol == symbol &&
                (orderType == ORDER_TYPE_BUY_LIMIT || orderType == ORDER_TYPE_SELL_LIMIT ||
                 orderType == ORDER_TYPE_BUY_STOP || orderType == ORDER_TYPE_SELL_STOP))
            {
                long secondsOpen = currentTime - orderTime;

                if (secondsOpen >= maxHours * 3600) // –ë–æ–ª–µ–µ maxHours —á–∞—Å–æ–≤
                {
                    Print("–£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ #", ticket,
                          " (–æ—Ç–∫—Ä—ã—Ç ", (secondsOpen / 3600), " —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥)");

                    g_Trade.OrderDelete(ticket);
                }
            }
        }
    }
}

//--- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å SL/TP
void CheckPendingOrderExecution()
{
    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ OnTrade
    // –ù–æ –≤ OnTick –º—ã —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –æ—Ä–¥–µ—Ä–∞ —á–µ—Ä–µ–∑ ProcessPendingOrders()
}

//+------------------------------------------------------------------+